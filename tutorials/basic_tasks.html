<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.6.39">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Basic Examples – Spannerlib</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script><script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<script src="../site_libs/quarto-html/quarto.js"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting-e26003cea8cd680ca0c55a263523d882.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap-b6f35d3e5f7cf9e5d8c19bd4060a2618.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" integrity="sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==" crossorigin="anonymous"></script>

<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>


<link rel="stylesheet" href="../styles.css">
<meta property="og:title" content="Basic Examples – Spannerlib">
<meta property="og:description" content="work bench">
<meta property="og:site_name" content="Spannerlib">
<meta name="twitter:title" content="Basic Examples – Spannerlib">
<meta name="twitter:description" content="work bench">
<meta name="twitter:card" content="summary">
</head>

<body class="nav-sidebar docked nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="../index.html">
    <span class="navbar-title">Spannerlib</span>
    </a>
  </div>
        <div class="quarto-navbar-tools tools-end">
</div>
          <div id="quarto-search" class="" title="Search"></div>
      </div> <!-- /container-fluid -->
    </nav>
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../tutorials/introduction.html">Tutorials</a></li><li class="breadcrumb-item"><a href="../tutorials/basic_tasks.html">Basic Examples</a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="Search" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation docked overflow-auto">
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Welcome to Spannerlib</span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true">
 <span class="menu-text">Tutorials</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../tutorials/introduction.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Intro</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../tutorials/basic_tasks.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text">Basic Examples</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../tutorials/llm_code_documentation_example.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Copilot Agent</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../tutorials/extending_code.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Extending Code</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../tutorials/rewriting_a_real_codebase.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Rewriting a real codebase</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="true">
 <span class="menu-text">Callbacks</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../callbacks/basic_ies.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Basic Callbacks</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../callbacks/json_path.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">JsonPath</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../session.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">The Session Object</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../reference.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Reference</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../inspecting_query_plans.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">View Query Plan</span></a>
  </div>
</li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#finding-identical-sentences-in-a-corpus-of-documents" id="toc-finding-identical-sentences-in-a-corpus-of-documents" class="nav-link active" data-scroll-target="#finding-identical-sentences-in-a-corpus-of-documents">Finding identical sentences in a corpus of documents</a>
  <ul class="collapse">
  <li><a href="#tldr" id="toc-tldr" class="nav-link" data-scroll-target="#tldr">TLDR</a></li>
  <li><a href="#walkthrough" id="toc-walkthrough" class="nav-link" data-scroll-target="#walkthrough">Walkthrough</a></li>
  <li><a href="#building-ie-functions" id="toc-building-ie-functions" class="nav-link" data-scroll-target="#building-ie-functions">Building IE functions</a></li>
  <li><a href="#split" id="toc-split" class="nav-link" data-scroll-target="#split">split</a></li>
  <li><a href="#eq_content_spans" id="toc-eq_content_spans" class="nav-link" data-scroll-target="#eq_content_spans">eq_content_spans</a></li>
  <li><a href="#building-spannerlog-rules" id="toc-building-spannerlog-rules" class="nav-link" data-scroll-target="#building-spannerlog-rules">Building spannerlog rules</a></li>
  <li><a href="#oops-handling-symmetric-queries" id="toc-oops-handling-symmetric-queries" class="nav-link" data-scroll-target="#oops-handling-symmetric-queries">Oops, handling symmetric queries</a></li>
  <li><a href="#span_lt" id="toc-span_lt" class="nav-link" data-scroll-target="#span_lt">span_lt</a></li>
  </ul></li>
  <li><a href="#building-llm-agents-using-spannerlib" id="toc-building-llm-agents-using-spannerlib" class="nav-link" data-scroll-target="#building-llm-agents-using-spannerlib">Building LLM agents using spannerlib</a>
  <ul class="collapse">
  <li><a href="#motivation" id="toc-motivation" class="nav-link" data-scroll-target="#motivation">Motivation</a></li>
  <li><a href="#problem-definition" id="toc-problem-definition" class="nav-link" data-scroll-target="#problem-definition">Problem definition</a></li>
  <li><a href="#defining-our-ie-functions" id="toc-defining-our-ie-functions" class="nav-link" data-scroll-target="#defining-our-ie-functions">Defining our IE functions</a></li>
  <li><a href="#tldr-1" id="toc-tldr-1" class="nav-link" data-scroll-target="#tldr-1">TLDR</a></li>
  <li><a href="#walkthrough-1" id="toc-walkthrough-1" class="nav-link" data-scroll-target="#walkthrough-1">Walkthrough</a></li>
  <li><a href="#llm" id="toc-llm" class="nav-link" data-scroll-target="#llm">llm</a></li>
  <li><a href="#format_ie" id="toc-format_ie" class="nav-link" data-scroll-target="#format_ie">format_ie</a></li>
  <li><a href="#seeing-our-llm-ie-function-in-action" id="toc-seeing-our-llm-ie-function-in-action" class="nav-link" data-scroll-target="#seeing-our-llm-ie-function-in-action">Seeing our llm IE function in action</a></li>
  <li><a href="#example-data" id="toc-example-data" class="nav-link" data-scroll-target="#example-data">Example data</a></li>
  <li><a href="#buliding-the-agent-logic-in-spannerlog" id="toc-buliding-the-agent-logic-in-spannerlog" class="nav-link" data-scroll-target="#buliding-the-agent-logic-in-spannerlog">Buliding the agent logic in spannerlog</a></li>
  <li><a href="#executing-our-agent-and-returning-the-results-to-python" id="toc-executing-our-agent-and-returning-the-results-to-python" class="nav-link" data-scroll-target="#executing-our-agent-and-returning-the-results-to-python">Executing our agent and returning the results to python</a></li>
  </ul></li>
  </ul>
<div class="toc-actions"><ul><li><a href="https://github.com/DeanLight/spannerlib/issues/new" class="toc-action"><i class="bi bi-github"></i>Report an issue</a></li></ul></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default"><nav class="quarto-page-breadcrumbs quarto-title-breadcrumbs d-none d-lg-block" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../tutorials/introduction.html">Tutorials</a></li><li class="breadcrumb-item"><a href="../tutorials/basic_tasks.html">Basic Examples</a></li></ol></nav>
<div class="quarto-title">
<h1 class="title">Basic Examples</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<!-- WARNING: THIS FILE WAS AUTOGENERATED! DO NOT EDIT! -->
<div id="cell-2" class="cell">
<details open="" class="code-fold">
<summary>Exported source</summary>
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co"># importing dependencies</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> re</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pandas <span class="im">import</span> DataFrame</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pathlib <span class="im">import</span> Path</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> spannerlib.utils <span class="im">import</span> load_env</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> spannerlib <span class="im">import</span> get_magic_session,Session,Span</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div id="cell-3" class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co"># load openAI api key</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>load_env()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>This tutorials aim to show how to use the spannerlib framework for simple use cases. To illustrate the simplicity of using spannerlib, all required IE functions will be implemented from scratch.</p>
<section id="finding-identical-sentences-in-a-corpus-of-documents" class="level2">
<h2 class="anchored" data-anchor-id="finding-identical-sentences-in-a-corpus-of-documents">Finding identical sentences in a corpus of documents</h2>
<section id="tldr" class="level3">
<h3 class="anchored" data-anchor-id="tldr">TLDR</h3>
<div class="sourceCode" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>spannerlog</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="co"># split documents into sentences with the split ie function</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>Sents(doc_id,sent)<span class="op">&lt;-</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>    Docs(doc_id,text),split(text)<span class="op">-&gt;</span>(sent).</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a><span class="co"># get all pairs of equal sentences using the eq_content_spans ie function</span></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a><span class="co"># make sure we only get unique pairs by using the span_lt ie function to avoid symmetry</span></span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>EqualSentsUnique(doc_id1,sent1,doc_id2,sent2)<span class="op">&lt;-</span></span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>    Sents(doc_id1,sent1),</span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a>    Sents(doc_id2,sent2),</span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a>    span_lt(sent1,sent2)<span class="op">-&gt;</span>(<span class="va">True</span>),</span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a>    eq_content_spans(sent1,sent2)<span class="op">-&gt;</span>(<span class="va">True</span>).</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="walkthrough" class="level3">
<h3 class="anchored" data-anchor-id="walkthrough">Walkthrough</h3>
<p>In this example, we would like to get a collection of documents. And find identical sentences among them. For example, given the following documents:</p>
<div id="cell-10" class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>input_documents <span class="op">=</span> pd.DataFrame([</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>    (<span class="st">'doc1'</span>, <span class="st">'The quick brown fox jumps over the lazy dog. Im walking on Sunshine.'</span>),</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>    (<span class="st">'doc2'</span>, <span class="st">'Im walking on Sunshine. Lorem ipsum. Im walking on Sunshine.'</span>),</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>    (<span class="st">'doc3'</span>, <span class="st">'All you need is love. The quick brown fox jumps over the lazy dog.'</span>),</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>])</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>input_documents</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">0</th>
<th data-quarto-table-cell-role="th">1</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>doc1</td>
<td>The quick brown fox jumps over the lazy dog. I...</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>doc2</td>
<td>Im walking on Sunshine. Lorem ipsum. Im walkin...</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>doc3</td>
<td>All you need is love. The quick brown fox jump...</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>We would like to compute that the first sentence of <code>doc1</code> is equal to the second sentence of <code>doc3</code> etc..</p>
</section>
<section id="building-ie-functions" class="level3">
<h3 class="anchored" data-anchor-id="building-ie-functions">Building IE functions</h3>
<p>To do so, we need 2 IE functions: * One that extracts the Span of all sentences from a document, called <a href="https://DeanLight.github.io/spannerlib/tutorials/basic_tasks.html#split"><code>split</code></a> * The other which would let us know when sentences have identical content but are not actually the same sentence. * this will require them to have the same content when ignoring whitespace * but not be equal spans. Lets call this function <a href="https://DeanLight.github.io/spannerlib/tutorials/basic_tasks.html#eq_content_spans"><code>eq_content_spans</code></a></p>
<p>Lets implement them and register them to our session object. We will use the <a href="https://DeanLight.github.io/spannerlib/spans_and_pandas.html#span"><code>Span</code></a> class to save indexed substrings.</p>
<hr>
<p><a href="https://github.com/DeanLight/spannerlib/blob/master/spannerlib/tutorials/basic.py#L18" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="split" class="level3">
<h3 class="anchored" data-anchor-id="split">split</h3>
<blockquote class="blockquote">
<pre><code> split (text)</code></pre>
</blockquote>
<div id="cell-15" class="cell">
<details open="" class="code-fold">
<summary>Exported source</summary>
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co"># this implementation is naive</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="co"># the standard library has a rgx_split ie function that does this in a more efficient way</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> split(text):</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>    split_indices <span class="op">=</span> [ pos <span class="cf">for</span> pos,char <span class="kw">in</span> <span class="bu">enumerate</span>(text) <span class="cf">if</span> char <span class="op">==</span> <span class="st">'.'</span> ]</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>    start <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> pos,char <span class="kw">in</span> <span class="bu">enumerate</span>(text):</span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> char <span class="op">==</span> <span class="st">'.'</span>:</span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>            <span class="cf">yield</span> Span(text, start, pos)</span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>            start <span class="op">=</span> pos<span class="op">+</span><span class="dv">1</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<hr>
<p><a href="https://github.com/DeanLight/spannerlib/blob/master/spannerlib/tutorials/basic.py#L27" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="eq_content_spans" class="level3">
<h3 class="anchored" data-anchor-id="eq_content_spans">eq_content_spans</h3>
<blockquote class="blockquote">
<pre><code> eq_content_spans (span1, span2)</code></pre>
</blockquote>
<div id="cell-17" class="cell">
<details open="" class="code-fold">
<summary>Exported source</summary>
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> eq_content_spans(span1, span2):</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>    <span class="co"># notice that we are yielding a boolean value</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">yield</span> span1 <span class="op">!=</span> span2 <span class="kw">and</span> <span class="bu">str</span>(span1).strip() <span class="op">==</span> <span class="bu">str</span>(span2).strip()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div id="cell-18" class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="bu">list</span>(split(<span class="st">'The quick brown fox jumps over the lazy dog. Im walking on Sunshine.'</span>)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[[@3ba775,0,43) "The quick ...", [@3ba775,44,67) " Im walkin..."]</code></pre>
</div>
</div>
</section>
<section id="building-spannerlog-rules" class="level3">
<h3 class="anchored" data-anchor-id="building-spannerlog-rules">Building spannerlog rules</h3>
<div id="cell-20" class="cell">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="co"># we register the functions and their input and output schema</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>sess <span class="op">=</span> get_magic_session()</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>sess.register(<span class="st">'split'</span>, split, [<span class="bu">str</span>],[Span])</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>sess.register(<span class="st">'eq_content_spans'</span>, eq_content_spans,[Span,Span],[<span class="bu">bool</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now let us import our data</p>
<div id="cell-22" class="cell">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>sess.import_rel(<span class="st">'Docs'</span>, input_documents)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Lets make sure we can see our data in using Spannerlog</p>
<div id="cell-24" class="cell">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>?Docs(doc_id,text)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>'?Docs(doc_id,text)'</code></pre>
</div>
<div class="cell-output cell-output-display">
<style type="text/css">
#T_e2820_row0_col0, #T_e2820_row0_col1, #T_e2820_row1_col0, #T_e2820_row1_col1, #T_e2820_row2_col0, #T_e2820_row2_col1 {
  overflow-wrap: break-word;
  max-width: 800px;
  text-align: left;
}
</style>

<table id="T_e2820" class="display nowrap caption-top table table-sm table-striped small" data-quarto-postprocess="true">
<thead>
<tr class="header">
<th id="T_e2820_level0_col0" class="col_heading level0 col0" data-quarto-table-cell-role="th">doc_id</th>
<th id="T_e2820_level0_col1" class="col_heading level0 col1" data-quarto-table-cell-role="th">text</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td id="T_e2820_row0_col0" class="data row0 col0">doc1</td>
<td id="T_e2820_row0_col1" class="data row0 col1">The quick brown fox jumps over the lazy dog. Im walking on Sunshine.</td>
</tr>
<tr class="even">
<td id="T_e2820_row1_col0" class="data row1 col0">doc2</td>
<td id="T_e2820_row1_col1" class="data row1 col1">Im walking on Sunshine. Lorem ipsum. Im walking on Sunshine.</td>
</tr>
<tr class="odd">
<td id="T_e2820_row2_col0" class="data row2 col0">doc3</td>
<td id="T_e2820_row2_col1" class="data row2 col1">All you need is love. The quick brown fox jumps over the lazy dog.</td>
</tr>
</tbody>
</table>


<script type="module">
    const { DataTable, jQuery: $ } = await import(window._datatables_src_for_itables_2_1_4);

    document.querySelectorAll("#T_e2820:not(.dataTable)").forEach(table => {
        // Define the table data
        

        // Define the dt_args
        let dt_args = {"columnDefs": [{"targets": ["doc_id", "text"], "render": function(data, type, row) {
                    return '<div style="white-space: normal; word-wrap: break-word;">' + data + '</div>';
                }, "width": "300px"}], "escape": true, "layout": {"topStart": null, "topEnd": null, "bottomStart": null, "bottomEnd": null}, "display_logo_when_loading": true, "order": []};
        

        
        new DataTable(table, dt_args);
    });
</script>
</div>
</div>
<p>Now let us build rules that allow us to find identical sentences:</p>
<div id="cell-26" class="cell">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="co"># this rule gives us</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>Sents(doc_id,sent)<span class="op">&lt;-</span></span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>    Docs(doc_id,text),split(text)<span class="op">-&gt;</span>(sent).</span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>?Sents(doc_id,sent)</span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a><span class="co"># this rule find equal pairs of sentences</span></span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a>EqualSents(doc_id1,sent1,doc_id2,sent2)<span class="op">&lt;-</span></span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a>    Sents(doc_id1,sent1),</span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a>    Sents(doc_id2,sent2),</span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a>    eq_content_spans(sent1,sent2)<span class="op">-&gt;</span>(<span class="va">True</span>).</span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true" tabindex="-1"></a>?EqualSents(doc_id1,sent1,doc_id2,sent2)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>'?Sents(doc_id,sent)'</code></pre>
</div>
<div class="cell-output cell-output-display">
<style type="text/css">
#T_2fe1f_row0_col0, #T_2fe1f_row0_col1, #T_2fe1f_row1_col0, #T_2fe1f_row1_col1, #T_2fe1f_row2_col0, #T_2fe1f_row2_col1, #T_2fe1f_row3_col0, #T_2fe1f_row3_col1, #T_2fe1f_row4_col0, #T_2fe1f_row4_col1, #T_2fe1f_row5_col0, #T_2fe1f_row5_col1, #T_2fe1f_row6_col0, #T_2fe1f_row6_col1 {
  overflow-wrap: break-word;
  max-width: 800px;
  text-align: left;
}
</style>

<table id="T_2fe1f" class="display nowrap caption-top table table-sm table-striped small" data-quarto-postprocess="true">
<thead>
<tr class="header">
<th id="T_2fe1f_level0_col0" class="col_heading level0 col0" data-quarto-table-cell-role="th">doc_id</th>
<th id="T_2fe1f_level0_col1" class="col_heading level0 col1" data-quarto-table-cell-role="th">sent</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td id="T_2fe1f_row0_col0" class="data row0 col0">doc1</td>
<td id="T_2fe1f_row0_col1" class="data row0 col1">[@3ba775,0,43) "The quick ..."</td>
</tr>
<tr class="even">
<td id="T_2fe1f_row1_col0" class="data row1 col0">doc1</td>
<td id="T_2fe1f_row1_col1" class="data row1 col1">[@3ba775,44,67) " Im walkin..."</td>
</tr>
<tr class="odd">
<td id="T_2fe1f_row2_col0" class="data row2 col0">doc2</td>
<td id="T_2fe1f_row2_col1" class="data row2 col1">[@06bc2d,0,22) "Im walking..."</td>
</tr>
<tr class="even">
<td id="T_2fe1f_row3_col0" class="data row3 col0">doc2</td>
<td id="T_2fe1f_row3_col1" class="data row3 col1">[@06bc2d,23,35) " Lorem ips..."</td>
</tr>
<tr class="odd">
<td id="T_2fe1f_row4_col0" class="data row4 col0">doc2</td>
<td id="T_2fe1f_row4_col1" class="data row4 col1">[@06bc2d,36,59) " Im walkin..."</td>
</tr>
<tr class="even">
<td id="T_2fe1f_row5_col0" class="data row5 col0">doc3</td>
<td id="T_2fe1f_row5_col1" class="data row5 col1">[@9c32df,0,20) "All you ne..."</td>
</tr>
<tr class="odd">
<td id="T_2fe1f_row6_col0" class="data row6 col0">doc3</td>
<td id="T_2fe1f_row6_col1" class="data row6 col1">[@9c32df,21,65) " The quick..."</td>
</tr>
</tbody>
</table>


<script type="module">
    const { DataTable, jQuery: $ } = await import(window._datatables_src_for_itables_2_1_4);

    document.querySelectorAll("#T_2fe1f:not(.dataTable)").forEach(table => {
        // Define the table data
        

        // Define the dt_args
        let dt_args = {"columnDefs": [{"targets": ["doc_id", "sent"], "render": function(data, type, row) {
                    return '<div style="white-space: normal; word-wrap: break-word;">' + data + '</div>';
                }, "width": "300px"}], "escape": true, "layout": {"topStart": null, "topEnd": null, "bottomStart": null, "bottomEnd": null}, "display_logo_when_loading": true, "order": []};
        

        
        new DataTable(table, dt_args);
    });
</script>
</div>
<div class="cell-output cell-output-display">
<pre><code>'?EqualSents(doc_id1,sent1,doc_id2,sent2)'</code></pre>
</div>
<div class="cell-output cell-output-display">
<style type="text/css">
#T_f6868_row0_col0, #T_f6868_row0_col1, #T_f6868_row0_col2, #T_f6868_row0_col3, #T_f6868_row1_col0, #T_f6868_row1_col1, #T_f6868_row1_col2, #T_f6868_row1_col3, #T_f6868_row2_col0, #T_f6868_row2_col1, #T_f6868_row2_col2, #T_f6868_row2_col3, #T_f6868_row3_col0, #T_f6868_row3_col1, #T_f6868_row3_col2, #T_f6868_row3_col3, #T_f6868_row4_col0, #T_f6868_row4_col1, #T_f6868_row4_col2, #T_f6868_row4_col3, #T_f6868_row5_col0, #T_f6868_row5_col1, #T_f6868_row5_col2, #T_f6868_row5_col3, #T_f6868_row6_col0, #T_f6868_row6_col1, #T_f6868_row6_col2, #T_f6868_row6_col3, #T_f6868_row7_col0, #T_f6868_row7_col1, #T_f6868_row7_col2, #T_f6868_row7_col3 {
  overflow-wrap: break-word;
  max-width: 800px;
  text-align: left;
}
</style>

<table id="T_f6868" class="display nowrap caption-top table table-sm table-striped small" data-quarto-postprocess="true">
<thead>
<tr class="header">
<th id="T_f6868_level0_col0" class="col_heading level0 col0" data-quarto-table-cell-role="th">doc_id1</th>
<th id="T_f6868_level0_col1" class="col_heading level0 col1" data-quarto-table-cell-role="th">sent1</th>
<th id="T_f6868_level0_col2" class="col_heading level0 col2" data-quarto-table-cell-role="th">doc_id2</th>
<th id="T_f6868_level0_col3" class="col_heading level0 col3" data-quarto-table-cell-role="th">sent2</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td id="T_f6868_row0_col0" class="data row0 col0">doc1</td>
<td id="T_f6868_row0_col1" class="data row0 col1">[@3ba775,0,43) "The quick ..."</td>
<td id="T_f6868_row0_col2" class="data row0 col2">doc3</td>
<td id="T_f6868_row0_col3" class="data row0 col3">[@9c32df,21,65) " The quick..."</td>
</tr>
<tr class="even">
<td id="T_f6868_row1_col0" class="data row1 col0">doc1</td>
<td id="T_f6868_row1_col1" class="data row1 col1">[@3ba775,44,67) " Im walkin..."</td>
<td id="T_f6868_row1_col2" class="data row1 col2">doc2</td>
<td id="T_f6868_row1_col3" class="data row1 col3">[@06bc2d,0,22) "Im walking..."</td>
</tr>
<tr class="odd">
<td id="T_f6868_row2_col0" class="data row2 col0">doc1</td>
<td id="T_f6868_row2_col1" class="data row2 col1">[@3ba775,44,67) " Im walkin..."</td>
<td id="T_f6868_row2_col2" class="data row2 col2">doc2</td>
<td id="T_f6868_row2_col3" class="data row2 col3">[@06bc2d,36,59) " Im walkin..."</td>
</tr>
<tr class="even">
<td id="T_f6868_row3_col0" class="data row3 col0">doc2</td>
<td id="T_f6868_row3_col1" class="data row3 col1">[@06bc2d,0,22) "Im walking..."</td>
<td id="T_f6868_row3_col2" class="data row3 col2">doc1</td>
<td id="T_f6868_row3_col3" class="data row3 col3">[@3ba775,44,67) " Im walkin..."</td>
</tr>
<tr class="odd">
<td id="T_f6868_row4_col0" class="data row4 col0">doc2</td>
<td id="T_f6868_row4_col1" class="data row4 col1">[@06bc2d,0,22) "Im walking..."</td>
<td id="T_f6868_row4_col2" class="data row4 col2">doc2</td>
<td id="T_f6868_row4_col3" class="data row4 col3">[@06bc2d,36,59) " Im walkin..."</td>
</tr>
<tr class="even">
<td id="T_f6868_row5_col0" class="data row5 col0">doc2</td>
<td id="T_f6868_row5_col1" class="data row5 col1">[@06bc2d,36,59) " Im walkin..."</td>
<td id="T_f6868_row5_col2" class="data row5 col2">doc1</td>
<td id="T_f6868_row5_col3" class="data row5 col3">[@3ba775,44,67) " Im walkin..."</td>
</tr>
<tr class="odd">
<td id="T_f6868_row6_col0" class="data row6 col0">doc2</td>
<td id="T_f6868_row6_col1" class="data row6 col1">[@06bc2d,36,59) " Im walkin..."</td>
<td id="T_f6868_row6_col2" class="data row6 col2">doc2</td>
<td id="T_f6868_row6_col3" class="data row6 col3">[@06bc2d,0,22) "Im walking..."</td>
</tr>
<tr class="even">
<td id="T_f6868_row7_col0" class="data row7 col0">doc3</td>
<td id="T_f6868_row7_col1" class="data row7 col1">[@9c32df,21,65) " The quick..."</td>
<td id="T_f6868_row7_col2" class="data row7 col2">doc1</td>
<td id="T_f6868_row7_col3" class="data row7 col3">[@3ba775,0,43) "The quick ..."</td>
</tr>
</tbody>
</table>


<script type="module">
    const { DataTable, jQuery: $ } = await import(window._datatables_src_for_itables_2_1_4);

    document.querySelectorAll("#T_f6868:not(.dataTable)").forEach(table => {
        // Define the table data
        

        // Define the dt_args
        let dt_args = {"columnDefs": [{"targets": ["doc_id1", "sent1", "doc_id2", "sent2"], "render": function(data, type, row) {
                    return '<div style="white-space: normal; word-wrap: break-word;">' + data + '</div>';
                }, "width": "300px"}], "escape": true, "layout": {"topStart": null, "topEnd": null, "bottomStart": null, "bottomEnd": null}, "display_logo_when_loading": true, "order": []};
        

        
        new DataTable(table, dt_args);
    });
</script>
</div>
</div>
</section>
<section id="oops-handling-symmetric-queries" class="level3">
<h3 class="anchored" data-anchor-id="oops-handling-symmetric-queries">Oops, handling symmetric queries</h3>
<p>Notice that we got each pair twice. This is because while we think of a sentence pair as a set with two sentences, the tuples <code>(x,y)</code> and <code>(y,x)</code> are actually different. To remedy this we can limit our pairs to pairs where the first sentence is in a smaller position (ie position in memory).</p>
<p>We can do that by introducing a <a href="https://DeanLight.github.io/spannerlib/tutorials/basic_tasks.html#span_lt"><code>span_lt</code></a> ie function</p>
<hr>
<p><a href="https://github.com/DeanLight/spannerlib/blob/master/spannerlib/tutorials/basic.py#L32" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="span_lt" class="level3">
<h3 class="anchored" data-anchor-id="span_lt">span_lt</h3>
<blockquote class="blockquote">
<pre><code> span_lt (span1, span2)</code></pre>
</blockquote>
<div id="cell-30" class="cell">
<details open="" class="code-fold">
<summary>Exported source</summary>
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> span_lt(span1, span2):</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">yield</span> span1 <span class="op">&lt;</span> span2</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div id="cell-31" class="cell">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>sess.register(<span class="st">'span_lt'</span>, span_lt, [Span,Span],[<span class="bu">bool</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-32" class="cell">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>EqualSentsUniqe(doc_id1,sent1,doc_id2,sent2)<span class="op">&lt;-</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>    Sents(doc_id1,sent1),</span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>    Sents(doc_id2,sent2),</span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>    span_lt(sent1,sent2)<span class="op">-&gt;</span>(<span class="va">True</span>),</span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>    eq_content_spans(sent1,sent2)<span class="op">-&gt;</span>(<span class="va">True</span>).</span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a>?EqualSentsUniqe(doc_id1,sent1,doc_id2,sent2)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>'?EqualSentsUniqe(doc_id1,sent1,doc_id2,sent2)'</code></pre>
</div>
<div class="cell-output cell-output-display">
<style type="text/css">
#T_a7df0_row0_col0, #T_a7df0_row0_col1, #T_a7df0_row0_col2, #T_a7df0_row0_col3, #T_a7df0_row1_col0, #T_a7df0_row1_col1, #T_a7df0_row1_col2, #T_a7df0_row1_col3, #T_a7df0_row2_col0, #T_a7df0_row2_col1, #T_a7df0_row2_col2, #T_a7df0_row2_col3, #T_a7df0_row3_col0, #T_a7df0_row3_col1, #T_a7df0_row3_col2, #T_a7df0_row3_col3 {
  overflow-wrap: break-word;
  max-width: 800px;
  text-align: left;
}
</style>

<table id="T_a7df0" class="display nowrap caption-top table table-sm table-striped small" data-quarto-postprocess="true">
<thead>
<tr class="header">
<th id="T_a7df0_level0_col0" class="col_heading level0 col0" data-quarto-table-cell-role="th">doc_id1</th>
<th id="T_a7df0_level0_col1" class="col_heading level0 col1" data-quarto-table-cell-role="th">sent1</th>
<th id="T_a7df0_level0_col2" class="col_heading level0 col2" data-quarto-table-cell-role="th">doc_id2</th>
<th id="T_a7df0_level0_col3" class="col_heading level0 col3" data-quarto-table-cell-role="th">sent2</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td id="T_a7df0_row0_col0" class="data row0 col0">doc2</td>
<td id="T_a7df0_row0_col1" class="data row0 col1">[@06bc2d,0,22) "Im walking..."</td>
<td id="T_a7df0_row0_col2" class="data row0 col2">doc1</td>
<td id="T_a7df0_row0_col3" class="data row0 col3">[@3ba775,44,67) " Im walkin..."</td>
</tr>
<tr class="even">
<td id="T_a7df0_row1_col0" class="data row1 col0">doc2</td>
<td id="T_a7df0_row1_col1" class="data row1 col1">[@06bc2d,0,22) "Im walking..."</td>
<td id="T_a7df0_row1_col2" class="data row1 col2">doc2</td>
<td id="T_a7df0_row1_col3" class="data row1 col3">[@06bc2d,36,59) " Im walkin..."</td>
</tr>
<tr class="odd">
<td id="T_a7df0_row2_col0" class="data row2 col0">doc2</td>
<td id="T_a7df0_row2_col1" class="data row2 col1">[@06bc2d,36,59) " Im walkin..."</td>
<td id="T_a7df0_row2_col2" class="data row2 col2">doc1</td>
<td id="T_a7df0_row2_col3" class="data row2 col3">[@3ba775,44,67) " Im walkin..."</td>
</tr>
<tr class="even">
<td id="T_a7df0_row3_col0" class="data row3 col0">doc3</td>
<td id="T_a7df0_row3_col1" class="data row3 col1">[@9c32df,21,65) " The quick..."</td>
<td id="T_a7df0_row3_col2" class="data row3 col2">doc1</td>
<td id="T_a7df0_row3_col3" class="data row3 col3">[@3ba775,0,43) "The quick ..."</td>
</tr>
</tbody>
</table>


<script type="module">
    const { DataTable, jQuery: $ } = await import(window._datatables_src_for_itables_2_1_4);

    document.querySelectorAll("#T_a7df0:not(.dataTable)").forEach(table => {
        // Define the table data
        

        // Define the dt_args
        let dt_args = {"columnDefs": [{"targets": ["doc_id1", "sent1", "doc_id2", "sent2"], "render": function(data, type, row) {
                    return '<div style="white-space: normal; word-wrap: break-word;">' + data + '</div>';
                }, "width": "300px"}], "escape": true, "layout": {"topStart": null, "topEnd": null, "bottomStart": null, "bottomEnd": null}, "display_logo_when_loading": true, "order": []};
        

        
        new DataTable(table, dt_args);
    });
</script>
</div>
</div>
</section>
</section>
<section id="building-llm-agents-using-spannerlib" class="level2">
<h2 class="anchored" data-anchor-id="building-llm-agents-using-spannerlib">Building LLM agents using spannerlib</h2>
<section id="motivation" class="level3">
<h3 class="anchored" data-anchor-id="motivation">Motivation</h3>
<p>Most LLM based applications do not include a single call to an LLM, but are rather built using LLM agents. LLM agents are programs that * Wrap LLMs in control logic. * Either deterministic * Or decided by an LLM * Offloads structured reasoning to tools, whose output is fed into some of the Prompts that are used by the agent’s LLMs.</p>
<p>In this tutorial we will show how to build a simple agent that might be used to build the backend of a more nuanced ChatGPT-like like system.</p>
<p>Our agent takes: * A question from a user</p>
<p>And has previous knowledge encoding * How to best answer questions on different topics. * How to a user prefers his answers to be formatted.</p>
For example, given the question “How do we measure the distance between stars” we might note that in cases of scientific questions, it is better to answer using mathematical notation and formulas, rather than pure english. Moreover, some users would like the answer to be styled in an academic way, with dense prose ending with citations, like so:
<blockquote class="blockquote">
<p>The distance between stars is measured in astronomical units (AU), parsecs (pc), or light-years (ly).</p>
<ol type="1">
<li><p><strong>Astronomical Unit (AU)</strong>: An AU is the average distance between the Earth and the Sun, which is approximately 93 million miles or 150 million kilometers. It is more commonly used to measure distances within our solar system.</p></li>
<li><p><strong>Parsec (pc)</strong>: A parsec is a unit of distance used in astronomy, defined as the distance at which an object would have a parallax angle of one arcsecond. One parsec is equal to approximately 3.26 light-years or 3.09 x 10^13 kilometers.</p></li>
<li><p><strong>Light-year (ly)</strong>: A light-year is the distance that light travels in one year, which is approximately 9.46 trillion kilometers or about 5.88 trillion miles.</p></li>
</ol>
<p>To measure the distance to a star, astronomers use methods such as parallax and spectroscopic parallax. Parallax involves observing a star from two different points in Earth’s orbit and measuring the apparent shift in position. Spectroscopic parallax uses the star’s spectral type and luminosity to estimate its distance.</p>
<p>In summary, astronomers use a combination of trigonometric and spectroscopic methods to measure the distance between stars in order to better understand the vastness of our universe.</p>
<strong>References:</strong> 1. Carroll, B. W., &amp; Ostlie, D. A. (2007). <em>An introduction to modern astrophysics</em> (2nd ed.). Pearson Addison-Wesley. 2. Bennett, J., Donahue, M., Schneider, N., &amp; Voit, M. (2014). <em>The cosmic perspective</em> (7th ed.). Pearson.
</blockquote>
While other users will like a shorter answer in simple language like so:
<blockquote class="blockquote">
<p>One common way to measure the distance between stars is through parallax. Parallax is the apparent shift in position of an object when viewed from two different points.</p>
<p>The parallax angle, denoted by p, is the angle formed between a line from the observer to the nearer star and a line from the observer to the farther star. The parallax angle is related to the distance to the star (d) by the formula:</p>
<p>d = 1 / p</p>
<p>where d is the distance to the star in parsecs (pc) and p is the parallax angle in arcseconds (“).</p>
A parsec is a unit of distance often used in astronomy, equal to about 3.26 light-years. So when we measure the parallax angle of a star, we can use the formula above to calculate its distance from Earth.
</blockquote>
</section>
<section id="problem-definition" class="level3">
<h3 class="anchored" data-anchor-id="problem-definition">Problem definition</h3>
<p>So given: * A relation of the form <code>(user,question)</code> * A relation of the form <code>(topic,topicSpecificIntructions)</code> * A relation of the form <code>(user,userSpecificInstructions)</code></p>
<p>We would like to output for each user and question, an answer that fits both the user’s specified preferences and the instructions fitting for that topic.</p>
</section>
<section id="defining-our-ie-functions" class="level3">
<h3 class="anchored" data-anchor-id="defining-our-ie-functions">Defining our IE functions</h3>
<p>For building the agent we need 2 basic building blocks as IE functions: * an <a href="https://DeanLight.github.io/spannerlib/tutorials/basic_tasks.html#llm"><code>llm</code></a> function of the form <code>llm(model:str,prompt:str)-&gt;(answer:str)</code> * a <code>printf</code> like function <code>format</code> for formatting a prompt from template and other strings which will be of the form <code>format(template:str,s_1:str,...s_n:str)-&gt;(prompt:str)</code></p>
<p>The following section will involve technical details such as data type conversions and interfacing with OpenAI’s API. If this is not of interest to the reader, please skip to the next section.</p>
</section>
<section id="tldr-1" class="level3">
<h3 class="anchored" data-anchor-id="tldr-1">TLDR</h3>
<p>Basic call to LLM</p>
<div class="sourceCode" id="cb23"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>spannerlog</span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> <span class="st">'gpt-3.5-turbo'</span></span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>prompt <span class="op">=</span> <span class="st">"user: sing it with me, love, what is it good for?"</span></span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a>TestLLM(answer)<span class="op">&lt;-</span></span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a>    llm($model,$prompt)<span class="op">-&gt;</span>(answer).</span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-9"><a href="#cb23-9" aria-hidden="true" tabindex="-1"></a>?TestLLM(answer)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Style and topic based completion</p>
<div class="sourceCode" id="cb24"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>spannerlog</span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> <span class="st">'gpt-3.5-turbo'</span></span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a><span class="co"># asking the llm to generate the topic based on the question</span></span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a>TopicSelection(question ,topic)<span class="op">&lt;-</span></span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a>    Questions(user,question),</span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a>    <span class="bu">format</span>($topic_selection_template,question)<span class="op">-&gt;</span>(prompt),</span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a>    llm($model,prompt)<span class="op">-&gt;</span>(topic).</span>
<span id="cb24-8"><a href="#cb24-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-9"><a href="#cb24-9" aria-hidden="true" tabindex="-1"></a><span class="co"># composing a prompt based on topic and user preference </span></span>
<span id="cb24-10"><a href="#cb24-10" aria-hidden="true" tabindex="-1"></a><span class="co"># and calling an llm to generate the answer</span></span>
<span id="cb24-11"><a href="#cb24-11" aria-hidden="true" tabindex="-1"></a>StyleBasedQA(question,user,answer)<span class="op">&lt;-</span></span>
<span id="cb24-12"><a href="#cb24-12" aria-hidden="true" tabindex="-1"></a>    Questions(user,question),</span>
<span id="cb24-13"><a href="#cb24-13" aria-hidden="true" tabindex="-1"></a>    TopicSelection(question,topic),</span>
<span id="cb24-14"><a href="#cb24-14" aria-hidden="true" tabindex="-1"></a>    UserAnswerPreference(user,user_style),</span>
<span id="cb24-15"><a href="#cb24-15" aria-hidden="true" tabindex="-1"></a>    TopicSpecificStyle(topic,topic_style),</span>
<span id="cb24-16"><a href="#cb24-16" aria-hidden="true" tabindex="-1"></a>    <span class="bu">format</span>($custom_style_prompt,topic_style,user_style,question)<span class="op">-&gt;</span>(prompt),</span>
<span id="cb24-17"><a href="#cb24-17" aria-hidden="true" tabindex="-1"></a>    llm($model,prompt)<span class="op">-&gt;</span>(answer).</span>
<span id="cb24-18"><a href="#cb24-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-19"><a href="#cb24-19" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>python</span>
<span id="cb24-20"><a href="#cb24-20" aria-hidden="true" tabindex="-1"></a>sess.export(<span class="st">'?StyleBasedQA(question,user,answer)'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="walkthrough-1" class="level3">
<h3 class="anchored" data-anchor-id="walkthrough-1">Walkthrough</h3>
<p>Here is the implemetation:</p>
<p>To implement the <a href="https://DeanLight.github.io/spannerlib/tutorials/basic_tasks.html#llm"><code>llm</code></a> ie function, we need to wrap some LLM api as an IE function. We want an ie function that takes a string and returns a string. Since most LLM api expect a dict of the form <code>{'role':role,'content':message}</code> we will write converters that parse them from prompt strings of the form</p>
<div class="sourceCode" id="cb25"><pre class="sourceCode txt code-with-copy"><code class="sourceCode default"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>role: content</span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>role: content</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<hr>
<p><a href="https://github.com/DeanLight/spannerlib/blob/master/spannerlib/tutorials/basic.py#L71" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="llm" class="level3">
<h3 class="anchored" data-anchor-id="llm">llm</h3>
<blockquote class="blockquote">
<pre><code> llm (model, question)</code></pre>
</blockquote>
<div id="cell-52" class="cell">
<details open="" class="code-fold">
<summary>Exported source</summary>
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> spannerlib.ie_func.basic <span class="im">import</span> rgx_split</span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> functools <span class="im">import</span> cache</span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> openai</span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> joblib <span class="im">import</span> Memory</span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a>memory <span class="op">=</span> Memory(<span class="st">"cachedir"</span>, verbose<span class="op">=</span><span class="dv">0</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div id="cell-53" class="cell">
<details open="" class="code-fold">
<summary>Exported source</summary>
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="at">@cache</span></span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> _get_client():</span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> openai.Client()</span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a><span class="co"># we use the rgx_split function to split the string into messages</span></span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> _str_to_messages (string_prompt):</span>
<span id="cb28-7"><a href="#cb28-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> [</span>
<span id="cb28-8"><a href="#cb28-8" aria-hidden="true" tabindex="-1"></a>        {</span>
<span id="cb28-9"><a href="#cb28-9" aria-hidden="true" tabindex="-1"></a>            <span class="st">'role'</span>: <span class="bu">str</span>(role).replace(<span class="st">': '</span>,<span class="st">''</span>),</span>
<span id="cb28-10"><a href="#cb28-10" aria-hidden="true" tabindex="-1"></a>            <span class="st">'content'</span>: <span class="bu">str</span>(content)</span>
<span id="cb28-11"><a href="#cb28-11" aria-hidden="true" tabindex="-1"></a>        } <span class="cf">for</span> role,content <span class="kw">in</span> rgx_split(<span class="st">'system:\s|assistant:\s|user:\s'</span>, string_prompt.strip())</span>
<span id="cb28-12"><a href="#cb28-12" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb28-13"><a href="#cb28-13" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> _messages_to_string(msgs):</span>
<span id="cb28-14"><a href="#cb28-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="st">''</span>.join([<span class="ss">f"</span><span class="sc">{</span>msg[<span class="st">'content'</span>]<span class="sc">}</span><span class="ss">"</span> <span class="cf">for</span> msg <span class="kw">in</span> msgs])</span>
<span id="cb28-15"><a href="#cb28-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-16"><a href="#cb28-16" aria-hidden="true" tabindex="-1"></a><span class="co"># the specific API we are going to call using the messages interface</span></span>
<span id="cb28-17"><a href="#cb28-17" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> _openai_chat(model, messages):</span>
<span id="cb28-18"><a href="#cb28-18" aria-hidden="true" tabindex="-1"></a>    client <span class="op">=</span> _get_client()</span>
<span id="cb28-19"><a href="#cb28-19" aria-hidden="true" tabindex="-1"></a>    respone <span class="op">=</span> client.chat.completions.create(</span>
<span id="cb28-20"><a href="#cb28-20" aria-hidden="true" tabindex="-1"></a>        model<span class="op">=</span>model,</span>
<span id="cb28-21"><a href="#cb28-21" aria-hidden="true" tabindex="-1"></a>        messages<span class="op">=</span>messages,</span>
<span id="cb28-22"><a href="#cb28-22" aria-hidden="true" tabindex="-1"></a>        seed<span class="op">=</span><span class="dv">42</span></span>
<span id="cb28-23"><a href="#cb28-23" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb28-24"><a href="#cb28-24" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> [<span class="bu">dict</span>(respone.choices[<span class="dv">0</span>].message)]</span>
<span id="cb28-25"><a href="#cb28-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-26"><a href="#cb28-26" aria-hidden="true" tabindex="-1"></a><span class="co"># we disk cache our function to spare my openAI credits</span></span>
<span id="cb28-27"><a href="#cb28-27" aria-hidden="true" tabindex="-1"></a><span class="at">@memory.cache</span></span>
<span id="cb28-28"><a href="#cb28-28" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> llm(model, question):</span>
<span id="cb28-29"><a href="#cb28-29" aria-hidden="true" tabindex="-1"></a>    q_msgs <span class="op">=</span> _str_to_messages(question)</span>
<span id="cb28-30"><a href="#cb28-30" aria-hidden="true" tabindex="-1"></a>    a_msgs <span class="op">=</span> _openai_chat(model, q_msgs)</span>
<span id="cb28-31"><a href="#cb28-31" aria-hidden="true" tabindex="-1"></a>    answer <span class="op">=</span> _messages_to_string(a_msgs)</span>
<span id="cb28-32"><a href="#cb28-32" aria-hidden="true" tabindex="-1"></a>    <span class="co"># avoid bad fromatting of the answer in the notebook due to nested code blocks</span></span>
<span id="cb28-33"><a href="#cb28-33" aria-hidden="true" tabindex="-1"></a>    answer <span class="op">=</span> answer.replace(<span class="st">'```'</span>,<span class="st">''</span>)</span>
<span id="cb28-34"><a href="#cb28-34" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> [answer]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div id="cell-54" class="cell">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a>llm(<span class="st">'gpt-3.5-turbo'</span>,<span class="st">'user: Hello, who are you?'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>['Hello! I am a AI-powered virtual assistant designed to help and provide information to users. How can I assist you today?']</code></pre>
</div>
</div>
<p>Now we can register the llm function as an ie function and use it from in spannerlog code.</p>
<p>Now let see how we can use spannerlib to build a simple pipeline that varries the LLM prompt in a data dependant way. Imagine that we have a chatbot that we want to act differently based on the topic of conversation and the user preference.</p>
<p>To enable us to format prompts from data, we will use a prompt formatting function with a <code>printf</code> like syntax. It is available in spannerlib’s stdlib, but we will reproduce it here.</p>
<hr>
<p><a href="https://github.com/DeanLight/spannerlib/blob/master/spannerlib/tutorials/basic.py#L80" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="format_ie" class="level3">
<h3 class="anchored" data-anchor-id="format_ie">format_ie</h3>
<blockquote class="blockquote">
<pre><code> format_ie (f_string, *params)</code></pre>
</blockquote>
<div id="cell-59" class="cell">
<details open="" class="code-fold">
<summary>Exported source</summary>
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> format_ie(f_string,<span class="op">*</span>params):</span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">yield</span> f_string.<span class="bu">format</span>(<span class="op">*</span>params)</span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a><span class="co"># note that since the schema is dynamic we need to define a function that returns the schema based on the arity</span></span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a>string_schema <span class="op">=</span> <span class="kw">lambda</span> x: ([<span class="bu">str</span>]<span class="op">*</span>x)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div id="cell-60" class="cell">
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a>sess.register(<span class="st">'llm'</span>, llm, [<span class="bu">str</span>,<span class="bu">str</span>],[<span class="bu">str</span>])</span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a>sess.register(<span class="st">'format'</span>, format_ie, string_schema,[<span class="bu">str</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="seeing-our-llm-ie-function-in-action" class="level3">
<h3 class="anchored" data-anchor-id="seeing-our-llm-ie-function-in-action">Seeing our llm IE function in action</h3>
<div id="cell-62" class="cell">
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> <span class="st">'gpt-3.5-turbo'</span></span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a>prompt <span class="op">=</span> <span class="st">"user: sing it with me, love, what is it good for?"</span></span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a>TestLLM(answer)<span class="op">&lt;-</span></span>
<span id="cb34-5"><a href="#cb34-5" aria-hidden="true" tabindex="-1"></a>    llm($model,$prompt)<span class="op">-&gt;</span>(answer).</span>
<span id="cb34-6"><a href="#cb34-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-7"><a href="#cb34-7" aria-hidden="true" tabindex="-1"></a>?TestLLM(answer)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>'?TestLLM(answer)'</code></pre>
</div>
<div class="cell-output cell-output-display">
<style type="text/css">
#T_b199c_row0_col0 {
  overflow-wrap: break-word;
  max-width: 800px;
  text-align: left;
}
</style>

<table id="T_b199c" class="display nowrap caption-top table table-sm table-striped small" data-quarto-postprocess="true">
<thead>
<tr class="header">
<th id="T_b199c_level0_col0" class="col_heading level0 col0" data-quarto-table-cell-role="th">answer</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td id="T_b199c_row0_col0" class="data row0 col0">Absolutely nothing!</td>
</tr>
</tbody>
</table>


<script type="module">
    const { DataTable, jQuery: $ } = await import(window._datatables_src_for_itables_2_1_4);

    document.querySelectorAll("#T_b199c:not(.dataTable)").forEach(table => {
        // Define the table data
        

        // Define the dt_args
        let dt_args = {"columnDefs": [{"targets": ["answer"], "render": function(data, type, row) {
                    return '<div style="white-space: normal; word-wrap: break-word;">' + data + '</div>';
                }, "width": "300px"}], "escape": true, "layout": {"topStart": null, "topEnd": null, "bottomStart": null, "bottomEnd": null}, "display_logo_when_loading": true, "order": []};
        

        
        new DataTable(table, dt_args);
    });
</script>
</div>
</div>
</section>
<section id="example-data" class="level3">
<h3 class="anchored" data-anchor-id="example-data">Example data</h3>
<p>We will model our data as follows:</p>
<div id="cell-65" class="cell">
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="co"># a binary relation that stores how the user prefers the formatted</span></span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a>user_answer_preference <span class="op">=</span> pd.DataFrame([</span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a>    (<span class="st">'Bob'</span>, <span class="st">'please answer in prose. Make sure you add references in the end like a bibliography.'</span>),</span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a>    (<span class="st">'Joe'</span>, <span class="st">'Prose is hard for me to read quickly. Format the answer in bullet points.'</span>),</span>
<span id="cb36-5"><a href="#cb36-5" aria-hidden="true" tabindex="-1"></a>    (<span class="st">'Sally'</span>, <span class="st">'Try to avoid complicated jargon and use simple language.'</span>),</span>
<span id="cb36-6"><a href="#cb36-6" aria-hidden="true" tabindex="-1"></a>])</span>
<span id="cb36-7"><a href="#cb36-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-8"><a href="#cb36-8" aria-hidden="true" tabindex="-1"></a><span class="co"># relation that stores per topic style</span></span>
<span id="cb36-9"><a href="#cb36-9" aria-hidden="true" tabindex="-1"></a>topic_specific_style <span class="op">=</span> pd.DataFrame([</span>
<span id="cb36-10"><a href="#cb36-10" aria-hidden="true" tabindex="-1"></a>    (<span class="st">'history'</span>, <span class="st">'please answer in a narrative form, use shakespearing language and lots of examples'</span>),</span>
<span id="cb36-11"><a href="#cb36-11" aria-hidden="true" tabindex="-1"></a>    (<span class="st">'science'</span>, <span class="st">'Use mathematical notation and formulas to explain the concepts.'</span>),</span>
<span id="cb36-12"><a href="#cb36-12" aria-hidden="true" tabindex="-1"></a>    (<span class="st">'hiphop'</span>, <span class="st">'introduce the answer with a rap verse.'</span>),</span>
<span id="cb36-13"><a href="#cb36-13" aria-hidden="true" tabindex="-1"></a>    (<span class="st">'other'</span>, <span class="st">'Be polite and neutral in your answer. Avoid controversial topics.'</span>),</span>
<span id="cb36-14"><a href="#cb36-14" aria-hidden="true" tabindex="-1"></a>])</span>
<span id="cb36-15"><a href="#cb36-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-16"><a href="#cb36-16" aria-hidden="true" tabindex="-1"></a>sess.import_rel(<span class="st">'UserAnswerPreference'</span>, user_answer_preference)</span>
<span id="cb36-17"><a href="#cb36-17" aria-hidden="true" tabindex="-1"></a>sess.import_rel(<span class="st">'TopicSpecificStyle'</span>, topic_specific_style)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="buliding-the-agent-logic-in-spannerlog" class="level3">
<h3 class="anchored" data-anchor-id="buliding-the-agent-logic-in-spannerlog">Buliding the agent logic in spannerlog</h3>
<p>Now we will build our pipeline as follows: * We will make an llm call to help us decide the topic of the question * Based on the topic and the user, we will formulate the final prompt for the llm to answer.</p>
<div id="cell-68" class="cell">
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a>prompts <span class="op">=</span> pd.DataFrame([</span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a>    (<span class="st">'topic_selection'</span>,</span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a><span class="st">"""</span></span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a><span class="st">system: Please select a topic from the following list: [history, science, hiphop, other]</span></span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true" tabindex="-1"></a><span class="st">based on the question provided by the user. You are only allowed to say the topic name, nothing else.</span></span>
<span id="cb37-6"><a href="#cb37-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-7"><a href="#cb37-7" aria-hidden="true" tabindex="-1"></a><span class="st">user: </span><span class="sc">{}</span></span>
<span id="cb37-8"><a href="#cb37-8" aria-hidden="true" tabindex="-1"></a><span class="st">"""</span>),</span>
<span id="cb37-9"><a href="#cb37-9" aria-hidden="true" tabindex="-1"></a>    (<span class="st">'custom_style_prompt'</span>,</span>
<span id="cb37-10"><a href="#cb37-10" aria-hidden="true" tabindex="-1"></a><span class="st">"""</span></span>
<span id="cb37-11"><a href="#cb37-11" aria-hidden="true" tabindex="-1"></a><span class="st">system: Answer the question of the user in the following style:</span></span>
<span id="cb37-12"><a href="#cb37-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-13"><a href="#cb37-13" aria-hidden="true" tabindex="-1"></a><span class="st">topic specific style instructions: </span><span class="sc">{}</span></span>
<span id="cb37-14"><a href="#cb37-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-15"><a href="#cb37-15" aria-hidden="true" tabindex="-1"></a><span class="st">user specific style instructions: </span><span class="sc">{}</span></span>
<span id="cb37-16"><a href="#cb37-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-17"><a href="#cb37-17" aria-hidden="true" tabindex="-1"></a><span class="st">user: </span><span class="sc">{}</span></span>
<span id="cb37-18"><a href="#cb37-18" aria-hidden="true" tabindex="-1"></a><span class="st">"""</span></span>
<span id="cb37-19"><a href="#cb37-19" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb37-20"><a href="#cb37-20" aria-hidden="true" tabindex="-1"></a>])</span>
<span id="cb37-21"><a href="#cb37-21" aria-hidden="true" tabindex="-1"></a>sess.import_rel(<span class="st">'Prompts'</span>, prompts)</span>
<span id="cb37-22"><a href="#cb37-22" aria-hidden="true" tabindex="-1"></a>prompts</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">0</th>
<th data-quarto-table-cell-role="th">1</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>topic_selection</td>
<td>system: Please select a topic from the follow...</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>custom_style_prompt</td>
<td>system: Answer the question of the user in th...</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<div id="cell-69" class="cell">
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a>?Prompts(prompt_id,prompt)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>'?Prompts(prompt_id,prompt)'</code></pre>
</div>
<div class="cell-output cell-output-display">
<style type="text/css">
#T_ddb04_row0_col0, #T_ddb04_row0_col1, #T_ddb04_row1_col0, #T_ddb04_row1_col1 {
  overflow-wrap: break-word;
  max-width: 800px;
  text-align: left;
}
</style>

<table id="T_ddb04" class="display nowrap caption-top table table-sm table-striped small" data-quarto-postprocess="true">
<thead>
<tr class="header">
<th id="T_ddb04_level0_col0" class="col_heading level0 col0" data-quarto-table-cell-role="th">prompt_id</th>
<th id="T_ddb04_level0_col1" class="col_heading level0 col1" data-quarto-table-cell-role="th">prompt</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td id="T_ddb04_row0_col0" class="data row0 col0">custom_style_prompt</td>
<td id="T_ddb04_row0_col1" class="data row0 col1">system: Answer the question of the user in the following style: topic specific style instructions: {} user specific style instructions: {} user: {}</td>
</tr>
<tr class="even">
<td id="T_ddb04_row1_col0" class="data row1 col0">topic_selection</td>
<td id="T_ddb04_row1_col1" class="data row1 col1">system: Please select a topic from the following list: [history, science, hiphop, other] based on the question provided by the user. You are only allowed to say the topic name, nothing else. user: {}</td>
</tr>
</tbody>
</table>


<script type="module">
    const { DataTable, jQuery: $ } = await import(window._datatables_src_for_itables_2_1_4);

    document.querySelectorAll("#T_ddb04:not(.dataTable)").forEach(table => {
        // Define the table data
        

        // Define the dt_args
        let dt_args = {"columnDefs": [{"targets": ["prompt_id", "prompt"], "render": function(data, type, row) {
                    return '<div style="white-space: normal; word-wrap: break-word;">' + data + '</div>';
                }, "width": "300px"}], "escape": true, "layout": {"topStart": null, "topEnd": null, "bottomStart": null, "bottomEnd": null}, "display_logo_when_loading": true, "order": []};
        

        
        new DataTable(table, dt_args);
    });
</script>
</div>
</div>
<p>Now given a relation of user and question</p>
<div id="cell-71" class="cell">
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a>questions<span class="op">=</span> pd.DataFrame([</span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a>    (<span class="st">'Bob'</span>, <span class="st">'Who won the civil war?'</span>),</span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a>    (<span class="st">'Joe'</span>, <span class="st">'Who won the civil war?'</span>),</span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true" tabindex="-1"></a>    (<span class="st">'Sally'</span>, <span class="st">'Who won the civil war?'</span>),</span>
<span id="cb40-5"><a href="#cb40-5" aria-hidden="true" tabindex="-1"></a>    (<span class="st">'Bob'</span>, <span class="st">'How do we measure the distance between stars?'</span>),</span>
<span id="cb40-6"><a href="#cb40-6" aria-hidden="true" tabindex="-1"></a>    (<span class="st">'Joe'</span>, <span class="st">'How do we measure the distance between stars?'</span>),</span>
<span id="cb40-7"><a href="#cb40-7" aria-hidden="true" tabindex="-1"></a>    (<span class="st">'Sally'</span>, <span class="st">'How do we measure the distance between stars?'</span>),</span>
<span id="cb40-8"><a href="#cb40-8" aria-hidden="true" tabindex="-1"></a>    (<span class="st">'Bob'</span>, <span class="st">'Who are the most well known rappers?'</span>),</span>
<span id="cb40-9"><a href="#cb40-9" aria-hidden="true" tabindex="-1"></a>    (<span class="st">'Joe'</span>, <span class="st">'Who are the most well known rappers?'</span>),</span>
<span id="cb40-10"><a href="#cb40-10" aria-hidden="true" tabindex="-1"></a>    (<span class="st">'Sally'</span>, <span class="st">'Who are the most well known rappers?'</span>),</span>
<span id="cb40-11"><a href="#cb40-11" aria-hidden="true" tabindex="-1"></a>])</span>
<span id="cb40-12"><a href="#cb40-12" aria-hidden="true" tabindex="-1"></a>sess.import_rel(<span class="st">'Questions'</span>, questions)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now lets combine all of this into a pipeline. We will break our pipeline into more debugable bits, and add some extra logical variables in the rule heads for ease of inspection.</p>
<div id="cell-73" class="cell">
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> <span class="st">'gpt-3.5-turbo'</span></span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a>TopicPrompt(q,p)<span class="op">&lt;-</span></span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a>    Questions(user,q),</span>
<span id="cb41-4"><a href="#cb41-4" aria-hidden="true" tabindex="-1"></a>    Prompts(<span class="st">'topic_selection'</span>,template),</span>
<span id="cb41-5"><a href="#cb41-5" aria-hidden="true" tabindex="-1"></a>    <span class="bu">format</span>(template,q)<span class="op">-&gt;</span>(p).</span>
<span id="cb41-6"><a href="#cb41-6" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb41-7"><a href="#cb41-7" aria-hidden="true" tabindex="-1"></a>?TopicPrompt(q,p)</span>
<span id="cb41-8"><a href="#cb41-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-9"><a href="#cb41-9" aria-hidden="true" tabindex="-1"></a>TopicSelection(q,t)<span class="op">&lt;-</span></span>
<span id="cb41-10"><a href="#cb41-10" aria-hidden="true" tabindex="-1"></a>    TopicPrompt(q,p),</span>
<span id="cb41-11"><a href="#cb41-11" aria-hidden="true" tabindex="-1"></a>    llm($model,p)<span class="op">-&gt;</span>(t).</span>
<span id="cb41-12"><a href="#cb41-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-13"><a href="#cb41-13" aria-hidden="true" tabindex="-1"></a>?TopicSelection(q,t)</span>
<span id="cb41-14"><a href="#cb41-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-15"><a href="#cb41-15" aria-hidden="true" tabindex="-1"></a>StylePrompt(q,p,topic,user)<span class="op">&lt;-</span></span>
<span id="cb41-16"><a href="#cb41-16" aria-hidden="true" tabindex="-1"></a>    Questions(user,q),</span>
<span id="cb41-17"><a href="#cb41-17" aria-hidden="true" tabindex="-1"></a>    TopicSelection(q,topic),</span>
<span id="cb41-18"><a href="#cb41-18" aria-hidden="true" tabindex="-1"></a>    UserAnswerPreference(user,user_style),</span>
<span id="cb41-19"><a href="#cb41-19" aria-hidden="true" tabindex="-1"></a>    TopicSpecificStyle(topic,topic_style),</span>
<span id="cb41-20"><a href="#cb41-20" aria-hidden="true" tabindex="-1"></a>    Prompts(<span class="st">'custom_style_prompt'</span>,prompt_template),</span>
<span id="cb41-21"><a href="#cb41-21" aria-hidden="true" tabindex="-1"></a>    <span class="bu">format</span>(prompt_template,topic_style,user_style,q)<span class="op">-&gt;</span>(p).</span>
<span id="cb41-22"><a href="#cb41-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-23"><a href="#cb41-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-24"><a href="#cb41-24" aria-hidden="true" tabindex="-1"></a>Style_Based_QA(question,topic,user,prompt,answer)<span class="op">&lt;-</span></span>
<span id="cb41-25"><a href="#cb41-25" aria-hidden="true" tabindex="-1"></a>    StylePrompt(question,prompt,topic,user),</span>
<span id="cb41-26"><a href="#cb41-26" aria-hidden="true" tabindex="-1"></a>    llm($model,prompt)<span class="op">-&gt;</span>(answer).</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>'?TopicPrompt(q,p)'</code></pre>
</div>
<div class="cell-output cell-output-display">
<style type="text/css">
#T_c8b13_row0_col0, #T_c8b13_row0_col1, #T_c8b13_row1_col0, #T_c8b13_row1_col1, #T_c8b13_row2_col0, #T_c8b13_row2_col1 {
  overflow-wrap: break-word;
  max-width: 800px;
  text-align: left;
}
</style>

<table id="T_c8b13" class="display nowrap caption-top table table-sm table-striped small" data-quarto-postprocess="true">
<thead>
<tr class="header">
<th id="T_c8b13_level0_col0" class="col_heading level0 col0" data-quarto-table-cell-role="th">q</th>
<th id="T_c8b13_level0_col1" class="col_heading level0 col1" data-quarto-table-cell-role="th">p</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td id="T_c8b13_row0_col0" class="data row0 col0">How do we measure the distance between stars?</td>
<td id="T_c8b13_row0_col1" class="data row0 col1">system: Please select a topic from the following list: [history, science, hiphop, other] based on the question provided by the user. You are only allowed to say the topic name, nothing else. user: How do we measure the distance between stars?</td>
</tr>
<tr class="even">
<td id="T_c8b13_row1_col0" class="data row1 col0">Who are the most well known rappers?</td>
<td id="T_c8b13_row1_col1" class="data row1 col1">system: Please select a topic from the following list: [history, science, hiphop, other] based on the question provided by the user. You are only allowed to say the topic name, nothing else. user: Who are the most well known rappers?</td>
</tr>
<tr class="odd">
<td id="T_c8b13_row2_col0" class="data row2 col0">Who won the civil war?</td>
<td id="T_c8b13_row2_col1" class="data row2 col1">system: Please select a topic from the following list: [history, science, hiphop, other] based on the question provided by the user. You are only allowed to say the topic name, nothing else. user: Who won the civil war?</td>
</tr>
</tbody>
</table>


<script type="module">
    const { DataTable, jQuery: $ } = await import(window._datatables_src_for_itables_2_1_4);

    document.querySelectorAll("#T_c8b13:not(.dataTable)").forEach(table => {
        // Define the table data
        

        // Define the dt_args
        let dt_args = {"columnDefs": [{"targets": ["q", "p"], "render": function(data, type, row) {
                    return '<div style="white-space: normal; word-wrap: break-word;">' + data + '</div>';
                }, "width": "300px"}], "escape": true, "layout": {"topStart": null, "topEnd": null, "bottomStart": null, "bottomEnd": null}, "display_logo_when_loading": true, "order": []};
        

        
        new DataTable(table, dt_args);
    });
</script>
</div>
<div class="cell-output cell-output-display">
<pre><code>'?TopicSelection(q,t)'</code></pre>
</div>
<div class="cell-output cell-output-display">
<style type="text/css">
#T_d19b1_row0_col0, #T_d19b1_row0_col1, #T_d19b1_row1_col0, #T_d19b1_row1_col1, #T_d19b1_row2_col0, #T_d19b1_row2_col1 {
  overflow-wrap: break-word;
  max-width: 800px;
  text-align: left;
}
</style>

<table id="T_d19b1" class="display nowrap caption-top table table-sm table-striped small" data-quarto-postprocess="true">
<thead>
<tr class="header">
<th id="T_d19b1_level0_col0" class="col_heading level0 col0" data-quarto-table-cell-role="th">q</th>
<th id="T_d19b1_level0_col1" class="col_heading level0 col1" data-quarto-table-cell-role="th">t</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td id="T_d19b1_row0_col0" class="data row0 col0">How do we measure the distance between stars?</td>
<td id="T_d19b1_row0_col1" class="data row0 col1">science</td>
</tr>
<tr class="even">
<td id="T_d19b1_row1_col0" class="data row1 col0">Who are the most well known rappers?</td>
<td id="T_d19b1_row1_col1" class="data row1 col1">hiphop</td>
</tr>
<tr class="odd">
<td id="T_d19b1_row2_col0" class="data row2 col0">Who won the civil war?</td>
<td id="T_d19b1_row2_col1" class="data row2 col1">history</td>
</tr>
</tbody>
</table>


<script type="module">
    const { DataTable, jQuery: $ } = await import(window._datatables_src_for_itables_2_1_4);

    document.querySelectorAll("#T_d19b1:not(.dataTable)").forEach(table => {
        // Define the table data
        

        // Define the dt_args
        let dt_args = {"columnDefs": [{"targets": ["q", "t"], "render": function(data, type, row) {
                    return '<div style="white-space: normal; word-wrap: break-word;">' + data + '</div>';
                }, "width": "300px"}], "escape": true, "layout": {"topStart": null, "topEnd": null, "bottomStart": null, "bottomEnd": null}, "display_logo_when_loading": true, "order": []};
        

        
        new DataTable(table, dt_args);
    });
</script>
</div>
</div>
</section>
<section id="executing-our-agent-and-returning-the-results-to-python" class="level3">
<h3 class="anchored" data-anchor-id="executing-our-agent-and-returning-the-results-to-python">Executing our agent and returning the results to python</h3>
<div id="cell-75" class="cell">
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a>completions <span class="op">=</span> sess.export(<span class="st">'?Style_Based_QA(question,topic,user,prompt,answer)'</span>)</span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a>completions</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">question</th>
<th data-quarto-table-cell-role="th">topic</th>
<th data-quarto-table-cell-role="th">user</th>
<th data-quarto-table-cell-role="th">prompt</th>
<th data-quarto-table-cell-role="th">answer</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>How do we measure the distance between stars?</td>
<td>science</td>
<td>Bob</td>
<td>system: Answer the question of the user in th...</td>
<td>The distance between stars is measured in astr...</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>How do we measure the distance between stars?</td>
<td>science</td>
<td>Joe</td>
<td>system: Answer the question of the user in th...</td>
<td>- To measure the distance between stars, astro...</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>How do we measure the distance between stars?</td>
<td>science</td>
<td>Sally</td>
<td>system: Answer the question of the user in th...</td>
<td>To measure the distance between stars, astrono...</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>Who are the most well known rappers?</td>
<td>hiphop</td>
<td>Bob</td>
<td>system: Answer the question of the user in th...</td>
<td>Straight outta Compton, a city so gritty, Let ...</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>Who are the most well known rappers?</td>
<td>hiphop</td>
<td>Joe</td>
<td>system: Answer the question of the user in th...</td>
<td>Yo, when it comes to rappers, there's a whole ...</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">5</td>
<td>Who are the most well known rappers?</td>
<td>hiphop</td>
<td>Sally</td>
<td>system: Answer the question of the user in th...</td>
<td>Yo, when it comes to rappers, there's a whole ...</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">6</td>
<td>Who won the civil war?</td>
<td>history</td>
<td>Bob</td>
<td>system: Answer the question of the user in th...</td>
<td>In sooth, fair user, the tale of the Civil War...</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">7</td>
<td>Who won the civil war?</td>
<td>history</td>
<td>Joe</td>
<td>system: Answer the question of the user in th...</td>
<td>- The Civil War, dear user, was a bloody confl...</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">8</td>
<td>Who won the civil war?</td>
<td>history</td>
<td>Sally</td>
<td>system: Answer the question of the user in th...</td>
<td>In sooth, good sir, the tale of the Civil War ...</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>And as you can see, we have our agent running.</p>
<div id="cell-77" class="cell">
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (question,topic,user,prompt,answer) <span class="kw">in</span> completions.itertuples(name<span class="op">=</span><span class="va">None</span>, index<span class="op">=</span><span class="va">False</span>):</span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span>user<span class="sc">}</span><span class="ss">: </span><span class="sc">{</span>question<span class="sc">}</span><span class="ch">\n</span><span class="ss">assistant: </span><span class="sc">{</span>answer<span class="sc">}</span><span class="ch">\n\n</span><span class="ss">"</span>)</span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"="</span><span class="op">*</span><span class="dv">80</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Bob: How do we measure the distance between stars?
assistant: The distance between stars is measured in astronomical units (AU), parsecs (pc), or light-years (ly). 

1. **Astronomical Unit (AU)**: An AU is the average distance between the Earth and the Sun, which is approximately 93 million miles or 150 million kilometers. It is more commonly used to measure distances within our solar system.

2. **Parsec (pc)**: A parsec is a unit of distance used in astronomy, defined as the distance at which an object would have a parallax angle of one arcsecond. One parsec is equal to about 3.26 light-years or 3.09 x 10^13 kilometers.

3. **Light-year (ly)**: A light-year is the distance that light travels in one year, which is approximately 9.46 trillion kilometers or about 5.88 trillion miles.

To measure the distance to a star, astronomers use methods such as parallax and spectroscopic parallax. Parallax involves measuring the apparent shift of a star against its background as the Earth orbits the Sun. Spectroscopic parallax measures the star's luminosity and temperature to determine its distance.

In summary, the distance between stars is measured in AU, parsecs, or light-years, using methods such as parallax and spectroscopic techniques.

References:
- "Astronomical Unit." NASA, https://solarsystem.nasa.gov/asteroids-comets-and-meteors/comets/overview/. Accessed 15 Dec. 2022.
- "Parsec." European Southern Observatory, https://www.eso.org/public/usa/. Accessed 15 Dec. 2022.
- "Light-Year." European Southern Observatory, https://www.eso.org/public/usa/. Accessed 15 Dec. 2022.


================================================================================
Joe: How do we measure the distance between stars?
assistant: - To measure the distance between stars, astronomers use a method called parallax, which is based on trigonometry.
- Parallax involves observing a star from two different points in Earth's orbit and measuring the angle between the star and distant background stars. 
- By knowing the distance between the two observation points (Earth's orbit), the angle of parallax, and some basic trigonometry, astronomers can calculate the distance to the star. 
- The formula used is d = 1 / tan(p), where d is the distance to the star in parsecs and p is the parallax angle in arcseconds.
- By measuring the parallax angle with precision instruments, astronomers can determine the distance to stars within a certain range of accuracy.


================================================================================
Sally: How do we measure the distance between stars?
assistant: To measure the distance between stars, astronomers use a method called parallax. Parallax is the apparent shift in the position of an object when viewed from different angles. With parallax, astronomers measure the angle subtended by the star's position at different points in the Earth's orbit. The distance to the star can be calculated using the formula:

\[ D = \frac{1}{\text{parallax angle}} \]

where \( D \) is the distance to the star. The parallax angle is usually measured in arcseconds. The smaller the parallax angle, the greater the distance to the star. This method allows astronomers to measure distances to nearby stars accurately.


================================================================================
Bob: Who are the most well known rappers?
assistant: Straight outta Compton, a city so gritty,
Let me tell you about the rappers who made it to the top, no pity.
From the East Coast to the West, they've all left a mark,
Icons like Tupac, Biggie, and Jay-Z, they're the ones that spark.

Other legends include Eminem, with his lyrical prowess,
And Kanye West, pushing boundaries, never settling for less.
We can't forget about the women who've paved the way,
Nicki Minaj, Cardi B, Queen Latifah, they slay.

But the rap game is vast, with talents galore,
From Kendrick Lamar to Lil Wayne, they all score.
So if you're looking for names that shine bright,
These rappers will definitely be in sight.

References:
1. Tupac Shakur - Biography. (n.d.). Retrieved from https://www.biography.com/musician/tupac-shakur
2. The Notorious B.I.G. - Biography. (n.d.). Retrieved from https://www.biography.com/musician/the-notorious-big
3. Jay-Z - Biography. (n.d.). Retrieved from https://www.biography.com/musician/jay-z
4. Eminem - Biography. (n.d.). Retrieved from https://www.biography.com/musician/eminem
5. Kanye West - Biography. (n.d.). Retrieved from https://www.biography.com/musician/kanye-west
6. Nicki Minaj - Biography. (n.d.). Retrieved from https://www.biography.com/musician/nicki-minaj


================================================================================
Joe: Who are the most well known rappers?
assistant: Yo, when it comes to rappers, there's a whole crew,
Here are some of the most well-known for you:

- Eminem: Known for his lyrical genius and raw talent
- Jay-Z: Business mogul and rap legend with a smooth flow
- Tupac Shakur: Iconic figure known for his powerful lyrics and impact on the industry
- Notorious B.I.G: Legendary rapper with a unique flow and storytelling abilities
- Kendrick Lamar: Modern-day artist known for his socially conscious lyrics and innovative sound
- Drake: Chart-topping artist with a versatile style and massive commercial success
- Kanye West: Controversial figure known for pushing boundaries and redefining the genre


================================================================================
Sally: Who are the most well known rappers?
assistant: Yo, when it comes to rappers, there's a whole lot in the game,
From OGs like Tupac and Biggie, to new stars on their rise to fame.
Eminem's known for his lyrical prowess and flow,
While Jay-Z's the blueprint for success, yo.

Drake stays topping charts with hits in every season,
And Kendrick Lamar speaks truth, his words have reason.
Don't forget about Cardi B, the queen of the Bronx,
And Nicki Minaj, always bringing heat, never clocks.

These are just a few of the names in the scene,
But there's plenty more with rhymes so mean.
So if you're looking to vibe to some sick beats,
Check out these rappers and feel their heat.


================================================================================
Bob: Who won the civil war?
assistant: In sooth, fair user, the tale of the Civil War is a tumultuous one, with many a battle fought and blood shed ere the ultimate victor emerged. Verily, the conflict betwixt the noble Union forces and the valiant Confederate army didst rage for four long years, from the year of our Lord 1861 to 1865.

'Twas in the year of 1865, that the scales of fortune didst tip in favor of the Union, under the gallant leadership of General Ulysses S. Grant. The Confederate forces, led by General Robert E. Lee, didst valiantly defend their cause, but in the end, they couldst not withstand the might of the Union army.

Thus, with the surrender of General Lee at Appomattox Court House on April 9, 1865, the noble Union forces emerged victorious in this bitter conflict. The unity of the nation was preserved, and the scourge of slavery was banished from the land.

So, dear user, it canst be said that the Civil War was won by the Union forces, securing the future of a united and free America.

References:
1. McPherson, James M. "Battle Cry of Freedom: The Civil War Era." Oxford University Press, 1988.
2. Foote, Shelby. "The Civil War: A Narrative." Vintage Books, 1986.


================================================================================
Joe: Who won the civil war?
assistant: - The Civil War, dear user, was a bloody conflict
- In this great struggle, Armies clashed and did afflict
- 'Twas the blue-clad Union and the gray Confederate band
- Seeking victory and power over this vast land
  
- As the years dragged on, battles were fiercely fought
- From Gettysburg to Antietam, each victory dearly bought
- But in the end, the Union did prevail
- And the Confederacy's hopes did in sorrow pale
  
- Abraham Lincoln, the great President of the North
- Led his people through this war, showing his worth
- With Grant and Sherman by his side
- They turned the tide, their foes to chide
  
- So it was the Union, with its starry flag unfurled
- Who emerged victorious, in this tumultuous world
- The Confederacy, defeated and forlorn
- Surrendered at Appomattox, their dreams torn
  
- And so, dear user, the answer is clear
- The Union won the Civil War, without fear
- But the scars of this conflict still remain
- In the history of our nation, causing lasting pain


================================================================================
Sally: Who won the civil war?
assistant: In sooth, good sir, the tale of the Civil War is a tragic and tumultuous one, fraught with strife and sorrow. 'Twas a conflict of great import that pitted brother against brother and father against son, tearing asunder the very fabric of our nation.

As for the victors of this bloody conflict, it was the Union forces led by General Ulysses S. Grant who emerged triumphant over the Confederate army under General Robert E. Lee. 'Twas in the spring of 1865, at the Battle of Appomattox Court House, that General Lee surrendered his sword to General Grant, marking the end of the war and the preservation of the Union.

'Tis a tale of great tragedy and triumph, of sacrifice and suffering, but in the end, the Union was preserved and the promise of liberty and equality for all was upheld. Let us not forget the lessons learned from this dark chapter in our nation's history, and let us strive to heal the wounds of the past and work towards a brighter future for all.


================================================================================</code></pre>
</div>
</div>


</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp("https:\/\/DeanLight\.github\.io\/spannerlib");
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




<footer class="footer"><div class="nav-footer"><div class="nav-footer-center"><div class="toc-actions d-sm-block d-md-none"><ul><li><a href="https://github.com/DeanLight/spannerlib/issues/new" class="toc-action"><i class="bi bi-github"></i>Report an issue</a></li></ul></div></div></div></footer></body></html>