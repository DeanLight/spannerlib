<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.6.39">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Rewriting a real code base – Spannerlib</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script><script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<script src="../site_libs/quarto-html/quarto.js"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting-e26003cea8cd680ca0c55a263523d882.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap-b6f35d3e5f7cf9e5d8c19bd4060a2618.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" integrity="sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==" crossorigin="anonymous"></script>

<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>


<link rel="stylesheet" href="../styles.css">
<meta property="og:title" content="Rewriting a real code base – Spannerlib">
<meta property="og:description" content="work bench">
<meta property="og:image" content="https://DeanLight.github.io/spannerlib/tutorials/covid_data/conceptual_diagram.svg">
<meta property="og:site_name" content="Spannerlib">
<meta property="og:image:alt" content="drawing">
<meta name="twitter:title" content="Rewriting a real code base – Spannerlib">
<meta name="twitter:description" content="work bench">
<meta name="twitter:image" content="https://DeanLight.github.io/spannerlib/tutorials/covid_data/conceptual_diagram.svg">
<meta name="twitter:image:alt" content="drawing">
<meta name="twitter:card" content="summary_large_image">
</head>

<body class="nav-sidebar docked nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="../index.html">
    <span class="navbar-title">Spannerlib</span>
    </a>
  </div>
        <div class="quarto-navbar-tools tools-end">
</div>
          <div id="quarto-search" class="" title="Search"></div>
      </div> <!-- /container-fluid -->
    </nav>
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../tutorials/introduction.html">Tutorials</a></li><li class="breadcrumb-item"><a href="../tutorials/rewriting_a_real_codebase.html">Rewriting a real codebase</a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="Search" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation docked overflow-auto">
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Welcome to Spannerlib</span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true">
 <span class="menu-text">Tutorials</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../tutorials/introduction.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Intro</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../tutorials/basic_tasks.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Basic Examples</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../tutorials/llm_code_documentation_example.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Copilot Agent</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../tutorials/extending_code.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Extending Code</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../tutorials/rewriting_a_real_codebase.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text">Rewriting a real codebase</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="true">
 <span class="menu-text">Callbacks</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../callbacks/basic_ies.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Basic Callbacks</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../callbacks/json_path.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">JsonPath</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../session.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">The Session Object</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../reference.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Reference</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../inspecting_query_plans.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">View Query Plan</span></a>
  </div>
</li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#tutorial-introduction" id="toc-tutorial-introduction" class="nav-link active" data-scroll-target="#tutorial-introduction">Tutorial Introduction:</a></li>
  <li><a href="#tldr" id="toc-tldr" class="nav-link" data-scroll-target="#tldr">TLDR</a></li>
  <li><a href="#walkthrough" id="toc-walkthrough" class="nav-link" data-scroll-target="#walkthrough">Walkthrough</a>
  <ul class="collapse">
  <li><a href="#problem-definition" id="toc-problem-definition" class="nav-link" data-scroll-target="#problem-definition">Problem definition</a></li>
  <li><a href="#structure-of-the-original-implemenation" id="toc-structure-of-the-original-implemenation" class="nav-link" data-scroll-target="#structure-of-the-original-implemenation">Structure of the original implemenation</a></li>
  <li><a href="#why-we-chose-this-use-case" id="toc-why-we-chose-this-use-case" class="nav-link" data-scroll-target="#why-we-chose-this-use-case">Why we chose this use-case</a></li>
  </ul></li>
  <li><a href="#deepdive-on-the-original-implementation" id="toc-deepdive-on-the-original-implementation" class="nav-link" data-scroll-target="#deepdive-on-the-original-implementation">Deepdive on the original implementation:</a>
  <ul class="collapse">
  <li><a href="#concept-tagger" id="toc-concept-tagger" class="nav-link" data-scroll-target="#concept-tagger">Concept Tagger</a></li>
  <li><a href="#target-matcher" id="toc-target-matcher" class="nav-link" data-scroll-target="#target-matcher">Target Matcher</a></li>
  <li><a href="#sectionizer" id="toc-sectionizer" class="nav-link" data-scroll-target="#sectionizer">Sectionizer</a></li>
  <li><a href="#context" id="toc-context" class="nav-link" data-scroll-target="#context">Context</a></li>
  <li><a href="#postproccessor" id="toc-postproccessor" class="nav-link" data-scroll-target="#postproccessor">PostProccessor</a></li>
  <li><a href="#document-classifier" id="toc-document-classifier" class="nav-link" data-scroll-target="#document-classifier">Document classifier</a></li>
  <li><a href="#additional-code" id="toc-additional-code" class="nav-link" data-scroll-target="#additional-code">Additional code</a></li>
  <li><a href="#lines-of-code-overview" id="toc-lines-of-code-overview" class="nav-link" data-scroll-target="#lines-of-code-overview">Lines of Code overview</a></li>
  </ul></li>
  <li><a href="#rules-for-our-implemenation-and-notes-on-line-of-code-comparisons" id="toc-rules-for-our-implemenation-and-notes-on-line-of-code-comparisons" class="nav-link" data-scroll-target="#rules-for-our-implemenation-and-notes-on-line-of-code-comparisons">Rules for our implemenation and notes on line of code comparisons</a></li>
  <li><a href="#our-implementation-step-by-step-implementation" id="toc-our-implementation-step-by-step-implementation" class="nav-link" data-scroll-target="#our-implementation-step-by-step-implementation">Our implementation, step by step implementation</a>
  <ul class="collapse">
  <li><a href="#deciding-scope-of-spannerlib-code" id="toc-deciding-scope-of-spannerlib-code" class="nav-link" data-scroll-target="#deciding-scope-of-spannerlib-code">Deciding Scope of spannerlib code</a></li>
  <li><a href="#defining-our-ie-functions" id="toc-defining-our-ie-functions" class="nav-link" data-scroll-target="#defining-our-ie-functions">Defining our ie functions</a></li>
  <li><a href="#data-modelling" id="toc-data-modelling" class="nav-link" data-scroll-target="#data-modelling">Data Modelling</a></li>
  <li><a href="#a-detour-into-text-rewrtting" id="toc-a-detour-into-text-rewrtting" class="nav-link" data-scroll-target="#a-detour-into-text-rewrtting">A detour into text rewrtting</a></li>
  <li><a href="#resuming-data-modelling" id="toc-resuming-data-modelling" class="nav-link" data-scroll-target="#resuming-data-modelling">Resuming data modelling</a></li>
  <li><a href="#preparing-the-input" id="toc-preparing-the-input" class="nav-link" data-scroll-target="#preparing-the-input">Preparing the input</a></li>
  <li><a href="#rewriting-texts-based-on-tags" id="toc-rewriting-texts-based-on-tags" class="nav-link" data-scroll-target="#rewriting-texts-based-on-tags">Rewriting texts based on tags</a></li>
  <li><a href="#splitting-text-by-sentence-and-section" id="toc-splitting-text-by-sentence-and-section" class="nav-link" data-scroll-target="#splitting-text-by-sentence-and-section">Splitting text by sentence and section</a></li>
  <li><a href="#tagging-covid-mentions" id="toc-tagging-covid-mentions" class="nav-link" data-scroll-target="#tagging-covid-mentions">Tagging Covid Mentions</a></li>
  <li><a href="#document-classificaiton" id="toc-document-classificaiton" class="nav-link" data-scroll-target="#document-classificaiton">Document Classificaiton</a></li>
  </ul></li>
  <li><a href="#end-to-end-implementation" id="toc-end-to-end-implementation" class="nav-link" data-scroll-target="#end-to-end-implementation">End to End implementation</a>
  <ul class="collapse">
  <li><a href="#imports-and-configurations" id="toc-imports-and-configurations" class="nav-link" data-scroll-target="#imports-and-configurations">imports and configurations</a></li>
  <li><a href="#spannerlog-code" id="toc-spannerlog-code" class="nav-link" data-scroll-target="#spannerlog-code">Spannerlog Code</a></li>
  <li><a href="#ie-and-agg-functions" id="toc-ie-and-agg-functions" class="nav-link" data-scroll-target="#ie-and-agg-functions">IE and Agg functions:</a></li>
  <li><a href="#regular-python-utilities" id="toc-regular-python-utilities" class="nav-link" data-scroll-target="#regular-python-utilities">Regular python utilities</a></li>
  <li><a href="#main-pipeline" id="toc-main-pipeline" class="nav-link" data-scroll-target="#main-pipeline">Main pipeline</a></li>
  </ul></li>
  <li><a href="#code-comparison" id="toc-code-comparison" class="nav-link" data-scroll-target="#code-comparison">Code comparison</a>
  <ul class="collapse">
  <li><a href="#lines-of-code" id="toc-lines-of-code" class="nav-link" data-scroll-target="#lines-of-code">Lines of code</a></li>
  <li><a href="#software-engineering-perspective" id="toc-software-engineering-perspective" class="nav-link" data-scroll-target="#software-engineering-perspective">Software engineering perspective</a></li>
  <li><a href="#but-how-much-of-this-is-really-new" id="toc-but-how-much-of-this-is-really-new" class="nav-link" data-scroll-target="#but-how-much-of-this-is-really-new">But how much of this is really new?</a></li>
  </ul></li>
  </ul>
<div class="toc-actions"><ul><li><a href="https://github.com/DeanLight/spannerlib/issues/new" class="toc-action"><i class="bi bi-github"></i>Report an issue</a></li></ul></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default"><nav class="quarto-page-breadcrumbs quarto-title-breadcrumbs d-none d-lg-block" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../tutorials/introduction.html">Tutorials</a></li><li class="breadcrumb-item"><a href="../tutorials/rewriting_a_real_codebase.html">Rewriting a real codebase</a></li></ol></nav>
<div class="quarto-title">
<h1 class="title">Rewriting a real code base</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<!-- WARNING: THIS FILE WAS AUTOGENERATED! DO NOT EDIT! -->
<section id="tutorial-introduction" class="level2">
<h2 class="anchored" data-anchor-id="tutorial-introduction">Tutorial Introduction:</h2>
<p>In this tutorial, we will guide you through the process of refactoring an existing data pipeline into the spannerlib framework, showing the utility of this approach from a software engineering perspective. We will:</p>
<ul>
<li>Give an overview of the original implementation</li>
<li>Discuss the use case we chose this use case</li>
<li>Show how to analyze which parts of a python codebase should turn into one of the following modalities:
<ul>
<li>Relational Data</li>
<li>Declarative Code</li>
<li>IE functions (and Aggregation functions)</li>
<li>Regular python code along side spannerlib</li>
</ul></li>
<li>Demonstrate a rewriting of the use-case into spannerlib</li>
<li>Compare between the original and the spannerlib implementations along the following metrics
<ul>
<li>lines of code per modality</li>
<li>Decomposition</li>
<li>Separation of concerns</li>
<li>Bug surface area</li>
<li>Readability</li>
<li>and Debug-ability</li>
<li>barriers of entry</li>
</ul></li>
</ul>
<p>We’ve chosen to adapt a medical text classification NLP pipeline, specifically dealing with classifying COVID-19 status from medical transcripts,from the paper <a href="https://aclanthology.org/2020.nlpcovid19-acl.10.pdf">“A Natural Language Processing System for National COVID-19 Surveillance in the US Department of Veterans Affairs”</a> which was published in the <a href="https://aclanthology.org/volumes/2020.nlpcovid19-acl/">Proceedings of the 1st Workshop on NLP for COVID-19 at ACL 2020</a>. Code for the original implementation is available <a href="https://github.com/abchapman93/VA_COVID-19_NLP_BSV/tree/master">here</a>.</p>
</section>
<section id="tldr" class="level2">
<h2 class="anchored" data-anchor-id="tldr">TLDR</h2>
<p>Here is a summary of the lines of code of the original and the spannerlib implementations:</p>
<table class="caption-top table">
<colgroup>
<col style="width: 23%">
<col style="width: 17%">
<col style="width: 15%">
<col style="width: 18%">
<col style="width: 24%">
</colgroup>
<thead>
<tr class="header">
<th>Code Type</th>
<th>Complexity</th>
<th>Original</th>
<th>Spannerlib</th>
<th>line code saved</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Data as Code</td>
<td>Medium-Low</td>
<td>3903</td>
<td>0</td>
<td>~90%</td>
</tr>
<tr class="even">
<td>Data</td>
<td>Low</td>
<td></td>
<td>378</td>
<td></td>
</tr>
<tr class="odd">
<td>Vanilla python</td>
<td>High</td>
<td>639</td>
<td>118</td>
<td>~53%</td>
</tr>
<tr class="even">
<td>Callbacks</td>
<td>Medium</td>
<td></td>
<td>76</td>
<td></td>
</tr>
<tr class="odd">
<td>Spannerlog</td>
<td>Medium</td>
<td></td>
<td>79</td>
<td></td>
</tr>
<tr class="even">
<td><strong>Total</strong></td>
<td></td>
<td><strong>4542</strong></td>
<td><strong>651</strong></td>
<td><strong>~85%</strong></td>
</tr>
</tbody>
</table>
<p>But why does this work?</p>
<p><img src="covid_data/conceptual_diagram.svg" alt="drawing" style="width:500px;"></p>
<p>The reason our approach works is that not all code, and not all python code is born the same. In a python code base, nearby code chunks can do very different things, ie: * configuration * data management * pipeline composition * etc</p>
<p>The reason that spannerlib can help improve code bases is that it forces the user to explicitly decompose the different code types, and for many of them, it provides a programming modality that is more suited for the code base.</p>
<p>The most noteable examples are: * that we can express our compositional logic via Spannerlog * We can seperate core computations from state management * we can delegate State and Data Management to a relational DB</p>
<p>This paradigm forces as to enforce best practices on our code, and turbo charges different modalities with programming languages/paradigms that are well suited to them.</p>
</section>
<section id="walkthrough" class="level2">
<h2 class="anchored" data-anchor-id="walkthrough">Walkthrough</h2>
<section id="problem-definition" class="level3">
<h3 class="anchored" data-anchor-id="problem-definition">Problem definition</h3>
<p>Given:</p>
<ul>
<li>A collection of medical documents</li>
</ul>
<p>Classify each document to one of three classes:</p>
<ul>
<li><code>POS</code>/<code>NEG</code>/<code>UNK</code></li>
<li>According to whether the document describes the patient as having/not having/neither covid-19.</li>
</ul>
</section>
<section id="structure-of-the-original-implemenation" class="level3">
<h3 class="anchored" data-anchor-id="structure-of-the-original-implemenation">Structure of the original implemenation</h3>
<p>The pipeline was implemented using the [spacy] and [medspacy] frameworks, which are libraries build for rule base NLP pipelines. The original pipeline is split into 6 main components:</p>
<ul>
<li>concept tagger:
<ul>
<li>Assigns a semantic tags to each Token based on textual patterns that involve regex like patterns, over regular text, POS tags and lemmas.</li>
</ul></li>
<li>target matcher:
<ul>
<li>Assigns higher level tags to entities and covid 19 mentions based on patterns over the semantic tags from the previous versions</li>
</ul></li>
<li>sectionizer:
<ul>
<li>Segments the text into different sections found commonly in medical report, and differentiate between relevant and non relevant sections</li>
</ul></li>
<li>context:
<ul>
<li>modifies semantic attributes of entities and covid 19 such as positive status, negation, reference to entities which are not the patient etc</li>
<li>these modification depends on
<ul>
<li>patterns over text and semantic tags found in the same sentence as the entitiy</li>
<li>the sections that the entity is in</li>
</ul></li>
</ul></li>
<li>postprocessor:
<ul>
<li>Another phase of entity tag modification which was added later on</li>
<li>Modifications depend on either
<ul>
<li>patterns found in the next sentence after the entity</li>
<li>patterns found on entities which already have specific tags</li>
</ul></li>
</ul></li>
<li>document classifier:
<ul>
<li>assigning each covid mention a classification based on it’s associated tags</li>
<li>assigning each document a label of “POS”, “UNK”, or “NEG” based on the tags of the covid-19 mentions within it.</li>
</ul></li>
</ul>
<p>We will explain about each stage in more details, including code snippets later on.</p>
</section>
<section id="why-we-chose-this-use-case" class="level3">
<h3 class="anchored" data-anchor-id="why-we-chose-this-use-case">Why we chose this use-case</h3>
<p>We are interested in giving a fair comparison between a real world NLP pipeline and our approach. This paper represents a real world NLP usecase in the pre-LLM era, which demonstrates how to combine NLP models and business logic via rules. The Code is ~4000 lines of code which is big enough to not be considered a toy example, but is small enough to allow us to present it’s decomposition in a timely fashion.</p>
<p>Moreover, most of the orchestration logic in this pipeline is done using spacy’s compositional SDK. This means that we do not compare ourselves to control flow written in vanilla python, which might be an easy goal to beat, but rather a compositional SDK that is well tuned to this task, making our proof of burden harder. While the usage of a compositional SDK, as opposed to vanilla python in the original implementation, makes the original implementation shorter than it would otherwise have been, most pipeline libraries have a relatively high barrier of entry, and require the user to learn multiple interfaces and classes that are unique to that library.</p>
<p>This tradeoff elucidates the power and elegance of spannerlib’s use of the relational model explicitly for data modelling. If indeed our implementation will be shorter and simpler, while avoiding the need to learn abstractions found in current compositional libraries, this will mean that our approach sits closer to the pareto frontier on the tradeoff between conciseness and entry barriers.</p>
<p>Finally, not all operations in this pipeline can be modelled as IE function and declarative code. Rather than choosing an example that neatly fits our paradigm, we showcase how regular python code can interplay with spannerlib code when only part of a codebase is suitable to refactoring.</p>
</section>
</section>
<section id="deepdive-on-the-original-implementation" class="level2">
<h2 class="anchored" data-anchor-id="deepdive-on-the-original-implementation">Deepdive on the original implementation:</h2>
<section id="concept-tagger" class="level3">
<h3 class="anchored" data-anchor-id="concept-tagger">Concept Tagger</h3>
<p>The concept tagger module defines a collection of rules that can be used to tag certain tokens in the text. A basic rule looks like</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co"># a basic pattern rule</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>TargetRule( literal<span class="op">=</span><span class="st">"coronavirus"</span>, category<span class="op">=</span><span class="st">"COVID-19"</span>, pattern<span class="op">=</span>[{<span class="st">"LOWER"</span>: {<span class="st">"REGEX"</span>: <span class="st">"coronavirus|hcov|ncov$"</span>}}], )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Where <code>TargetRule</code> is a medspacy class which maps a given pattern to a tag (ie <code>COVID-19</code>)</p>
<p>The Target pattern belongs to a spacy specific pattern language, which may include lemma tags, POS tags, group membership and more, and has a non neglible learning cost.</p>
<p>Here are some examples of rules that use Lemmas and POS in them:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co"># using lemma and group membership</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>TargetRule(</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>        <span class="st">"results positive"</span>,</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>        <span class="st">"positive"</span>,</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>        pattern<span class="op">=</span>[</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>            {<span class="st">"LOWER"</span>: <span class="st">"results"</span>},</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>            {<span class="st">"LEMMA"</span>: <span class="st">"be"</span>, <span class="st">"OP"</span>: <span class="st">"?"</span>},</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>            {<span class="st">"LOWER"</span>: {<span class="st">"IN"</span>: [<span class="st">"pos"</span>, <span class="st">"positive"</span>]}},</span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>        ],</span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a><span class="co"># using POS and group membership</span></span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a>TargetRule(</span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a>        <span class="st">"other experiencer"</span>,</span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a>        category<span class="op">=</span><span class="st">"other_experiencer"</span>,</span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a>        pattern<span class="op">=</span>[</span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a>            {</span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a>                <span class="st">"POS"</span>: {<span class="st">"IN"</span>: [<span class="st">"NOUN"</span>, <span class="st">"PROPN"</span>, <span class="st">"PRON"</span>, <span class="st">"ADJ"</span>]},</span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a>                <span class="st">"LOWER"</span>: {</span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a>                    <span class="st">"IN"</span>: [</span>
<span id="cb2-21"><a href="#cb2-21" aria-hidden="true" tabindex="-1"></a>                        <span class="st">"someone"</span>,</span>
<span id="cb2-22"><a href="#cb2-22" aria-hidden="true" tabindex="-1"></a>                        <span class="st">"somebody"</span>,</span>
<span id="cb2-23"><a href="#cb2-23" aria-hidden="true" tabindex="-1"></a>                        <span class="st">"person"</span>,</span>
<span id="cb2-24"><a href="#cb2-24" aria-hidden="true" tabindex="-1"></a>                        <span class="st">"anyone"</span>,</span>
<span id="cb2-25"><a href="#cb2-25" aria-hidden="true" tabindex="-1"></a>                        <span class="st">"anybody"</span>,</span>
<span id="cb2-26"><a href="#cb2-26" aria-hidden="true" tabindex="-1"></a>                    ]</span>
<span id="cb2-27"><a href="#cb2-27" aria-hidden="true" tabindex="-1"></a>                },</span>
<span id="cb2-28"><a href="#cb2-28" aria-hidden="true" tabindex="-1"></a>            }</span>
<span id="cb2-29"><a href="#cb2-29" aria-hidden="true" tabindex="-1"></a>        ],</span>
<span id="cb2-30"><a href="#cb2-30" aria-hidden="true" tabindex="-1"></a>    ),</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Thi module contains ~327 lines of code which comprise of only dict of the form <code>{tag:[TargetRule]}</code>.</p>
</section>
<section id="target-matcher" class="level3">
<h3 class="anchored" data-anchor-id="target-matcher">Target Matcher</h3>
<p>The Targer Matcher module defines a collection of target rules that also use the tags defined in the previous module. These 2 modules are seperated since they must run sequentially, unlike rules in each module, which can run in parallel. They use the same <code>TargetRule</code>. For example:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co"># uses the concept tags 'positive' and 'COVID-19' from the concept tagger</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>TargetRule(</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>            <span class="st">"&lt;POSITIVE&gt; &lt;COVID-19&gt; unit"</span>,</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>            <span class="st">"COVID-19"</span>,</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>            pattern<span class="op">=</span>[</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>                {<span class="st">"_"</span>: {<span class="st">"concept_tag"</span>: <span class="st">"positive"</span>}, <span class="st">"OP"</span>: <span class="st">"+"</span>},</span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>                {<span class="st">"_"</span>: {<span class="st">"concept_tag"</span>: <span class="st">"COVID-19"</span>}, <span class="st">"OP"</span>: <span class="st">"+"</span>},</span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>                {<span class="st">"LOWER"</span>: {<span class="st">"IN"</span>: [<span class="st">"unit"</span>, <span class="st">"floor"</span>]}},</span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>            ],</span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>        )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>This module contains ~726 lines of code with the same form as the concept matcher <code>{tag:[TargetRule]}</code>.</p>
</section>
<section id="sectionizer" class="level3">
<h3 class="anchored" data-anchor-id="sectionizer">Sectionizer</h3>
<p>The Sectionizer module contains a list of <code>SectionRule</code> classes which outline which text literals should be taken as starting tokens for a new section. They are used by spacy’s pipeline SDK to seperate the documents into different sections and subsequently work on the sections separately. For example:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co"># section rules that describe possible starting tokens for the imaging sections</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>    SectionRule(category<span class="op">=</span><span class="st">"imaging"</span>, literal<span class="op">=</span><span class="st">"IMAGING:"</span>),</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>    SectionRule(category<span class="op">=</span><span class="st">"imaging"</span>, literal<span class="op">=</span><span class="st">"INTERPRETATION:"</span>),</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>    SectionRule(category<span class="op">=</span><span class="st">"imaging"</span>, literal<span class="op">=</span><span class="st">"Imaging:"</span>),</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>    SectionRule(category<span class="op">=</span><span class="st">"imaging"</span>, literal<span class="op">=</span><span class="st">"MRI:"</span>),</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>    SectionRule(category<span class="op">=</span><span class="st">"imaging"</span>, literal<span class="op">=</span><span class="st">"Radiology:"</span>),</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>This module contains ~116 lines of code which are just a list of <code>SectionRule</code>s.</p>
</section>
<section id="context" class="level3">
<h3 class="anchored" data-anchor-id="context">Context</h3>
<p>The context module is in charge of adding tags to entities, depending on what other patterns are found in the same sentence as the covid match. This id done by defining a list of <code>ConTextRule</code> classes which outline which pattern to look for, around which existing tags. For example, bellow is a rule that looks for covid mentions that are preceded in the same sentence by “not detected”. And in such cases adds the tag <code>NEGATED_EXISTENCE</code> to the mention.</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>ConTextRule(</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>    literal<span class="op">=</span><span class="st">"Not Detected"</span>,</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>    category<span class="op">=</span><span class="st">"NEGATED_EXISTENCE"</span>,</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>    <span class="co"># direction defines whether to try to match the pattern before or after the entity in question</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>    direction<span class="op">=</span><span class="st">"BACKWARD"</span>,</span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>    pattern<span class="op">=</span>[</span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>        {<span class="st">"LOWER"</span>: {<span class="st">"IN"</span>: [<span class="st">"not"</span>, <span class="st">"non"</span>]}},</span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>        {<span class="st">"IS_SPACE"</span>: <span class="va">True</span>, <span class="st">"OP"</span>: <span class="st">"*"</span>},</span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>        {<span class="st">"TEXT"</span>: <span class="st">"-"</span>, <span class="st">"OP"</span>: <span class="st">"?"</span>},</span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>        {<span class="st">"LOWER"</span>: {<span class="st">"REGEX"</span>: <span class="st">"detecte?d"</span>}},</span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>    ],</span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a>    <span class="co"># allowed types defines which entities to apply the context search for, based on which tags they have.</span></span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a>    <span class="co"># in this case we only try to match these patterns around COVID-19 mentions.</span></span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a>    allowed_types<span class="op">=</span>{<span class="st">"COVID-19"</span>},</span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a>),</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><code>ConTextRules</code> also allow to define callbacks that will run on matches and remove the match if necessary. In this example, a callback function defined by the authors of the original imlementation is run on the matches, and removes them if they dont fit more nuanced criteria.</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>ConTextRule(</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>    <span class="st">"active for"</span>,</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">"DEFINITE_POSITIVE_EXISTENCE"</span>,</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>    direction<span class="op">=</span><span class="st">"FORWARD"</span>,</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>    pattern<span class="op">=</span>[{<span class="st">"LOWER"</span>: <span class="st">"active"</span>}, {<span class="st">"LOWER"</span>: <span class="st">"for"</span>, <span class="st">"OP"</span>: <span class="st">"?"</span>}],</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>    allowed_types<span class="op">=</span>{<span class="st">"COVID-19"</span>},</span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>    max_scope<span class="op">=</span><span class="dv">2</span>,</span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>    on_match<span class="op">=</span>callbacks.disambiguate_active,</span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>This module contains ~2370 lines of code comprise of a list of <code>ConTextRules</code> and ~208 lines of callback functions that are used in some of the rules.</p>
</section>
<section id="postproccessor" class="level3">
<h3 class="anchored" data-anchor-id="postproccessor">PostProccessor</h3>
<p>This module does changes the tags of some entities depending on custom logic, that cannot be addressed by the spacy ecosystem. spacy does allow to add this custom logic using a nested strucutre of <code>PostprocessingRule</code> and <code>Postprocessing</code> pattern. For example, the following remove a coronavirus entity if ‘denies’ and ‘contact’ are in the same sentence as the entity.</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>PostprocessingRule(</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>        patterns<span class="op">=</span>[</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>            PostprocessingPattern(<span class="kw">lambda</span> ent: ent.label_ <span class="op">==</span> <span class="st">"COVID-19"</span>),</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>            PostprocessingPattern(</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>                postprocessing_functions.sentence_contains,</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>                condition_args<span class="op">=</span>({<span class="st">"deny"</span>, <span class="st">"denies"</span>, <span class="st">"denied"</span>},),</span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>            ),</span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>            PostprocessingPattern(</span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>                postprocessing_functions.sentence_contains,</span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>                condition_args<span class="op">=</span>({<span class="st">"contact"</span>, <span class="st">"contacts"</span>, <span class="st">"confirmed"</span>},),</span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a>            ),</span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a>        \],</span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a>        action<span class="op">=</span>postprocessing_functions.remove_ent,</span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a>    )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Based on our analysis of the code, the postprocessing rules, together with their custom logic, come in 3 flavors: * rules that are based on sentence context alone * these are similar to the context rules, like the example shown above. * rules based on the context of the sentence after the entity * rules based on the context of the sentece and of other tags given to the entity in previous matches.</p>
<p>Here are examples of the latter two flavors:</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="co"># if the covid mention was previously tagged with DEFINITE_POSITIVE_EXISTENCE but the sentence contains words like "should"</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="co"># then we tag the mention as uncertain.</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>PostprocessingRule(</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>    patterns<span class="op">=</span>[</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>        PostprocessingPattern(<span class="kw">lambda</span> ent: ent.label_ <span class="op">==</span> <span class="st">"COVID-19"</span>),</span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>        PostprocessingPattern(</span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>            postprocessing_functions.is_modified_by_category,</span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>            condition_args<span class="op">=</span>(<span class="st">"DEFINITE_POSITIVE_EXISTENCE"</span>,),</span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a>        ),</span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a>        PostprocessingPattern(</span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a>            postprocessing_functions.sentence_contains,</span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a>            condition_args<span class="op">=</span>(</span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a>                {</span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a>                    <span class="st">"should"</span>,</span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a>                    <span class="st">"unless"</span>,</span>
<span id="cb8-16"><a href="#cb8-16" aria-hidden="true" tabindex="-1"></a>                    <span class="st">"either"</span>,</span>
<span id="cb8-17"><a href="#cb8-17" aria-hidden="true" tabindex="-1"></a>                    <span class="st">"if comes back"</span>,</span>
<span id="cb8-18"><a href="#cb8-18" aria-hidden="true" tabindex="-1"></a>                    <span class="st">"if returns"</span>,</span>
<span id="cb8-19"><a href="#cb8-19" aria-hidden="true" tabindex="-1"></a>                    <span class="st">"if s?he tests positive"</span>,</span>
<span id="cb8-20"><a href="#cb8-20" aria-hidden="true" tabindex="-1"></a>                },</span>
<span id="cb8-21"><a href="#cb8-21" aria-hidden="true" tabindex="-1"></a>                <span class="va">True</span>,</span>
<span id="cb8-22"><a href="#cb8-22" aria-hidden="true" tabindex="-1"></a>            ),</span>
<span id="cb8-23"><a href="#cb8-23" aria-hidden="true" tabindex="-1"></a>        ),</span>
<span id="cb8-24"><a href="#cb8-24" aria-hidden="true" tabindex="-1"></a>    ],</span>
<span id="cb8-25"><a href="#cb8-25" aria-hidden="true" tabindex="-1"></a>    action<span class="op">=</span>set_is_uncertain,</span>
<span id="cb8-26"><a href="#cb8-26" aria-hidden="true" tabindex="-1"></a>    action_args<span class="op">=</span>(<span class="va">True</span>,),</span>
<span id="cb8-27"><a href="#cb8-27" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb8-28"><a href="#cb8-28" aria-hidden="true" tabindex="-1"></a><span class="co"># If a test does not have any results within the same sentence, check the next sentence.</span></span>
<span id="cb8-29"><a href="#cb8-29" aria-hidden="true" tabindex="-1"></a>PostprocessingRule(</span>
<span id="cb8-30"><a href="#cb8-30" aria-hidden="true" tabindex="-1"></a>    patterns<span class="op">=</span>[</span>
<span id="cb8-31"><a href="#cb8-31" aria-hidden="true" tabindex="-1"></a>        PostprocessingPattern(<span class="kw">lambda</span> ent: ent.label_ <span class="op">==</span> <span class="st">"COVID-19"</span>),</span>
<span id="cb8-32"><a href="#cb8-32" aria-hidden="true" tabindex="-1"></a>        PostprocessingPattern(</span>
<span id="cb8-33"><a href="#cb8-33" aria-hidden="true" tabindex="-1"></a>            postprocessing_functions.is_modified_by_category,</span>
<span id="cb8-34"><a href="#cb8-34" aria-hidden="true" tabindex="-1"></a>            condition_args<span class="op">=</span>(<span class="st">"test"</span>,),</span>
<span id="cb8-35"><a href="#cb8-35" aria-hidden="true" tabindex="-1"></a>        ),</span>
<span id="cb8-36"><a href="#cb8-36" aria-hidden="true" tabindex="-1"></a>        PostprocessingPattern(has_positive, success_value<span class="op">=</span><span class="va">False</span>),</span>
<span id="cb8-37"><a href="#cb8-37" aria-hidden="true" tabindex="-1"></a>        (</span>
<span id="cb8-38"><a href="#cb8-38" aria-hidden="true" tabindex="-1"></a>            PostprocessingPattern(</span>
<span id="cb8-39"><a href="#cb8-39" aria-hidden="true" tabindex="-1"></a>                next_sentence_contains,</span>
<span id="cb8-40"><a href="#cb8-40" aria-hidden="true" tabindex="-1"></a>                condition_args<span class="op">=</span>(<span class="st">"results? (are|is) positive"</span>,),</span>
<span id="cb8-41"><a href="#cb8-41" aria-hidden="true" tabindex="-1"></a>            ),</span>
<span id="cb8-42"><a href="#cb8-42" aria-hidden="true" tabindex="-1"></a>            PostprocessingPattern(</span>
<span id="cb8-43"><a href="#cb8-43" aria-hidden="true" tabindex="-1"></a>                next_sentence_contains, condition_args<span class="op">=</span>(<span class="st">"results pos[^s]"</span>,)</span>
<span id="cb8-44"><a href="#cb8-44" aria-hidden="true" tabindex="-1"></a>            ),</span>
<span id="cb8-45"><a href="#cb8-45" aria-hidden="true" tabindex="-1"></a>        ),</span>
<span id="cb8-46"><a href="#cb8-46" aria-hidden="true" tabindex="-1"></a>    ],</span>
<span id="cb8-47"><a href="#cb8-47" aria-hidden="true" tabindex="-1"></a>    action<span class="op">=</span>set_is_positive,</span>
<span id="cb8-48"><a href="#cb8-48" aria-hidden="true" tabindex="-1"></a>    action_args<span class="op">=</span>(<span class="va">True</span>,),</span>
<span id="cb8-49"><a href="#cb8-49" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>This module has ~364 lines of <code>PostProcessingRule</code> definitions and ~84 lines of custom logic python functions.</p>
</section>
<section id="document-classifier" class="level3">
<h3 class="anchored" data-anchor-id="document-classifier">Document classifier</h3>
<p>This module classifies the document based on the tags given to covid mentions. It is comprised out of ~77 lines of vanilla python code.</p>
</section>
<section id="additional-code" class="level3">
<h3 class="anchored" data-anchor-id="additional-code">Additional code</h3>
<p>There are ~270 more lines of code that are comprised of the main pipline logic, which loads all the modules and run the pipeline, and some utility functions.</p>
</section>
<section id="lines-of-code-overview" class="level3">
<h3 class="anchored" data-anchor-id="lines-of-code-overview">Lines of Code overview</h3>
<p>We purposefully vanilla python code from the different <a href="https://DeanLight.github.io/spannerlib/primitive_data_types.html#rule"><code>Rule</code></a> classes which act as “Data as Code”. We will come back to this point in the analysis bellow.</p>
<table class="caption-top table">
<thead>
<tr class="header">
<th>Section</th>
<th>CodeType</th>
<th>~#lines of code</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Concept Tagger</td>
<td><code>TargetRule</code></td>
<td>327</td>
</tr>
<tr class="even">
<td>Target Matcher</td>
<td><code>TargetRule</code></td>
<td>726</td>
</tr>
<tr class="odd">
<td>Sectionizer</td>
<td><code>SectionRule</code></td>
<td>116</td>
</tr>
<tr class="even">
<td>Context</td>
<td><code>ConTextRule</code></td>
<td>2370</td>
</tr>
<tr class="odd">
<td></td>
<td>Vanilla Python</td>
<td>208</td>
</tr>
<tr class="even">
<td>Post Processing</td>
<td><code>PostProcessingRule</code></td>
<td>364</td>
</tr>
<tr class="odd">
<td></td>
<td>Vanilla Python</td>
<td>84</td>
</tr>
<tr class="even">
<td>Document Classifier</td>
<td>Vanilla Python</td>
<td>77</td>
</tr>
<tr class="odd">
<td>Other</td>
<td>Vanilla Python</td>
<td>270</td>
</tr>
<tr class="even">
<td><strong>Total</strong></td>
<td></td>
<td>4542</td>
</tr>
</tbody>
</table>
</section>
</section>
<section id="rules-for-our-implemenation-and-notes-on-line-of-code-comparisons" class="level2">
<h2 class="anchored" data-anchor-id="rules-for-our-implemenation-and-notes-on-line-of-code-comparisons">Rules for our implemenation and notes on line of code comparisons</h2>
<p>To make our comparison fair, we have some key guidelines for our implementations, and a note on the line of code measures. First, we must note that the lines of code measured above include whitespace or lines with parenthesis that is used to make the code more readable.</p>
<ul>
<li>We do not format the original code using formatting tools that try to squeeze more logic into more lines since that hurt readability and essentially <code>hacks</code> the measure of lines of code.</li>
<li>In our implementation we do not skim on whitespace or comments when it helps readability and count our lines of code including it as well.</li>
</ul>
<p>Some additional guidelines:</p>
<ul>
<li>We do not use any other libraries other than the libraries used by the original project (such as spacy) and python standard libraries.
<ul>
<li>This is done to ensure that we do not “beat” the original implementation due to more sophisticated tool use, beyond the spannerlib framework of course.</li>
</ul></li>
</ul>
<p>Please also note that while the line of code comparison is the best quantitative analysis we could perform, the true strength of the spannerlib approach doesn’t come simply from line of code reduction, but from other software engineering concerns which we will go into bellow.</p>
<p>In the step by step implementation, we include some debugging statements and tests to help explain the code. However most of that is not part of the pipeline, in the end to end implementation section we will leave only the actual implementation of the pipeline.</p>
</section>
<section id="our-implementation-step-by-step-implementation" class="level2">
<h2 class="anchored" data-anchor-id="our-implementation-step-by-step-implementation">Our implementation, step by step implementation</h2>
<div id="cell-32" class="cell">
<details open="" class="code-fold">
<summary>Exported source</summary>
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="co"># importing dependencies</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> re</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> csv</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pandas <span class="im">import</span> DataFrame</span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pathlib <span class="im">import</span> Path</span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> spannerlib <span class="im">import</span> get_magic_session,Session,Span</span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>sess <span class="op">=</span> get_magic_session()</span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> spacy</span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a>nlp <span class="op">=</span> spacy.load(<span class="st">"en_core_web_sm"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div id="cell-33" class="cell">
<details open="" class="code-fold">
<summary>Exported source</summary>
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="co"># configurations</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>slog_file <span class="op">=</span> Path(<span class="st">'covid_data/covid_logic.pl'</span>)</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>input_dir <span class="op">=</span> Path(<span class="st">'covid_data/sample_inputs'</span>)</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>data_dir <span class="op">=</span> Path(<span class="st">'covid_data/rules_data'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<section id="deciding-scope-of-spannerlib-code" class="level3">
<h3 class="anchored" data-anchor-id="deciding-scope-of-spannerlib-code">Deciding Scope of spannerlib code</h3>
<p>When trying to design a conceptual pipeline, or refactor an existing codebase using spannerlib, best practices dictate that we should first start off with several questions to help us understand what parts of our code should turn into spannerlib code:</p>
<ol type="1">
<li>What basic computational building blocks do we need?</li>
</ol>
<ul>
<li>This does not include things like:
<ul>
<li>compositional control flow</li>
<li>dataclasses and other OOP hierarchies that are used for data modelling</li>
<li>Constructs that help manage and inspect program state</li>
<li>etc …</li>
</ul></li>
<li>This does include
<ul>
<li>low level numerical/textual analysis</li>
<li>data ingestion from external sources</li>
</ul></li>
</ul>
<ol start="2" type="1">
<li>What in our code is not strictly data processing? for example:</li>
</ol>
<ul>
<li>statistics and visualizations</li>
<li>logging or publishing of results</li>
<li>Getting user input in an interactive system.</li>
</ul>
<ol start="3" type="1">
<li>What data processing pipeline cannot, or is not easy to express via our declerative language?</li>
</ol>
<ul>
<li>such as operations that need to extract entire relations at once from other relations, without being able to be mapped to tuple level extractions.</li>
<li>Or operations that do not fit set semantics and require ordering.</li>
<li>Operations that do not fit the relational paradigm well, for example graph analytics.
<ul>
<li>Note that these points are not a limitation of the spannerlib paradigm but of the very limited declarative language we chose to extend (Datalog).</li>
<li>The spannerlib approach can be extended to any declarative language, including non relational ones.</li>
</ul></li>
</ul>
<p>Like any programming process, you might not get the final answer on the first attempt but these questions help narrow down the design space.</p>
<p>In our case, the basic computational building blocks are:</p>
<ol type="1">
<li>basic textual analysis tools like pattern matching and splitting of text</li>
</ol>
<ul>
<li>Available through the spannerlib’s std library</li>
<li>Some primitive NLP tasks such as:
<ul>
<li>sentence boundary detection</li>
<li>POS tagging</li>
<li>Lemmatization</li>
</ul></li>
</ul>
<ol start="2" type="1">
<li>This is strictly a text processing pipeline, so there are no statistics etc involved</li>
<li>There is no obvious operation that do not fit, but as we will see once we do our data modelling, there are operations that do not fit Spannerlog.</li>
</ol>
</section>
<section id="defining-our-ie-functions" class="level3">
<h3 class="anchored" data-anchor-id="defining-our-ie-functions">Defining our ie functions</h3>
<p>Based on this analysis, we can already start building our IE functions:</p>
<ul>
<li>We will use regex based ie functions form the standard library
<ul>
<li><a href="https://DeanLight.github.io/spannerlib/callbacks/rust_spanner_regex.html#rgx"><code>rgx</code></a> for pattern matching</li>
<li><a href="https://DeanLight.github.io/spannerlib/callbacks/basic_ies.html#rgx_split"><code>rgx_split</code></a> for splitting text based on delimeter patterns</li>
</ul></li>
<li>We will implement using spacy
<ul>
<li>POS extraction</li>
<li>LEMMA extraction</li>
<li>Sentence boundary detection</li>
</ul></li>
</ul>
<div id="cell-40" class="cell">
<details open="" class="code-fold">
<summary>Exported source</summary>
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> split_sentence(text):</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a><span class="co">    Splits a text into individual sentences. using spacy's sentence detection.</span></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns:</span></span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a><span class="co">        str: Individual sentences extracted from the input text.</span></span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a>    doc <span class="op">=</span> nlp(<span class="bu">str</span>(text))</span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a>    start <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> sentence <span class="kw">in</span> doc.sents:</span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a>        end <span class="op">=</span> start<span class="op">+</span><span class="bu">len</span>(sentence.text)</span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a>        <span class="co"># note that we yield a Span object, so we can keep track of the locations of the sentences</span></span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true" tabindex="-1"></a>        <span class="cf">yield</span> Span(text,start,end)</span>
<span id="cb11-15"><a href="#cb11-15" aria-hidden="true" tabindex="-1"></a>        start <span class="op">=</span> end <span class="op">+</span> <span class="dv">1</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div id="cell-41" class="cell">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>text <span class="op">=</span> (input_dir<span class="op">/</span><span class="st">'sample1.txt'</span>).read_text()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-42" class="cell">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="cf">assert</span> <span class="bu">list</span>(split_sentence(text)) <span class="op">==</span> [<span class="st">'Patient presents to be tested for COVID-19.'</span>,</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a> <span class="st">'His wife recently tested positive for novel coronavirus.'</span>,</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a> <span class="st">'SARS-COV-2 results came back positive.'</span>]</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a><span class="bu">list</span>(split_sentence(text))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>[[@a6c01c,0,43) "Patient pr...",
 [@a6c01c,44,100) "His wife r...",
 [@a6c01c,101,139) "SARS-COV-2..."]</code></pre>
</div>
</div>
<p>Note that for both Lemmas and POS, the original pipeline is only interested in a very small subsets of lemmas and POS. We could take two approaches here: 1. Generate all POS and Lemmas and filter them declaratively 2. Configure our extractors to only extract the information we know we may want.</p>
<p>Since our <a href="https://DeanLight.github.io/spannerlib/callbacks/rust_spanner_regex.html#rgx"><code>rgx</code></a> functions output all relevant matches as Spans, we will demonstrate the second approach here.</p>
<div id="cell-45" class="cell">
<details open="" class="code-fold">
<summary>Exported source</summary>
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> LemmaFromList():</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>,lemma_list):</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.lemma_list <span class="op">=</span> lemma_list</span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__call__</span>(<span class="va">self</span>,text):</span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a>        doc <span class="op">=</span> nlp(<span class="bu">str</span>(text))</span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> word <span class="kw">in</span> doc:</span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a>            start <span class="op">=</span> word.idx</span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a>            end <span class="op">=</span> start <span class="op">+</span> <span class="bu">len</span>(word.text)</span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> word.lemma_ <span class="kw">in</span> <span class="va">self</span>.lemma_list:</span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true" tabindex="-1"></a>                <span class="cf">yield</span> (Span(text,start,end),word.lemma_)</span>
<span id="cb15-12"><a href="#cb15-12" aria-hidden="true" tabindex="-1"></a>            <span class="cf">elif</span> word.like_num:</span>
<span id="cb15-13"><a href="#cb15-13" aria-hidden="true" tabindex="-1"></a>                <span class="cf">yield</span> (Span(text,start,end),<span class="st">'like_num'</span>)</span>
<span id="cb15-14"><a href="#cb15-14" aria-hidden="true" tabindex="-1"></a>            <span class="cf">else</span>:</span>
<span id="cb15-15"><a href="#cb15-15" aria-hidden="true" tabindex="-1"></a>                <span class="cf">pass</span></span>
<span id="cb15-16"><a href="#cb15-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-17"><a href="#cb15-17" aria-hidden="true" tabindex="-1"></a>lemma_list <span class="op">=</span> (data_dir<span class="op">/</span><span class="st">'lemma_words.txt'</span>).read_text().split()</span>
<span id="cb15-18"><a href="#cb15-18" aria-hidden="true" tabindex="-1"></a>lemmatizer <span class="op">=</span> LemmaFromList(lemma_list)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div id="cell-46" class="cell">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="cf">assert</span> <span class="bu">list</span>(lemmatizer(<span class="st">'the boy was sick'</span>)) <span class="op">==</span> [(<span class="st">"was"</span>,<span class="st">"be"</span>)]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-48" class="cell">
<details open="" class="code-fold">
<summary>Exported source</summary>
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> PosFromList():</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>,pos_list):</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.pos_list <span class="op">=</span> pos_list</span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__call__</span>(<span class="va">self</span>,text):</span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>        doc <span class="op">=</span> nlp(<span class="bu">str</span>(text))</span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> word <span class="kw">in</span> doc:</span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a>            start <span class="op">=</span> word.idx</span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a>            end <span class="op">=</span> start <span class="op">+</span> <span class="bu">len</span>(word.text)</span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> word.pos_ <span class="kw">in</span> <span class="va">self</span>.pos_list:</span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a>                <span class="cf">yield</span> (Span(text,start,end),word.pos_)</span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-12"><a href="#cb17-12" aria-hidden="true" tabindex="-1"></a>pos_annotator <span class="op">=</span> PosFromList([<span class="st">"NOUN"</span>, <span class="st">"PROPN"</span>, <span class="st">"PRON"</span>, <span class="st">"ADJ"</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div id="cell-49" class="cell">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="cf">assert</span> <span class="bu">list</span>(pos_annotator(<span class="st">'sick boy'</span>)) <span class="op">==</span> [(<span class="st">'sick'</span>,<span class="st">'ADJ'</span>),(<span class="st">'boy'</span>,<span class="st">'NOUN'</span>)]</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a><span class="bu">list</span>(pos_annotator(<span class="st">'sick boy'</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>[([@01e12d,0,4) "sick", 'ADJ'), ([@01e12d,5,8) "boy", 'NOUN')]</code></pre>
</div>
</div>
<div id="cell-50" class="cell">
<details open="" class="code-fold">
<summary>Exported source</summary>
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>sess.register(<span class="st">'split_sentence'</span>,split_sentence,[(<span class="bu">str</span>,Span)],[Span])</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>sess.register(<span class="st">'pos'</span>,pos_annotator,[(Span,<span class="bu">str</span>)],[Span,<span class="bu">str</span>])</span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>sess.register(<span class="st">'lemma'</span>,lemmatizer,[(Span,<span class="bu">str</span>)],[Span,<span class="bu">str</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="data-modelling" class="level3">
<h3 class="anchored" data-anchor-id="data-modelling">Data Modelling</h3>
<p>Now we have an idea of the building blocks we would have at our disposal. Once we have that, the next thing we need to think about it how we will model our data. Specifically, we can ask four guiding questions:</p>
<ol type="1">
<li>How do we get our input data, is it relational or close to it?</li>
<li>What does our output data look like, is it relational or close to it?</li>
<li>What parts of our code can be turned into data?</li>
<li>Are there any computations that require, or are currently based on data models that are not relational?</li>
</ol>
<p>In our case, the answer to the first 3 question are pretty simple:</p>
<ol type="1">
<li>We get a directory of text files, we can model that as a (path,text) relation.</li>
<li>We want a classification of files, we can model that as a (path,label) relation.</li>
<li>All the different <a href="https://DeanLight.github.io/spannerlib/primitive_data_types.html#rule"><code>Rule</code></a> Data Classes stand a good chance of being convertible to relational data.
<ul>
<li>ie <code>SectionRule</code>s are labelled text delimeters</li>
<li><code>ContextRule</code>s seem like they can be turned into regexes or at most serialized and stored as data.</li>
</ul></li>
</ol>
<p>However, question number 4 is more tricky. To understand why, please note that while the <code>pattern</code> attributes of rules look very similar to regular expressions which work on a character level, spacy’s data model works on Word level, and the patterns look not only at the raw text but at token tags, either Lemma, POS or tags defined by the user.</p>
<p>This poses a little bit of a challenge, and likely stems from the fact that this solution was built using spacy in an ad-hoc manner. Spannerlib, can work on relations over all pythonic types (though relational modelling using primitives and Spans is recommended). This means that we have 2 approaches we can choose to take:</p>
<ol type="1">
<li>We can build based on spacy, a word level, tag aware regex pattern matcher
<ul>
<li>this could be cool but would basically be rebuilding parts of spacy, which would overfit to the current implementatio and is a classical example of the <a href="https://en.wikipedia.org/wiki/XY_problem">XY fallacy</a> in code redesign.</li>
</ul></li>
<li>See if we can remodel this problem using classical textual information extraction ideas.</li>
</ol>
<p>Unsurprisingly, we will choose the second approach, even though it will cause us to have some computations that are not supported by Spannerlog.</p>
</section>
<section id="a-detour-into-text-rewrtting" class="level3">
<h3 class="anchored" data-anchor-id="a-detour-into-text-rewrtting">A detour into text rewrtting</h3>
<p>To understand our approach, we must first note that the sequential nature of this pipeline, like many other NLP pipelines, means that we extract tags of entities using patterns, and then reduce our natural language problem to a problem over the tags and not the original text. For example, after normalizing <code>sars COV 2</code> and <code>novel corona virus</code> to <code>COVID-19</code>, we do not care what the original form of the tag was, we can simply continue analyzing the text as if <code>COVID-19</code> was there all along.</p>
<p>This aspect of our pipeline leads us to a well known pattern of “text rewriting”. In this pattern, we have several phases of span/tag extractions, which are then used to rewrite the original text to a simplified form, followed by possible other rewriting iterations, before the final text form in generated for mining.</p>
<p>However, we must note that text rewriting does not fit the limitation of Spannerlog for several reasons:</p>
<ul>
<li>text rewriting at its most basic takes an original text, and a table of <code>(from,to)</code> pairs and generating a new text.
<ul>
<li>This means that rewriting requires the context of an entire table to perform, which does not fit the <code>tuple-&gt;relation</code> paradigm of datalog</li>
</ul></li>
<li>rewriting the text as a string requires sorting of the <code>from</code> spans</li>
</ul>
<p>Does this, mean that our attempted refactoring a failure? Of course not :)</p>
<p>As per the spannerlib framework, the bi directional interaction between Spannerlog and regular python code does not need to be done in a single iteration. What we need is to simply stratify our pipeline and our documents into different versions, and interleave rewritting of new versions with information extraction of tags from the previous version. To do this we need to implement some rewriting logic.</p>
<div id="cell-57" class="cell">
<details open="" class="code-fold">
<summary>Exported source</summary>
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> rewrite(text,span_label_pairs):</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""rewrites a string given a dataframe with spans and the string to rewrite them to</span></span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a><span class="co">    assumes that the spans belong to the text</span></span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a><span class="co">    Args:</span></span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a><span class="co">        text (str like): string to rewrite</span></span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a><span class="co">        span_label_pairs (pd.Dataframe) dataframe with two columns, first is spans in the doc to rewrite</span></span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a><span class="co">            second is what to rewrite to</span></span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns:</span></span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a><span class="co">        The rewritten string</span></span>
<span id="cb21-11"><a href="#cb21-11" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span>    </span>
<span id="cb21-12"><a href="#cb21-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">isinstance</span>(text,Span):</span>
<span id="cb21-13"><a href="#cb21-13" aria-hidden="true" tabindex="-1"></a>        text <span class="op">=</span> text.as_str()</span>
<span id="cb21-14"><a href="#cb21-14" aria-hidden="true" tabindex="-1"></a>    span_label_pairs <span class="op">=</span> <span class="bu">sorted</span>(<span class="bu">list</span>(span_label_pairs.itertuples(index<span class="op">=</span><span class="va">False</span>,name<span class="op">=</span><span class="va">None</span>)), key<span class="op">=</span><span class="kw">lambda</span> x: x[<span class="dv">0</span>].start)</span>
<span id="cb21-15"><a href="#cb21-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-16"><a href="#cb21-16" aria-hidden="true" tabindex="-1"></a>    rewritten_text <span class="op">=</span> <span class="st">''</span></span>
<span id="cb21-17"><a href="#cb21-17" aria-hidden="true" tabindex="-1"></a>    current_pos <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb21-18"><a href="#cb21-18" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> span,label <span class="kw">in</span> span_label_pairs:</span>
<span id="cb21-19"><a href="#cb21-19" aria-hidden="true" tabindex="-1"></a>        rewritten_text <span class="op">+=</span> text[current_pos:span.start] <span class="op">+</span> label </span>
<span id="cb21-20"><a href="#cb21-20" aria-hidden="true" tabindex="-1"></a>        current_pos <span class="op">=</span> span.end</span>
<span id="cb21-21"><a href="#cb21-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-22"><a href="#cb21-22" aria-hidden="true" tabindex="-1"></a>    rewritten_text <span class="op">+=</span> text[current_pos:]</span>
<span id="cb21-23"><a href="#cb21-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-24"><a href="#cb21-24" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> rewritten_text</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div id="cell-58" class="cell">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>text <span class="op">=</span> <span class="st">'the boy was sick'</span></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>replace_span_with <span class="op">=</span> pd.DataFrame(lemmatizer(text))</span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>display(replace_span_with.<span class="bu">map</span>(<span class="bu">repr</span>))</span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a>res <span class="op">=</span> rewrite(text,replace_span_with) </span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a><span class="cf">assert</span> res <span class="op">==</span> <span class="st">'the boy be sick'</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">0</th>
<th data-quarto-table-cell-role="th">1</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>[@6a488f,8,11) "was"</td>
<td>'be'</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<div id="cell-59" class="cell">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>doc <span class="op">=</span> Span(<span class="st">'hello darkness my old friend, I come ...'</span>,name<span class="op">=</span><span class="st">'doc'</span>)</span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>spans_to_replace <span class="op">=</span> pd.DataFrame([</span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>    [doc.<span class="bu">slice</span>(<span class="dv">18</span>,<span class="dv">21</span>),<span class="st">'young'</span>],</span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>    [doc.<span class="bu">slice</span>(<span class="dv">22</span>,<span class="dv">28</span>),<span class="st">'nemesis'</span>],</span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a>])</span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a>spans_to_replace.<span class="bu">map</span>(<span class="bu">repr</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">0</th>
<th data-quarto-table-cell-role="th">1</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>[@doc,18,21) "old"</td>
<td>'young'</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>[@doc,22,28) "friend"</td>
<td>'nemesis'</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<div id="cell-60" class="cell">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>rewritten_doc<span class="op">=</span>rewrite(doc,spans_to_replace)</span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a><span class="cf">assert</span> rewritten_doc <span class="op">==</span> <span class="st">'hello darkness my young nemesis, I come ...'</span></span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>rewritten_doc</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>'hello darkness my young nemesis, I come ...'</code></pre>
</div>
</div>
</section>
<section id="resuming-data-modelling" class="level3">
<h3 class="anchored" data-anchor-id="resuming-data-modelling">Resuming data modelling</h3>
<p>So after resolving the matter of patten matching on tags, we can model our documents and rules as follows:</p>
<ul>
<li>Documents will be modelled by <code>Docs(Path,Text,Version)</code></li>
<li>Concept Tagger Rules will be modelled by <code>ConceptTagRules(pattern,tag,textVersion)</code>
<ul>
<li>where the version is either <code>lemma</code> or <code>POS</code> for lemma and pos based pattern respectively (there are no patterns that require both)</li>
</ul></li>
<li>Target Matcher Rules will be modelled by <code>TargetTagRules(pattern,tag)</code></li>
<li>Section delimiters and section relevancy will be modelled by <code>SectionTags(Pattern,Tag)</code> and <code>PositiveSectionTags(Tag)</code>.</li>
<li>Context Rules will be modelled by <code>SentenceContextRules(pattern,tag,DisambiguationPattern)</code>
<ul>
<li>Where we would like to tag a pattern of the sentence doesnt have any matches of <code>DisambiguationPattern</code></li>
</ul></li>
</ul>
<p>As for PostprocessRules, the 3 different flavors can be modelled differently</p>
<ul>
<li>rules based on sentence context alone are modelled by <code>PostprocessPatternRules(pattern,tag)</code></li>
<li>rules based on sentence context and existing tags are modelled by <code>PostprocessRulesWithAttributes(pattern,old_tag,new_tag)</code>
<ul>
<li>where instead of removing a mention or deleting a tag, which is not something you can or want to do declaratively, we will simply add a new tag whose semantic is to disregard the mention or the old tag.</li>
</ul></li>
<li>rules based on the next sentence are modelled by <code>NextSentencePostprocessPatternRules(pattern,tag)</code></li>
</ul>
<p>All patterns mentioned above are regex patterns using python’s regex flavour.</p>
<section id="a-note-on-data-modelling-and-schema-design" class="level4">
<h4 class="anchored" data-anchor-id="a-note-on-data-modelling-and-schema-design">A note on data modelling and schema design</h4>
<p>The same operations we know and love from relational schema design, such as schema normalization and schema merging etc can be applied to data modelling in the spannerlib framework. For example, we could have, to limit the number of Postprocessing Rule relations, merged their schema by adding an <code>ANY</code> tag that matches any pattern and changing building a single relation of the form <code>ProsProcessRule(pattern,old_tag,new_tag,is_next_sentence)</code>. This would have lead to less relations and less Spannerlog rules, but the remaining rules would have been slightly more complex. Such tradeoffs are analogous to tradeoffs, in regular code design, between amount, length and complexity of functions.</p>
<p>Lets see this in action:</p>
</section>
<section id="looking-at-the-rule-files" class="level4">
<h4 class="anchored" data-anchor-id="looking-at-the-rule-files">Looking at the rule files</h4>
<div id="cell-66" class="cell">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> query <span class="kw">in</span> [</span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>    <span class="st">"?ConceptTagRules(Pattern,Tag,TextType)"</span>,</span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">"?TargetTagRules(Pattern,Tag)"</span>,</span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">"?SectionTags(Pattern,Tag)"</span>,</span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">"?PositiveSectionTags(Tag)"</span>,</span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">"?SentenceContextRules(Pattern,Tag,DisambiguationPattern)"</span>,</span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a>    <span class="st">"?PostprocessPatternRules(Pattern,Tag)"</span>,</span>
<span id="cb26-8"><a href="#cb26-8" aria-hidden="true" tabindex="-1"></a>    <span class="st">"?PostprocessRulesWithAttributes(Pattern,Old_Tag,New_Tag)"</span>,</span>
<span id="cb26-9"><a href="#cb26-9" aria-hidden="true" tabindex="-1"></a>    <span class="st">"?NextSentencePostprocessPatternRules(Pattern,Tag)"</span>,</span>
<span id="cb26-10"><a href="#cb26-10" aria-hidden="true" tabindex="-1"></a>        ]:</span>
<span id="cb26-11"><a href="#cb26-11" aria-hidden="true" tabindex="-1"></a>    res <span class="op">=</span> sess.export(query)</span>
<span id="cb26-12"><a href="#cb26-12" aria-hidden="true" tabindex="-1"></a>    display(query)</span>
<span id="cb26-13"><a href="#cb26-13" aria-hidden="true" tabindex="-1"></a>    display(<span class="bu">len</span>(res))</span>
<span id="cb26-14"><a href="#cb26-14" aria-hidden="true" tabindex="-1"></a>    display(res[:<span class="dv">3</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>'?ConceptTagRules(Pattern,Tag,TextType)'</code></pre>
</div>
<div class="cell-output cell-output-display">
<pre><code>19</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">Pattern</th>
<th data-quarto-table-cell-role="th">Tag</th>
<th data-quarto-table-cell-role="th">TextType</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>(?i)(?:(?:229(?:e)?|oc(?:-)?(?:43)?|o43|0c43|4...</td>
<td>OTHER_CORONAVIRUS</td>
<td>lemma</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>(?i)(?:(?:antibody|antibodies|ab) test)</td>
<td>antibody test</td>
<td>lemma</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>(?i)(?:(?:coronavirus|hcovs?|ncovs?|covs?)(?:\...</td>
<td>OTHER_CORONAVIRUS</td>
<td>lemma</td>
</tr>
</tbody>
</table>

</div>
</div>
<div class="cell-output cell-output-display">
<pre><code>'?TargetTagRules(Pattern,Tag)'</code></pre>
</div>
<div class="cell-output cell-output-display">
<pre><code>20</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">Pattern</th>
<th data-quarto-table-cell-role="th">Tag</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>(?i)((?:person|patient) with confirm COVID-19)</td>
<td>1 2 3 4</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>(?i)(?:(?:(?:contact|exposure) (?:with|to)? )?...</td>
<td>OTHER_PERSON</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>(?i)(?:(?:patient|person) (?:who|that) test (?...</td>
<td>OTHER_PERSON</td>
</tr>
</tbody>
</table>

</div>
</div>
<div class="cell-output cell-output-display">
<pre><code>'?SectionTags(Pattern,Tag)'</code></pre>
</div>
<div class="cell-output cell-output-display">
<pre><code>110</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">Pattern</th>
<th data-quarto-table-cell-role="th">Tag</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>A/P:</td>
<td>observation_and_plan</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>ACTIVE MEDICATIONS LIST:</td>
<td>medications</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>ACTIVE MEDICATIONS:</td>
<td>medications</td>
</tr>
</tbody>
</table>

</div>
</div>
<div class="cell-output cell-output-display">
<pre><code>'?PositiveSectionTags(Tag)'</code></pre>
</div>
<div class="cell-output cell-output-display">
<pre><code>4</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">Tag</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>diagnoses</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>observation_and_plan</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>past_medical_history</td>
</tr>
</tbody>
</table>

</div>
</div>
<div class="cell-output cell-output-display">
<pre><code>'?SentenceContextRules(Pattern,Tag,DisambiguationPattern)'</code></pre>
</div>
<div class="cell-output cell-output-display">
<pre><code>176</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">Pattern</th>
<th data-quarto-table-cell-role="th">Tag</th>
<th data-quarto-table-cell-role="th">DisambiguationPattern</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>(&gt;i)contact</td>
<td>positive</td>
<td>droplet|precaution|isolat</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>(?i)(?:(?:(?:(?:-)?hx|history|) of)(?: (?!&lt;IGN...</td>
<td>negated</td>
<td>(?=a)b</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>(?i)(?:(?:(?:area|county|community|city) (?:wi...</td>
<td>negated</td>
<td>(?=a)b</td>
</tr>
</tbody>
</table>

</div>
</div>
<div class="cell-output cell-output-display">
<pre><code>'?PostprocessPatternRules(Pattern,Tag)'</code></pre>
</div>
<div class="cell-output cell-output-display">
<pre><code>6</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">Pattern</th>
<th data-quarto-table-cell-role="th">Tag</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>(?=.*\b(?:deny|denies|denied)\b)(?=.*\b(?:cont...</td>
<td>IGNORE</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>(?=.*\b(?:setting of|s/o)\b)(?!.*\b(?:COVID-19...</td>
<td>no_positive</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>(?i)(.*benign.*)</td>
<td>uncertain</td>
</tr>
</tbody>
</table>

</div>
</div>
<div class="cell-output cell-output-display">
<pre><code>'?PostprocessRulesWithAttributes(Pattern,Old_Tag,New_Tag)'</code></pre>
</div>
<div class="cell-output cell-output-display">
<pre><code>5</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">Pattern</th>
<th data-quarto-table-cell-role="th">Old_Tag</th>
<th data-quarto-table-cell-role="th">New_Tag</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>.*(?:re[ -]?test|second test|repeat).*</td>
<td>negated</td>
<td>no_negated</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>.*(?:should|unless|either|if comes back|if ret...</td>
<td>positive</td>
<td>uncertain</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>.*(?:sign|symptom|s/s).*</td>
<td>positive</td>
<td>uncertain</td>
</tr>
</tbody>
</table>

</div>
</div>
<div class="cell-output cell-output-display">
<pre><code>'?NextSentencePostprocessPatternRules(Pattern,Tag)'</code></pre>
</div>
<div class="cell-output cell-output-display">
<pre><code>1</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">Pattern</th>
<th data-quarto-table-cell-role="th">Tag</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>(?i)(?:^(?:positive|detected)|results?(?: be)?...</td>
<td>positive</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</section>
</section>
<section id="preparing-the-input" class="level3">
<h3 class="anchored" data-anchor-id="preparing-the-input">Preparing the input</h3>
</section>
<section id="rewriting-texts-based-on-tags" class="level3">
<h3 class="anchored" data-anchor-id="rewriting-texts-based-on-tags">Rewriting texts based on tags</h3>
<p>In this section we need to rewrite our texts multiple times base on: * Lemmas * Lemma concept matches * POS tags * and target matcher tags</p>
<p>This section replaces the Concept Matcher and Target Tagger modules in the original implementation</p>
<div id="cell-70" class="cell">
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a>Lemmas(P,D,Word,Lem)<span class="op">&lt;-</span>Docs(P,D,<span class="st">"raw_text"</span>),lemma(D)<span class="op">-&gt;</span>(Word,Lem).</span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a>?Lemmas(P,D,Word,Lem)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>'?Lemmas(P,D,Word,Lem)'</code></pre>
</div>
<div class="cell-output cell-output-display">
<style type="text/css">
#T_cbf89_row0_col0, #T_cbf89_row0_col1, #T_cbf89_row0_col2, #T_cbf89_row0_col3, #T_cbf89_row1_col0, #T_cbf89_row1_col1, #T_cbf89_row1_col2, #T_cbf89_row1_col3, #T_cbf89_row2_col0, #T_cbf89_row2_col1, #T_cbf89_row2_col2, #T_cbf89_row2_col3, #T_cbf89_row3_col0, #T_cbf89_row3_col1, #T_cbf89_row3_col2, #T_cbf89_row3_col3, #T_cbf89_row4_col0, #T_cbf89_row4_col1, #T_cbf89_row4_col2, #T_cbf89_row4_col3, #T_cbf89_row5_col0, #T_cbf89_row5_col1, #T_cbf89_row5_col2, #T_cbf89_row5_col3, #T_cbf89_row6_col0, #T_cbf89_row6_col1, #T_cbf89_row6_col2, #T_cbf89_row6_col3, #T_cbf89_row7_col0, #T_cbf89_row7_col1, #T_cbf89_row7_col2, #T_cbf89_row7_col3, #T_cbf89_row8_col0, #T_cbf89_row8_col1, #T_cbf89_row8_col2, #T_cbf89_row8_col3, #T_cbf89_row9_col0, #T_cbf89_row9_col1, #T_cbf89_row9_col2, #T_cbf89_row9_col3, #T_cbf89_row10_col0, #T_cbf89_row10_col1, #T_cbf89_row10_col2, #T_cbf89_row10_col3, #T_cbf89_row11_col0, #T_cbf89_row11_col1, #T_cbf89_row11_col2, #T_cbf89_row11_col3, #T_cbf89_row12_col0, #T_cbf89_row12_col1, #T_cbf89_row12_col2, #T_cbf89_row12_col3, #T_cbf89_row13_col0, #T_cbf89_row13_col1, #T_cbf89_row13_col2, #T_cbf89_row13_col3, #T_cbf89_row14_col0, #T_cbf89_row14_col1, #T_cbf89_row14_col2, #T_cbf89_row14_col3, #T_cbf89_row15_col0, #T_cbf89_row15_col1, #T_cbf89_row15_col2, #T_cbf89_row15_col3, #T_cbf89_row16_col0, #T_cbf89_row16_col1, #T_cbf89_row16_col2, #T_cbf89_row16_col3, #T_cbf89_row17_col0, #T_cbf89_row17_col1, #T_cbf89_row17_col2, #T_cbf89_row17_col3, #T_cbf89_row18_col0, #T_cbf89_row18_col1, #T_cbf89_row18_col2, #T_cbf89_row18_col3, #T_cbf89_row19_col0, #T_cbf89_row19_col1, #T_cbf89_row19_col2, #T_cbf89_row19_col3 {
  overflow-wrap: break-word;
  max-width: 800px;
  text-align: left;
}
</style>

<table id="T_cbf89" class="display nowrap caption-top table table-sm table-striped small" data-quarto-postprocess="true">
<thead>
<tr class="header">
<th id="T_cbf89_level0_col0" class="col_heading level0 col0" data-quarto-table-cell-role="th">P</th>
<th id="T_cbf89_level0_col1" class="col_heading level0 col1" data-quarto-table-cell-role="th">D</th>
<th id="T_cbf89_level0_col2" class="col_heading level0 col2" data-quarto-table-cell-role="th">Word</th>
<th id="T_cbf89_level0_col3" class="col_heading level0 col3" data-quarto-table-cell-role="th">Lem</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td id="T_cbf89_row0_col0" class="data row0 col0">sample1.txt</td>
<td id="T_cbf89_row0_col1" class="data row0 col1">Patient presents to be tested for COVID-19. His wife recently tested positive for novel coronavirus. SARS-COV-2 results came back positive.</td>
<td id="T_cbf89_row0_col2" class="data row0 col2">[@a6c01c,0,7) "Patient"</td>
<td id="T_cbf89_row0_col3" class="data row0 col3">patient</td>
</tr>
<tr class="even">
<td id="T_cbf89_row1_col0" class="data row1 col0">sample1.txt</td>
<td id="T_cbf89_row1_col1" class="data row1 col1">Patient presents to be tested for COVID-19. His wife recently tested positive for novel coronavirus. SARS-COV-2 results came back positive.</td>
<td id="T_cbf89_row1_col2" class="data row1 col2">[@a6c01c,20,22) "be"</td>
<td id="T_cbf89_row1_col3" class="data row1 col3">be</td>
</tr>
<tr class="odd">
<td id="T_cbf89_row2_col0" class="data row2 col0">sample10.txt</td>
<td id="T_cbf89_row2_col1" class="data row2 col1">patient was screened for cov-19. results came back positive.</td>
<td id="T_cbf89_row2_col2" class="data row2 col2">[@9f417c,0,7) "patient"</td>
<td id="T_cbf89_row2_col3" class="data row2 col3">patient</td>
</tr>
<tr class="even">
<td id="T_cbf89_row3_col0" class="data row3 col0">sample10.txt</td>
<td id="T_cbf89_row3_col1" class="data row3 col1">patient was screened for cov-19. results came back positive.</td>
<td id="T_cbf89_row3_col2" class="data row3 col2">[@9f417c,8,11) "was"</td>
<td id="T_cbf89_row3_col3" class="data row3 col3">be</td>
</tr>
<tr class="odd">
<td id="T_cbf89_row4_col0" class="data row4 col0">sample2.txt</td>
<td id="T_cbf89_row4_col1" class="data row4 col1">The patient was tested for Coronavirus 2019. Results are positive. Patient underwent no Coronavirus 2019 education.</td>
<td id="T_cbf89_row4_col2" class="data row4 col2">[@591f89,4,11) "patient"</td>
<td id="T_cbf89_row4_col3" class="data row4 col3">patient</td>
</tr>
<tr class="even">
<td id="T_cbf89_row5_col0" class="data row5 col0">sample2.txt</td>
<td id="T_cbf89_row5_col1" class="data row5 col1">The patient was tested for Coronavirus 2019. Results are positive. Patient underwent no Coronavirus 2019 education.</td>
<td id="T_cbf89_row5_col2" class="data row5 col2">[@591f89,12,15) "was"</td>
<td id="T_cbf89_row5_col3" class="data row5 col3">be</td>
</tr>
<tr class="odd">
<td id="T_cbf89_row6_col0" class="data row6 col0">sample2.txt</td>
<td id="T_cbf89_row6_col1" class="data row6 col1">The patient was tested for Coronavirus 2019. Results are positive. Patient underwent no Coronavirus 2019 education.</td>
<td id="T_cbf89_row6_col2" class="data row6 col2">[@591f89,39,43) "2019"</td>
<td id="T_cbf89_row6_col3" class="data row6 col3">like_num</td>
</tr>
<tr class="even">
<td id="T_cbf89_row7_col0" class="data row7 col0">sample2.txt</td>
<td id="T_cbf89_row7_col1" class="data row7 col1">The patient was tested for Coronavirus 2019. Results are positive. Patient underwent no Coronavirus 2019 education.</td>
<td id="T_cbf89_row7_col2" class="data row7 col2">[@591f89,53,56) "are"</td>
<td id="T_cbf89_row7_col3" class="data row7 col3">be</td>
</tr>
<tr class="odd">
<td id="T_cbf89_row8_col0" class="data row8 col0">sample2.txt</td>
<td id="T_cbf89_row8_col1" class="data row8 col1">The patient was tested for Coronavirus 2019. Results are positive. Patient underwent no Coronavirus 2019 education.</td>
<td id="T_cbf89_row8_col2" class="data row8 col2">[@591f89,67,74) "Patient"</td>
<td id="T_cbf89_row8_col3" class="data row8 col3">patient</td>
</tr>
<tr class="even">
<td id="T_cbf89_row9_col0" class="data row9 col0">sample2.txt</td>
<td id="T_cbf89_row9_col1" class="data row9 col1">The patient was tested for Coronavirus 2019. Results are positive. Patient underwent no Coronavirus 2019 education.</td>
<td id="T_cbf89_row9_col2" class="data row9 col2">[@591f89,100,104) "2019"</td>
<td id="T_cbf89_row9_col3" class="data row9 col3">like_num</td>
</tr>
<tr class="odd">
<td id="T_cbf89_row10_col0" class="data row10 col0">sample3.txt</td>
<td id="T_cbf89_row10_col1" class="data row10 col1">Problem List: 1. Pneumonia 2. Novel Coronavirus 2019</td>
<td id="T_cbf89_row10_col2" class="data row10 col2">[@45bf63,14,15) "1"</td>
<td id="T_cbf89_row10_col3" class="data row10 col3">like_num</td>
</tr>
<tr class="even">
<td id="T_cbf89_row11_col0" class="data row11 col0">sample3.txt</td>
<td id="T_cbf89_row11_col1" class="data row11 col1">Problem List: 1. Pneumonia 2. Novel Coronavirus 2019</td>
<td id="T_cbf89_row11_col2" class="data row11 col2">[@45bf63,27,28) "2"</td>
<td id="T_cbf89_row11_col3" class="data row11 col3">like_num</td>
</tr>
<tr class="odd">
<td id="T_cbf89_row12_col0" class="data row12 col0">sample3.txt</td>
<td id="T_cbf89_row12_col1" class="data row12 col1">Problem List: 1. Pneumonia 2. Novel Coronavirus 2019</td>
<td id="T_cbf89_row12_col2" class="data row12 col2">[@45bf63,48,52) "2019"</td>
<td id="T_cbf89_row12_col3" class="data row12 col3">like_num</td>
</tr>
<tr class="even">
<td id="T_cbf89_row13_col0" class="data row13 col0">sample6.txt</td>
<td id="T_cbf89_row13_col1" class="data row13 col1">The patient have reported novel coronavirus.</td>
<td id="T_cbf89_row13_col2" class="data row13 col2">[@2473a3,4,11) "patient"</td>
<td id="T_cbf89_row13_col3" class="data row13 col3">patient</td>
</tr>
<tr class="odd">
<td id="T_cbf89_row14_col0" class="data row14 col0">sample6.txt</td>
<td id="T_cbf89_row14_col1" class="data row14 col1">The patient have reported novel coronavirus.</td>
<td id="T_cbf89_row14_col2" class="data row14 col2">[@2473a3,12,16) "have"</td>
<td id="T_cbf89_row14_col3" class="data row14 col3">have</td>
</tr>
<tr class="even">
<td id="T_cbf89_row15_col0" class="data row15 col0">sample8.txt</td>
<td id="T_cbf89_row15_col1" class="data row15 col1">Patient was sent for a covid test. Someone was tested positive.</td>
<td id="T_cbf89_row15_col2" class="data row15 col2">[@aad8ff,8,11) "was"</td>
<td id="T_cbf89_row15_col3" class="data row15 col3">be</td>
</tr>
<tr class="odd">
<td id="T_cbf89_row16_col0" class="data row16 col0">sample8.txt</td>
<td id="T_cbf89_row16_col1" class="data row16 col1">Patient was sent for a covid test. Someone was tested positive.</td>
<td id="T_cbf89_row16_col2" class="data row16 col2">[@aad8ff,43,46) "was"</td>
<td id="T_cbf89_row16_col3" class="data row16 col3">be</td>
</tr>
<tr class="even">
<td id="T_cbf89_row17_col0" class="data row17 col0">sample9.txt</td>
<td id="T_cbf89_row17_col1" class="data row17 col1">Patient had contact patient with coronavirus. screening positive coronavirus.</td>
<td id="T_cbf89_row17_col2" class="data row17 col2">[@0e1178,8,11) "had"</td>
<td id="T_cbf89_row17_col3" class="data row17 col3">have</td>
</tr>
<tr class="odd">
<td id="T_cbf89_row18_col0" class="data row18 col0">sample9.txt</td>
<td id="T_cbf89_row18_col1" class="data row18 col1">Patient had contact patient with coronavirus. screening positive coronavirus.</td>
<td id="T_cbf89_row18_col2" class="data row18 col2">[@0e1178,12,19) "contact"</td>
<td id="T_cbf89_row18_col3" class="data row18 col3">contact</td>
</tr>
<tr class="even">
<td id="T_cbf89_row19_col0" class="data row19 col0">sample9.txt</td>
<td id="T_cbf89_row19_col1" class="data row19 col1">Patient had contact patient with coronavirus. screening positive coronavirus.</td>
<td id="T_cbf89_row19_col2" class="data row19 col2">[@0e1178,20,27) "patient"</td>
<td id="T_cbf89_row19_col3" class="data row19 col3">patient</td>
</tr>
</tbody>
</table>


<script type="module">
    const { DataTable, jQuery: $ } = await import(window._datatables_src_for_itables_2_1_4);

    document.querySelectorAll("#T_cbf89:not(.dataTable)").forEach(table => {
        // Define the table data
        

        // Define the dt_args
        let dt_args = {"columnDefs": [{"targets": ["P", "D", "Word", "Lem"], "render": function(data, type, row) {
                    return '<div style="white-space: normal; word-wrap: break-word;">' + data + '</div>';
                }, "width": "300px"}], "escape": true, "layout": {"topStart": "pageLength", "topEnd": "search", "bottomStart": "info", "bottomEnd": "paging"}, "display_logo_when_loading": true, "order": []};
        

        
        new DataTable(table, dt_args);
    });
</script>
</div>
</div>
<div id="cell-71" class="cell">
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a>?Docs(P,D,V)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>'?Docs(P,D,V)'</code></pre>
</div>
<div class="cell-output cell-output-display">
<style type="text/css">
#T_c4d43_row0_col0, #T_c4d43_row0_col1, #T_c4d43_row0_col2, #T_c4d43_row1_col0, #T_c4d43_row1_col1, #T_c4d43_row1_col2, #T_c4d43_row2_col0, #T_c4d43_row2_col1, #T_c4d43_row2_col2, #T_c4d43_row3_col0, #T_c4d43_row3_col1, #T_c4d43_row3_col2, #T_c4d43_row4_col0, #T_c4d43_row4_col1, #T_c4d43_row4_col2, #T_c4d43_row5_col0, #T_c4d43_row5_col1, #T_c4d43_row5_col2, #T_c4d43_row6_col0, #T_c4d43_row6_col1, #T_c4d43_row6_col2, #T_c4d43_row7_col0, #T_c4d43_row7_col1, #T_c4d43_row7_col2, #T_c4d43_row8_col0, #T_c4d43_row8_col1, #T_c4d43_row8_col2, #T_c4d43_row9_col0, #T_c4d43_row9_col1, #T_c4d43_row9_col2, #T_c4d43_row10_col0, #T_c4d43_row10_col1, #T_c4d43_row10_col2, #T_c4d43_row11_col0, #T_c4d43_row11_col1, #T_c4d43_row11_col2, #T_c4d43_row12_col0, #T_c4d43_row12_col1, #T_c4d43_row12_col2, #T_c4d43_row13_col0, #T_c4d43_row13_col1, #T_c4d43_row13_col2, #T_c4d43_row14_col0, #T_c4d43_row14_col1, #T_c4d43_row14_col2, #T_c4d43_row15_col0, #T_c4d43_row15_col1, #T_c4d43_row15_col2, #T_c4d43_row16_col0, #T_c4d43_row16_col1, #T_c4d43_row16_col2, #T_c4d43_row17_col0, #T_c4d43_row17_col1, #T_c4d43_row17_col2, #T_c4d43_row18_col0, #T_c4d43_row18_col1, #T_c4d43_row18_col2, #T_c4d43_row19_col0, #T_c4d43_row19_col1, #T_c4d43_row19_col2 {
  overflow-wrap: break-word;
  max-width: 800px;
  text-align: left;
}
</style>

<table id="T_c4d43" class="display nowrap caption-top table table-sm table-striped small" data-quarto-postprocess="true">
<thead>
<tr class="header">
<th id="T_c4d43_level0_col0" class="col_heading level0 col0" data-quarto-table-cell-role="th">P</th>
<th id="T_c4d43_level0_col1" class="col_heading level0 col1" data-quarto-table-cell-role="th">D</th>
<th id="T_c4d43_level0_col2" class="col_heading level0 col2" data-quarto-table-cell-role="th">V</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td id="T_c4d43_row0_col0" class="data row0 col0">sample1.txt</td>
<td id="T_c4d43_row0_col1" class="data row0 col1">Patient presents to be tested for COVID-19. His wife recently tested positive for novel coronavirus. SARS-COV-2 results came back positive.</td>
<td id="T_c4d43_row0_col2" class="data row0 col2">raw_text</td>
</tr>
<tr class="even">
<td id="T_c4d43_row1_col0" class="data row1 col0">sample1.txt</td>
<td id="T_c4d43_row1_col1" class="data row1 col1">patient presents to be tested for COVID-19. His wife recently tested positive for novel coronavirus. SARS-COV-2 results came back positive.</td>
<td id="T_c4d43_row1_col2" class="data row1 col2">lemma</td>
</tr>
<tr class="odd">
<td id="T_c4d43_row2_col0" class="data row2 col0">sample10.txt</td>
<td id="T_c4d43_row2_col1" class="data row2 col1">patient be screened for cov-19. results came back positive.</td>
<td id="T_c4d43_row2_col2" class="data row2 col2">lemma</td>
</tr>
<tr class="even">
<td id="T_c4d43_row3_col0" class="data row3 col0">sample10.txt</td>
<td id="T_c4d43_row3_col1" class="data row3 col1">patient was screened for cov-19. results came back positive.</td>
<td id="T_c4d43_row3_col2" class="data row3 col2">raw_text</td>
</tr>
<tr class="odd">
<td id="T_c4d43_row4_col0" class="data row4 col0">sample2.txt</td>
<td id="T_c4d43_row4_col1" class="data row4 col1">The patient be tested for Coronavirus like_num. Results be positive. patient underwent no Coronavirus like_num education.</td>
<td id="T_c4d43_row4_col2" class="data row4 col2">lemma</td>
</tr>
<tr class="even">
<td id="T_c4d43_row5_col0" class="data row5 col0">sample2.txt</td>
<td id="T_c4d43_row5_col1" class="data row5 col1">The patient was tested for Coronavirus 2019. Results are positive. Patient underwent no Coronavirus 2019 education.</td>
<td id="T_c4d43_row5_col2" class="data row5 col2">raw_text</td>
</tr>
<tr class="odd">
<td id="T_c4d43_row6_col0" class="data row6 col0">sample3.txt</td>
<td id="T_c4d43_row6_col1" class="data row6 col1">Problem List: 1. Pneumonia 2. Novel Coronavirus 2019</td>
<td id="T_c4d43_row6_col2" class="data row6 col2">raw_text</td>
</tr>
<tr class="even">
<td id="T_c4d43_row7_col0" class="data row7 col0">sample3.txt</td>
<td id="T_c4d43_row7_col1" class="data row7 col1">Problem List: like_num. Pneumonia like_num. Novel Coronavirus like_num</td>
<td id="T_c4d43_row7_col2" class="data row7 col2">lemma</td>
</tr>
<tr class="odd">
<td id="T_c4d43_row8_col0" class="data row8 col0">sample4.txt</td>
<td id="T_c4d43_row8_col1" class="data row8 col1">neg covid education.</td>
<td id="T_c4d43_row8_col2" class="data row8 col2">lemma</td>
</tr>
<tr class="even">
<td id="T_c4d43_row9_col0" class="data row9 col0">sample4.txt</td>
<td id="T_c4d43_row9_col1" class="data row9 col1">neg covid education.</td>
<td id="T_c4d43_row9_col2" class="data row9 col2">raw_text</td>
</tr>
<tr class="odd">
<td id="T_c4d43_row10_col0" class="data row10 col0">sample5.txt</td>
<td id="T_c4d43_row10_col1" class="data row10 col1">positive covid precaution.</td>
<td id="T_c4d43_row10_col2" class="data row10 col2">lemma</td>
</tr>
<tr class="even">
<td id="T_c4d43_row11_col0" class="data row11 col0">sample5.txt</td>
<td id="T_c4d43_row11_col1" class="data row11 col1">positive covid precaution.</td>
<td id="T_c4d43_row11_col2" class="data row11 col2">raw_text</td>
</tr>
<tr class="odd">
<td id="T_c4d43_row12_col0" class="data row12 col0">sample6.txt</td>
<td id="T_c4d43_row12_col1" class="data row12 col1">The patient have reported novel coronavirus.</td>
<td id="T_c4d43_row12_col2" class="data row12 col2">lemma</td>
</tr>
<tr class="even">
<td id="T_c4d43_row13_col0" class="data row13 col0">sample6.txt</td>
<td id="T_c4d43_row13_col1" class="data row13 col1">The patient have reported novel coronavirus.</td>
<td id="T_c4d43_row13_col2" class="data row13 col2">raw_text</td>
</tr>
<tr class="odd">
<td id="T_c4d43_row14_col0" class="data row14 col0">sample7.txt</td>
<td id="T_c4d43_row14_col1" class="data row14 col1">Elevated cholesterol levels require further assessment and lifestyle adjustments .</td>
<td id="T_c4d43_row14_col2" class="data row14 col2">lemma</td>
</tr>
<tr class="even">
<td id="T_c4d43_row15_col0" class="data row15 col0">sample7.txt</td>
<td id="T_c4d43_row15_col1" class="data row15 col1">Elevated cholesterol levels require further assessment and lifestyle adjustments .</td>
<td id="T_c4d43_row15_col2" class="data row15 col2">raw_text</td>
</tr>
<tr class="odd">
<td id="T_c4d43_row16_col0" class="data row16 col0">sample8.txt</td>
<td id="T_c4d43_row16_col1" class="data row16 col1">Patient be sent for a covid test. Someone be tested positive.</td>
<td id="T_c4d43_row16_col2" class="data row16 col2">lemma</td>
</tr>
<tr class="even">
<td id="T_c4d43_row17_col0" class="data row17 col0">sample8.txt</td>
<td id="T_c4d43_row17_col1" class="data row17 col1">Patient was sent for a covid test. Someone was tested positive.</td>
<td id="T_c4d43_row17_col2" class="data row17 col2">raw_text</td>
</tr>
<tr class="odd">
<td id="T_c4d43_row18_col0" class="data row18 col0">sample9.txt</td>
<td id="T_c4d43_row18_col1" class="data row18 col1">Patient had contact patient with coronavirus. screening positive coronavirus.</td>
<td id="T_c4d43_row18_col2" class="data row18 col2">raw_text</td>
</tr>
<tr class="even">
<td id="T_c4d43_row19_col0" class="data row19 col0">sample9.txt</td>
<td id="T_c4d43_row19_col1" class="data row19 col1">Patient have contact patient with coronavirus. screening positive coronavirus.</td>
<td id="T_c4d43_row19_col2" class="data row19 col2">lemma</td>
</tr>
</tbody>
</table>


<script type="module">
    const { DataTable, jQuery: $ } = await import(window._datatables_src_for_itables_2_1_4);

    document.querySelectorAll("#T_c4d43:not(.dataTable)").forEach(table => {
        // Define the table data
        

        // Define the dt_args
        let dt_args = {"columnDefs": [{"targets": ["P", "D", "V"], "render": function(data, type, row) {
                    return '<div style="white-space: normal; word-wrap: break-word;">' + data + '</div>';
                }, "width": "300px"}], "escape": true, "layout": {"topStart": "pageLength", "topEnd": "search", "bottomStart": "info", "bottomEnd": "paging"}, "display_logo_when_loading": true, "order": []};
        

        
        new DataTable(table, dt_args);
    });
</script>
</div>
</div>
<div id="cell-72" class="cell">
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a>LemmaConceptMatches(Path,Doc,Span,Label) <span class="op">&lt;-</span> </span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a>    Docs(Path,Doc,<span class="st">"lemma"</span>),</span>
<span id="cb47-3"><a href="#cb47-3" aria-hidden="true" tabindex="-1"></a>    ConceptTagRules(Pattern, Label, <span class="st">"lemma"</span>),</span>
<span id="cb47-4"><a href="#cb47-4" aria-hidden="true" tabindex="-1"></a>    rgx(Pattern,Doc) <span class="op">-&gt;</span> (Span).</span>
<span id="cb47-5"><a href="#cb47-5" aria-hidden="true" tabindex="-1"></a>?LemmaConceptMatches(Path,Doc,Span,Label)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>'?LemmaConceptMatches(Path,Doc,Span,Label)'</code></pre>
</div>
<div class="cell-output cell-output-display">
<style type="text/css">
#T_befc0_row0_col0, #T_befc0_row0_col1, #T_befc0_row0_col2, #T_befc0_row0_col3, #T_befc0_row1_col0, #T_befc0_row1_col1, #T_befc0_row1_col2, #T_befc0_row1_col3, #T_befc0_row2_col0, #T_befc0_row2_col1, #T_befc0_row2_col2, #T_befc0_row2_col3, #T_befc0_row3_col0, #T_befc0_row3_col1, #T_befc0_row3_col2, #T_befc0_row3_col3, #T_befc0_row4_col0, #T_befc0_row4_col1, #T_befc0_row4_col2, #T_befc0_row4_col3, #T_befc0_row5_col0, #T_befc0_row5_col1, #T_befc0_row5_col2, #T_befc0_row5_col3, #T_befc0_row6_col0, #T_befc0_row6_col1, #T_befc0_row6_col2, #T_befc0_row6_col3, #T_befc0_row7_col0, #T_befc0_row7_col1, #T_befc0_row7_col2, #T_befc0_row7_col3, #T_befc0_row8_col0, #T_befc0_row8_col1, #T_befc0_row8_col2, #T_befc0_row8_col3, #T_befc0_row9_col0, #T_befc0_row9_col1, #T_befc0_row9_col2, #T_befc0_row9_col3, #T_befc0_row10_col0, #T_befc0_row10_col1, #T_befc0_row10_col2, #T_befc0_row10_col3, #T_befc0_row11_col0, #T_befc0_row11_col1, #T_befc0_row11_col2, #T_befc0_row11_col3, #T_befc0_row12_col0, #T_befc0_row12_col1, #T_befc0_row12_col2, #T_befc0_row12_col3, #T_befc0_row13_col0, #T_befc0_row13_col1, #T_befc0_row13_col2, #T_befc0_row13_col3, #T_befc0_row14_col0, #T_befc0_row14_col1, #T_befc0_row14_col2, #T_befc0_row14_col3, #T_befc0_row15_col0, #T_befc0_row15_col1, #T_befc0_row15_col2, #T_befc0_row15_col3, #T_befc0_row16_col0, #T_befc0_row16_col1, #T_befc0_row16_col2, #T_befc0_row16_col3, #T_befc0_row17_col0, #T_befc0_row17_col1, #T_befc0_row17_col2, #T_befc0_row17_col3, #T_befc0_row18_col0, #T_befc0_row18_col1, #T_befc0_row18_col2, #T_befc0_row18_col3, #T_befc0_row19_col0, #T_befc0_row19_col1, #T_befc0_row19_col2, #T_befc0_row19_col3, #T_befc0_row20_col0, #T_befc0_row20_col1, #T_befc0_row20_col2, #T_befc0_row20_col3, #T_befc0_row21_col0, #T_befc0_row21_col1, #T_befc0_row21_col2, #T_befc0_row21_col3, #T_befc0_row22_col0, #T_befc0_row22_col1, #T_befc0_row22_col2, #T_befc0_row22_col3, #T_befc0_row23_col0, #T_befc0_row23_col1, #T_befc0_row23_col2, #T_befc0_row23_col3, #T_befc0_row24_col0, #T_befc0_row24_col1, #T_befc0_row24_col2, #T_befc0_row24_col3, #T_befc0_row25_col0, #T_befc0_row25_col1, #T_befc0_row25_col2, #T_befc0_row25_col3, #T_befc0_row26_col0, #T_befc0_row26_col1, #T_befc0_row26_col2, #T_befc0_row26_col3 {
  overflow-wrap: break-word;
  max-width: 800px;
  text-align: left;
}
</style>

<table id="T_befc0" class="display nowrap caption-top table table-sm table-striped small" data-quarto-postprocess="true">
<thead>
<tr class="header">
<th id="T_befc0_level0_col0" class="col_heading level0 col0" data-quarto-table-cell-role="th">Path</th>
<th id="T_befc0_level0_col1" class="col_heading level0 col1" data-quarto-table-cell-role="th">Doc</th>
<th id="T_befc0_level0_col2" class="col_heading level0 col2" data-quarto-table-cell-role="th">Span</th>
<th id="T_befc0_level0_col3" class="col_heading level0 col3" data-quarto-table-cell-role="th">Label</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td id="T_befc0_row0_col0" class="data row0 col0">sample1.txt</td>
<td id="T_befc0_row0_col1" class="data row0 col1">patient presents to be tested for COVID-19. His wife recently tested positive for novel coronavirus. SARS-COV-2 results came back positive.</td>
<td id="T_befc0_row0_col2" class="data row0 col2">[@4d073b,0,7) "patient"</td>
<td id="T_befc0_row0_col3" class="data row0 col3">patient</td>
</tr>
<tr class="even">
<td id="T_befc0_row1_col0" class="data row1 col0">sample1.txt</td>
<td id="T_befc0_row1_col1" class="data row1 col1">patient presents to be tested for COVID-19. His wife recently tested positive for novel coronavirus. SARS-COV-2 results came back positive.</td>
<td id="T_befc0_row1_col2" class="data row1 col2">[@4d073b,34,42) "COVID-19"</td>
<td id="T_befc0_row1_col3" class="data row1 col3">COVID-19</td>
</tr>
<tr class="odd">
<td id="T_befc0_row2_col0" class="data row2 col0">sample1.txt</td>
<td id="T_befc0_row2_col1" class="data row2 col1">patient presents to be tested for COVID-19. His wife recently tested positive for novel coronavirus. SARS-COV-2 results came back positive.</td>
<td id="T_befc0_row2_col2" class="data row2 col2">[@4d073b,69,77) "positive"</td>
<td id="T_befc0_row2_col3" class="data row2 col3">positive</td>
</tr>
<tr class="even">
<td id="T_befc0_row3_col0" class="data row3 col0">sample1.txt</td>
<td id="T_befc0_row3_col1" class="data row3 col1">patient presents to be tested for COVID-19. His wife recently tested positive for novel coronavirus. SARS-COV-2 results came back positive.</td>
<td id="T_befc0_row3_col2" class="data row3 col2">[@4d073b,82,99) "novel coro..."</td>
<td id="T_befc0_row3_col3" class="data row3 col3">COVID-19</td>
</tr>
<tr class="odd">
<td id="T_befc0_row4_col0" class="data row4 col0">sample1.txt</td>
<td id="T_befc0_row4_col1" class="data row4 col1">patient presents to be tested for COVID-19. His wife recently tested positive for novel coronavirus. SARS-COV-2 results came back positive.</td>
<td id="T_befc0_row4_col2" class="data row4 col2">[@4d073b,101,111) "SARS-COV-2"</td>
<td id="T_befc0_row4_col3" class="data row4 col3">COVID-19</td>
</tr>
<tr class="even">
<td id="T_befc0_row5_col0" class="data row5 col0">sample1.txt</td>
<td id="T_befc0_row5_col1" class="data row5 col1">patient presents to be tested for COVID-19. His wife recently tested positive for novel coronavirus. SARS-COV-2 results came back positive.</td>
<td id="T_befc0_row5_col2" class="data row5 col2">[@4d073b,130,138) "positive"</td>
<td id="T_befc0_row5_col3" class="data row5 col3">positive</td>
</tr>
<tr class="odd">
<td id="T_befc0_row6_col0" class="data row6 col0">sample10.txt</td>
<td id="T_befc0_row6_col1" class="data row6 col1">patient be screened for cov-19. results came back positive.</td>
<td id="T_befc0_row6_col2" class="data row6 col2">[@f3a9fd,0,7) "patient"</td>
<td id="T_befc0_row6_col3" class="data row6 col3">patient</td>
</tr>
<tr class="even">
<td id="T_befc0_row7_col0" class="data row7 col0">sample10.txt</td>
<td id="T_befc0_row7_col1" class="data row7 col1">patient be screened for cov-19. results came back positive.</td>
<td id="T_befc0_row7_col2" class="data row7 col2">[@f3a9fd,50,58) "positive"</td>
<td id="T_befc0_row7_col3" class="data row7 col3">positive</td>
</tr>
<tr class="odd">
<td id="T_befc0_row8_col0" class="data row8 col0">sample2.txt</td>
<td id="T_befc0_row8_col1" class="data row8 col1">The patient be tested for Coronavirus like_num. Results be positive. patient underwent no Coronavirus like_num education.</td>
<td id="T_befc0_row8_col2" class="data row8 col2">[@a5d37d,4,11) "patient"</td>
<td id="T_befc0_row8_col3" class="data row8 col3">patient</td>
</tr>
<tr class="even">
<td id="T_befc0_row9_col0" class="data row9 col0">sample2.txt</td>
<td id="T_befc0_row9_col1" class="data row9 col1">The patient be tested for Coronavirus like_num. Results be positive. patient underwent no Coronavirus like_num education.</td>
<td id="T_befc0_row9_col2" class="data row9 col2">[@a5d37d,26,37) "Coronaviru..."</td>
<td id="T_befc0_row9_col3" class="data row9 col3">COVID-19</td>
</tr>
<tr class="odd">
<td id="T_befc0_row10_col0" class="data row10 col0">sample2.txt</td>
<td id="T_befc0_row10_col1" class="data row10 col1">The patient be tested for Coronavirus like_num. Results be positive. patient underwent no Coronavirus like_num education.</td>
<td id="T_befc0_row10_col2" class="data row10 col2">[@a5d37d,59,67) "positive"</td>
<td id="T_befc0_row10_col3" class="data row10 col3">positive</td>
</tr>
<tr class="even">
<td id="T_befc0_row11_col0" class="data row11 col0">sample2.txt</td>
<td id="T_befc0_row11_col1" class="data row11 col1">The patient be tested for Coronavirus like_num. Results be positive. patient underwent no Coronavirus like_num education.</td>
<td id="T_befc0_row11_col2" class="data row11 col2">[@a5d37d,69,76) "patient"</td>
<td id="T_befc0_row11_col3" class="data row11 col3">patient</td>
</tr>
<tr class="odd">
<td id="T_befc0_row12_col0" class="data row12 col0">sample2.txt</td>
<td id="T_befc0_row12_col1" class="data row12 col1">The patient be tested for Coronavirus like_num. Results be positive. patient underwent no Coronavirus like_num education.</td>
<td id="T_befc0_row12_col2" class="data row12 col2">[@a5d37d,90,101) "Coronaviru..."</td>
<td id="T_befc0_row12_col3" class="data row12 col3">COVID-19</td>
</tr>
<tr class="even">
<td id="T_befc0_row13_col0" class="data row13 col0">sample3.txt</td>
<td id="T_befc0_row13_col1" class="data row13 col1">Problem List: like_num. Pneumonia like_num. Novel Coronavirus like_num</td>
<td id="T_befc0_row13_col2" class="data row13 col2">[@389fbb,44,61) "Novel Coro..."</td>
<td id="T_befc0_row13_col3" class="data row13 col3">COVID-19</td>
</tr>
<tr class="odd">
<td id="T_befc0_row14_col0" class="data row14 col0">sample4.txt</td>
<td id="T_befc0_row14_col1" class="data row14 col1">neg covid education.</td>
<td id="T_befc0_row14_col2" class="data row14 col2">[@3ac307,4,9) "covid"</td>
<td id="T_befc0_row14_col3" class="data row14 col3">COVID-19</td>
</tr>
<tr class="even">
<td id="T_befc0_row15_col0" class="data row15 col0">sample5.txt</td>
<td id="T_befc0_row15_col1" class="data row15 col1">positive covid precaution.</td>
<td id="T_befc0_row15_col2" class="data row15 col2">[@2e40a3,0,8) "positive"</td>
<td id="T_befc0_row15_col3" class="data row15 col3">positive</td>
</tr>
<tr class="odd">
<td id="T_befc0_row16_col0" class="data row16 col0">sample5.txt</td>
<td id="T_befc0_row16_col1" class="data row16 col1">positive covid precaution.</td>
<td id="T_befc0_row16_col2" class="data row16 col2">[@2e40a3,9,14) "covid"</td>
<td id="T_befc0_row16_col3" class="data row16 col3">COVID-19</td>
</tr>
<tr class="even">
<td id="T_befc0_row17_col0" class="data row17 col0">sample6.txt</td>
<td id="T_befc0_row17_col1" class="data row17 col1">The patient have reported novel coronavirus.</td>
<td id="T_befc0_row17_col2" class="data row17 col2">[@2473a3,4,11) "patient"</td>
<td id="T_befc0_row17_col3" class="data row17 col3">patient</td>
</tr>
<tr class="odd">
<td id="T_befc0_row18_col0" class="data row18 col0">sample6.txt</td>
<td id="T_befc0_row18_col1" class="data row18 col1">The patient have reported novel coronavirus.</td>
<td id="T_befc0_row18_col2" class="data row18 col2">[@2473a3,26,43) "novel coro..."</td>
<td id="T_befc0_row18_col3" class="data row18 col3">COVID-19</td>
</tr>
<tr class="even">
<td id="T_befc0_row19_col0" class="data row19 col0">sample8.txt</td>
<td id="T_befc0_row19_col1" class="data row19 col1">Patient be sent for a covid test. Someone be tested positive.</td>
<td id="T_befc0_row19_col2" class="data row19 col2">[@2893ce,0,7) "Patient"</td>
<td id="T_befc0_row19_col3" class="data row19 col3">patient</td>
</tr>
<tr class="odd">
<td id="T_befc0_row20_col0" class="data row20 col0">sample8.txt</td>
<td id="T_befc0_row20_col1" class="data row20 col1">Patient be sent for a covid test. Someone be tested positive.</td>
<td id="T_befc0_row20_col2" class="data row20 col2">[@2893ce,22,27) "covid"</td>
<td id="T_befc0_row20_col3" class="data row20 col3">COVID-19</td>
</tr>
<tr class="even">
<td id="T_befc0_row21_col0" class="data row21 col0">sample8.txt</td>
<td id="T_befc0_row21_col1" class="data row21 col1">Patient be sent for a covid test. Someone be tested positive.</td>
<td id="T_befc0_row21_col2" class="data row21 col2">[@2893ce,52,60) "positive"</td>
<td id="T_befc0_row21_col3" class="data row21 col3">positive</td>
</tr>
<tr class="odd">
<td id="T_befc0_row22_col0" class="data row22 col0">sample9.txt</td>
<td id="T_befc0_row22_col1" class="data row22 col1">Patient have contact patient with coronavirus. screening positive coronavirus.</td>
<td id="T_befc0_row22_col2" class="data row22 col2">[@539a7c,0,7) "Patient"</td>
<td id="T_befc0_row22_col3" class="data row22 col3">patient</td>
</tr>
<tr class="even">
<td id="T_befc0_row23_col0" class="data row23 col0">sample9.txt</td>
<td id="T_befc0_row23_col1" class="data row23 col1">Patient have contact patient with coronavirus. screening positive coronavirus.</td>
<td id="T_befc0_row23_col2" class="data row23 col2">[@539a7c,21,28) "patient"</td>
<td id="T_befc0_row23_col3" class="data row23 col3">patient</td>
</tr>
<tr class="odd">
<td id="T_befc0_row24_col0" class="data row24 col0">sample9.txt</td>
<td id="T_befc0_row24_col1" class="data row24 col1">Patient have contact patient with coronavirus. screening positive coronavirus.</td>
<td id="T_befc0_row24_col2" class="data row24 col2">[@539a7c,34,45) "coronaviru..."</td>
<td id="T_befc0_row24_col3" class="data row24 col3">COVID-19</td>
</tr>
<tr class="even">
<td id="T_befc0_row25_col0" class="data row25 col0">sample9.txt</td>
<td id="T_befc0_row25_col1" class="data row25 col1">Patient have contact patient with coronavirus. screening positive coronavirus.</td>
<td id="T_befc0_row25_col2" class="data row25 col2">[@539a7c,57,65) "positive"</td>
<td id="T_befc0_row25_col3" class="data row25 col3">positive</td>
</tr>
<tr class="odd">
<td id="T_befc0_row26_col0" class="data row26 col0">sample9.txt</td>
<td id="T_befc0_row26_col1" class="data row26 col1">Patient have contact patient with coronavirus. screening positive coronavirus.</td>
<td id="T_befc0_row26_col2" class="data row26 col2">[@539a7c,66,77) "coronaviru..."</td>
<td id="T_befc0_row26_col3" class="data row26 col3">COVID-19</td>
</tr>
</tbody>
</table>


<script type="module">
    const { DataTable, jQuery: $ } = await import(window._datatables_src_for_itables_2_1_4);

    document.querySelectorAll("#T_befc0:not(.dataTable)").forEach(table => {
        // Define the table data
        

        // Define the dt_args
        let dt_args = {"columnDefs": [{"targets": ["Path", "Doc", "Span", "Label"], "render": function(data, type, row) {
                    return '<div style="white-space: normal; word-wrap: break-word;">' + data + '</div>';
                }, "width": "300px"}], "escape": true, "layout": {"topStart": "pageLength", "topEnd": "search", "bottomStart": "info", "bottomEnd": "paging"}, "display_logo_when_loading": true, "order": []};
        

        
        new DataTable(table, dt_args);
    });
</script>
</div>
</div>
<div id="cell-73" class="cell">
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a>?Docs(<span class="st">"sample2.txt"</span>,D,V)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>'?Docs("sample2.txt",D,V)'</code></pre>
</div>
<div class="cell-output cell-output-display">
<style type="text/css">
#T_484d2_row0_col0, #T_484d2_row0_col1, #T_484d2_row1_col0, #T_484d2_row1_col1, #T_484d2_row2_col0, #T_484d2_row2_col1 {
  overflow-wrap: break-word;
  max-width: 800px;
  text-align: left;
}
</style>

<table id="T_484d2" class="display nowrap caption-top table table-sm table-striped small" data-quarto-postprocess="true">
<thead>
<tr class="header">
<th id="T_484d2_level0_col0" class="col_heading level0 col0" data-quarto-table-cell-role="th">D</th>
<th id="T_484d2_level0_col1" class="col_heading level0 col1" data-quarto-table-cell-role="th">V</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td id="T_484d2_row0_col0" class="data row0 col0">The patient be tested for COVID-19 like_num. Results be positive. patient underwent no COVID-19 like_num education.</td>
<td id="T_484d2_row0_col1" class="data row0 col1">lemma_concept</td>
</tr>
<tr class="even">
<td id="T_484d2_row1_col0" class="data row1 col0">The patient be tested for Coronavirus like_num. Results be positive. patient underwent no Coronavirus like_num education.</td>
<td id="T_484d2_row1_col1" class="data row1 col1">lemma</td>
</tr>
<tr class="odd">
<td id="T_484d2_row2_col0" class="data row2 col0">The patient was tested for Coronavirus 2019. Results are positive. Patient underwent no Coronavirus 2019 education.</td>
<td id="T_484d2_row2_col1" class="data row2 col1">raw_text</td>
</tr>
</tbody>
</table>


<script type="module">
    const { DataTable, jQuery: $ } = await import(window._datatables_src_for_itables_2_1_4);

    document.querySelectorAll("#T_484d2:not(.dataTable)").forEach(table => {
        // Define the table data
        

        // Define the dt_args
        let dt_args = {"columnDefs": [{"targets": ["D", "V"], "render": function(data, type, row) {
                    return '<div style="white-space: normal; word-wrap: break-word;">' + data + '</div>';
                }, "width": "300px"}], "escape": true, "layout": {"topStart": null, "topEnd": null, "bottomStart": null, "bottomEnd": null}, "display_logo_when_loading": true, "order": []};
        

        
        new DataTable(table, dt_args);
    });
</script>
</div>
</div>
<div id="cell-74" class="cell">
<div class="sourceCode cell-code" id="cb51"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a><span class="co"># here we get the spans of all POS</span></span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true" tabindex="-1"></a>Pos(P,D,Word,Lem)<span class="op">&lt;-</span>Docs(P,D,<span class="st">"lemma_concept"</span>),pos(D)<span class="op">-&gt;</span>(Word,Lem).</span>
<span id="cb51-3"><a href="#cb51-3" aria-hidden="true" tabindex="-1"></a>?Pos(<span class="st">"sample8.txt"</span>,D,Word,Lem)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>'?Pos("sample8.txt",D,Word,Lem)'</code></pre>
</div>
<div class="cell-output cell-output-display">
<style type="text/css">
#T_ddb4d_row0_col0, #T_ddb4d_row0_col1, #T_ddb4d_row0_col2, #T_ddb4d_row1_col0, #T_ddb4d_row1_col1, #T_ddb4d_row1_col2, #T_ddb4d_row2_col0, #T_ddb4d_row2_col1, #T_ddb4d_row2_col2, #T_ddb4d_row3_col0, #T_ddb4d_row3_col1, #T_ddb4d_row3_col2, #T_ddb4d_row4_col0, #T_ddb4d_row4_col1, #T_ddb4d_row4_col2 {
  overflow-wrap: break-word;
  max-width: 800px;
  text-align: left;
}
</style>

<table id="T_ddb4d" class="display nowrap caption-top table table-sm table-striped small" data-quarto-postprocess="true">
<thead>
<tr class="header">
<th id="T_ddb4d_level0_col0" class="col_heading level0 col0" data-quarto-table-cell-role="th">D</th>
<th id="T_ddb4d_level0_col1" class="col_heading level0 col1" data-quarto-table-cell-role="th">Word</th>
<th id="T_ddb4d_level0_col2" class="col_heading level0 col2" data-quarto-table-cell-role="th">Lem</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td id="T_ddb4d_row0_col0" class="data row0 col0">patient be sent for a COVID-19 test. Someone be tested positive.</td>
<td id="T_ddb4d_row0_col1" class="data row0 col1">[@1edc3c,0,7) "patient"</td>
<td id="T_ddb4d_row0_col2" class="data row0 col2">NOUN</td>
</tr>
<tr class="even">
<td id="T_ddb4d_row1_col0" class="data row1 col0">patient be sent for a COVID-19 test. Someone be tested positive.</td>
<td id="T_ddb4d_row1_col1" class="data row1 col1">[@1edc3c,22,30) "COVID-19"</td>
<td id="T_ddb4d_row1_col2" class="data row1 col2">NOUN</td>
</tr>
<tr class="odd">
<td id="T_ddb4d_row2_col0" class="data row2 col0">patient be sent for a COVID-19 test. Someone be tested positive.</td>
<td id="T_ddb4d_row2_col1" class="data row2 col1">[@1edc3c,31,35) "test"</td>
<td id="T_ddb4d_row2_col2" class="data row2 col2">NOUN</td>
</tr>
<tr class="even">
<td id="T_ddb4d_row3_col0" class="data row3 col0">patient be sent for a COVID-19 test. Someone be tested positive.</td>
<td id="T_ddb4d_row3_col1" class="data row3 col1">[@1edc3c,37,44) "Someone"</td>
<td id="T_ddb4d_row3_col2" class="data row3 col2">PRON</td>
</tr>
<tr class="odd">
<td id="T_ddb4d_row4_col0" class="data row4 col0">patient be sent for a COVID-19 test. Someone be tested positive.</td>
<td id="T_ddb4d_row4_col1" class="data row4 col1">[@1edc3c,55,63) "positive"</td>
<td id="T_ddb4d_row4_col2" class="data row4 col2">ADJ</td>
</tr>
</tbody>
</table>


<script type="module">
    const { DataTable, jQuery: $ } = await import(window._datatables_src_for_itables_2_1_4);

    document.querySelectorAll("#T_ddb4d:not(.dataTable)").forEach(table => {
        // Define the table data
        

        // Define the dt_args
        let dt_args = {"columnDefs": [{"targets": ["D", "Word", "Lem"], "render": function(data, type, row) {
                    return '<div style="white-space: normal; word-wrap: break-word;">' + data + '</div>';
                }, "width": "300px"}], "escape": true, "layout": {"topStart": null, "topEnd": null, "bottomStart": null, "bottomEnd": null}, "display_logo_when_loading": true, "order": []};
        

        
        new DataTable(table, dt_args);
    });
</script>
</div>
</div>
<div id="cell-75" class="cell">
<div class="sourceCode cell-code" id="cb53"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a><span class="co"># here we look for concept rule matches where the matched word is also tagged via POS</span></span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a>PosConceptMatches(Path,Doc,Span,Label) <span class="op">&lt;-</span> </span>
<span id="cb53-3"><a href="#cb53-3" aria-hidden="true" tabindex="-1"></a>    Docs(Path,Doc,<span class="st">"lemma_concept"</span>),</span>
<span id="cb53-4"><a href="#cb53-4" aria-hidden="true" tabindex="-1"></a>    ConceptTagRules(Pattern, Label, <span class="st">"pos"</span>),</span>
<span id="cb53-5"><a href="#cb53-5" aria-hidden="true" tabindex="-1"></a>    rgx(Pattern,Doc) <span class="op">-&gt;</span> (Span),</span>
<span id="cb53-6"><a href="#cb53-6" aria-hidden="true" tabindex="-1"></a>    Pos(Path,Doc,Span,POSLabel).</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>As we can see for example in sample8.txt, Someone changed to other_experiencer.</p>
<div id="cell-77" class="cell">
<div class="sourceCode cell-code" id="cb54"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a>TargetMatches(Path,Doc, Span, Label) <span class="op">&lt;-</span> </span>
<span id="cb54-2"><a href="#cb54-2" aria-hidden="true" tabindex="-1"></a>    Docs(Path,Doc,<span class="st">"pos_concept"</span>),</span>
<span id="cb54-3"><a href="#cb54-3" aria-hidden="true" tabindex="-1"></a>    TargetTagRules(Pattern, Label), rgx(Pattern,Doc) <span class="op">-&gt;</span> (Span).</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now that we have finished rewriting our documents, lets look at the rewritting of the example</p>
<div id="cell-79" class="cell">
<div class="sourceCode cell-code" id="cb55"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> doc,doc_type <span class="kw">in</span> sess.export(<span class="st">'?Docs("sample9.txt",D,V)'</span>).itertuples(index<span class="op">=</span><span class="va">False</span>,name<span class="op">=</span><span class="va">None</span>):</span>
<span id="cb55-2"><a href="#cb55-2" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(doc_type)</span>
<span id="cb55-3"><a href="#cb55-3" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(doc)</span>
<span id="cb55-4"><a href="#cb55-4" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"="</span><span class="op">*</span><span class="dv">80</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>raw_text
Patient had contact patient with coronavirus. screening positive coronavirus.
================================================================================
lemma
Patient have contact patient with coronavirus. screening positive coronavirus.
================================================================================
target_concept
patient have contact patient with COVID-19. positive coronavirus screening.
================================================================================
lemma_concept
patient have contact patient with COVID-19. screening positive COVID-19.
================================================================================
pos_concept
patient have contact patient with COVID-19. screening positive COVID-19.
================================================================================</code></pre>
</div>
</div>
</section>
<section id="splitting-text-by-sentence-and-section" class="level3">
<h3 class="anchored" data-anchor-id="splitting-text-by-sentence-and-section">Splitting text by sentence and section</h3>
<p>We have now finished our rewriting, This section replaces the sectionizer, and the parts of the context and postprocessing sections that deal with sentence splitting logic.</p>
<section id="breaking-text-into-sections" class="level4">
<h4 class="anchored" data-anchor-id="breaking-text-into-sections">Breaking text into sections</h4>
<div id="cell-83" class="cell">
<div class="sourceCode cell-code" id="cb57"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a><span class="co"># we get section spans and their content using our regex pattern and the rgx_split ie function</span></span>
<span id="cb57-2"><a href="#cb57-2" aria-hidden="true" tabindex="-1"></a>Sections(P,D,Sec,Content)<span class="op">&lt;-</span>Docs(P,D,<span class="st">"target_concept"</span>),</span>
<span id="cb57-3"><a href="#cb57-3" aria-hidden="true" tabindex="-1"></a>    rgx_split($section_delimeter_pattern,D)<span class="op">-&gt;</span>(SecSpan,Content),</span>
<span id="cb57-4"><a href="#cb57-4" aria-hidden="true" tabindex="-1"></a>    as_str(SecSpan)<span class="op">-&gt;</span>(Sec).</span>
<span id="cb57-5"><a href="#cb57-5" aria-hidden="true" tabindex="-1"></a>?Sections(P,D,Sec,Content)</span>
<span id="cb57-6"><a href="#cb57-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-7"><a href="#cb57-7" aria-hidden="true" tabindex="-1"></a>PositiveSections(P,D,Sec,Content)<span class="op">&lt;-</span>Sections(P,D,Sec,Content),SectionTags(Sec,Tag),PositiveSectionTags(Tag).</span>
<span id="cb57-8"><a href="#cb57-8" aria-hidden="true" tabindex="-1"></a>?PositiveSections(P,D,Sec,Content)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>'?Sections(P,D,Sec,Content)'</code></pre>
</div>
<div class="cell-output cell-output-display">
<style type="text/css">
#T_86364_row0_col0, #T_86364_row0_col1, #T_86364_row0_col2, #T_86364_row0_col3 {
  overflow-wrap: break-word;
  max-width: 800px;
  text-align: left;
}
</style>

<table id="T_86364" class="display nowrap caption-top table table-sm table-striped small" data-quarto-postprocess="true">
<thead>
<tr class="header">
<th id="T_86364_level0_col0" class="col_heading level0 col0" data-quarto-table-cell-role="th">P</th>
<th id="T_86364_level0_col1" class="col_heading level0 col1" data-quarto-table-cell-role="th">D</th>
<th id="T_86364_level0_col2" class="col_heading level0 col2" data-quarto-table-cell-role="th">Sec</th>
<th id="T_86364_level0_col3" class="col_heading level0 col3" data-quarto-table-cell-role="th">Content</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td id="T_86364_row0_col0" class="data row0 col0">sample3.txt</td>
<td id="T_86364_row0_col1" class="data row0 col1">Problem List: like_num. Pneumonia like_num. COVID-19 like_num</td>
<td id="T_86364_row0_col2" class="data row0 col2">Problem List:</td>
<td id="T_86364_row0_col3" class="data row0 col3">[@882253,13,62) " like_num...."</td>
</tr>
</tbody>
</table>


<script type="module">
    const { DataTable, jQuery: $ } = await import(window._datatables_src_for_itables_2_1_4);

    document.querySelectorAll("#T_86364:not(.dataTable)").forEach(table => {
        // Define the table data
        

        // Define the dt_args
        let dt_args = {"columnDefs": [{"targets": ["P", "D", "Sec", "Content"], "render": function(data, type, row) {
                    return '<div style="white-space: normal; word-wrap: break-word;">' + data + '</div>';
                }, "width": "300px"}], "escape": true, "layout": {"topStart": null, "topEnd": null, "bottomStart": null, "bottomEnd": null}, "display_logo_when_loading": true, "order": []};
        

        
        new DataTable(table, dt_args);
    });
</script>
</div>
<div class="cell-output cell-output-display">
<pre><code>'?PositiveSections(P,D,Sec,Content)'</code></pre>
</div>
<div class="cell-output cell-output-display">
<style type="text/css">
#T_e29dc_row0_col0, #T_e29dc_row0_col1, #T_e29dc_row0_col2, #T_e29dc_row0_col3 {
  overflow-wrap: break-word;
  max-width: 800px;
  text-align: left;
}
</style>

<table id="T_e29dc" class="display nowrap caption-top table table-sm table-striped small" data-quarto-postprocess="true">
<thead>
<tr class="header">
<th id="T_e29dc_level0_col0" class="col_heading level0 col0" data-quarto-table-cell-role="th">P</th>
<th id="T_e29dc_level0_col1" class="col_heading level0 col1" data-quarto-table-cell-role="th">D</th>
<th id="T_e29dc_level0_col2" class="col_heading level0 col2" data-quarto-table-cell-role="th">Sec</th>
<th id="T_e29dc_level0_col3" class="col_heading level0 col3" data-quarto-table-cell-role="th">Content</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td id="T_e29dc_row0_col0" class="data row0 col0">sample3.txt</td>
<td id="T_e29dc_row0_col1" class="data row0 col1">Problem List: like_num. Pneumonia like_num. COVID-19 like_num</td>
<td id="T_e29dc_row0_col2" class="data row0 col2">Problem List:</td>
<td id="T_e29dc_row0_col3" class="data row0 col3">[@882253,13,62) " like_num...."</td>
</tr>
</tbody>
</table>


<script type="module">
    const { DataTable, jQuery: $ } = await import(window._datatables_src_for_itables_2_1_4);

    document.querySelectorAll("#T_e29dc:not(.dataTable)").forEach(table => {
        // Define the table data
        

        // Define the dt_args
        let dt_args = {"columnDefs": [{"targets": ["P", "D", "Sec", "Content"], "render": function(data, type, row) {
                    return '<div style="white-space: normal; word-wrap: break-word;">' + data + '</div>';
                }, "width": "300px"}], "escape": true, "layout": {"topStart": null, "topEnd": null, "bottomStart": null, "bottomEnd": null}, "display_logo_when_loading": true, "order": []};
        

        
        new DataTable(table, dt_args);
    });
</script>
</div>
</div>
</section>
<section id="breaking-texts-into-sentences" class="level4">
<h4 class="anchored" data-anchor-id="breaking-texts-into-sentences">Breaking texts into sentences</h4>
<div id="cell-85" class="cell">
<div class="sourceCode cell-code" id="cb60"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a>Sents(P,S)<span class="op">&lt;-</span>Docs(P,D,<span class="st">"target_concept"</span>),split_sentence(D)<span class="op">-&gt;</span>(S).</span>
<span id="cb60-2"><a href="#cb60-2" aria-hidden="true" tabindex="-1"></a>?Sents(P,S)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>'?Sents(P,S)'</code></pre>
</div>
<div class="cell-output cell-output-display">
<style type="text/css">
#T_52afb_row0_col0, #T_52afb_row0_col1, #T_52afb_row1_col0, #T_52afb_row1_col1, #T_52afb_row2_col0, #T_52afb_row2_col1, #T_52afb_row3_col0, #T_52afb_row3_col1, #T_52afb_row4_col0, #T_52afb_row4_col1, #T_52afb_row5_col0, #T_52afb_row5_col1, #T_52afb_row6_col0, #T_52afb_row6_col1, #T_52afb_row7_col0, #T_52afb_row7_col1, #T_52afb_row8_col0, #T_52afb_row8_col1, #T_52afb_row9_col0, #T_52afb_row9_col1, #T_52afb_row10_col0, #T_52afb_row10_col1, #T_52afb_row11_col0, #T_52afb_row11_col1, #T_52afb_row12_col0, #T_52afb_row12_col1, #T_52afb_row13_col0, #T_52afb_row13_col1, #T_52afb_row14_col0, #T_52afb_row14_col1, #T_52afb_row15_col0, #T_52afb_row15_col1, #T_52afb_row16_col0, #T_52afb_row16_col1, #T_52afb_row17_col0, #T_52afb_row17_col1, #T_52afb_row18_col0, #T_52afb_row18_col1 {
  overflow-wrap: break-word;
  max-width: 800px;
  text-align: left;
}
</style>

<table id="T_52afb" class="display nowrap caption-top table table-sm table-striped small" data-quarto-postprocess="true">
<thead>
<tr class="header">
<th id="T_52afb_level0_col0" class="col_heading level0 col0" data-quarto-table-cell-role="th">P</th>
<th id="T_52afb_level0_col1" class="col_heading level0 col1" data-quarto-table-cell-role="th">S</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td id="T_52afb_row0_col0" class="data row0 col0">sample1.txt</td>
<td id="T_52afb_row0_col1" class="data row0 col1">[@931cb5,0,43) "patient pr..."</td>
</tr>
<tr class="even">
<td id="T_52afb_row1_col0" class="data row1 col0">sample1.txt</td>
<td id="T_52afb_row1_col1" class="data row1 col1">[@931cb5,44,93) "His family..."</td>
</tr>
<tr class="odd">
<td id="T_52afb_row2_col0" class="data row2 col0">sample1.txt</td>
<td id="T_52afb_row2_col1" class="data row2 col1">[@931cb5,94,130) "COVID-19 r..."</td>
</tr>
<tr class="even">
<td id="T_52afb_row3_col0" class="data row3 col0">sample10.txt</td>
<td id="T_52afb_row3_col1" class="data row3 col1">[@f3a9fd,0,31) "patient be..."</td>
</tr>
<tr class="odd">
<td id="T_52afb_row4_col0" class="data row4 col0">sample10.txt</td>
<td id="T_52afb_row4_col1" class="data row4 col1">[@f3a9fd,32,59) "results ca..."</td>
</tr>
<tr class="even">
<td id="T_52afb_row5_col0" class="data row5 col0">sample2.txt</td>
<td id="T_52afb_row5_col1" class="data row5 col1">[@e4b074,0,44) "The patien..."</td>
</tr>
<tr class="odd">
<td id="T_52afb_row6_col0" class="data row6 col0">sample2.txt</td>
<td id="T_52afb_row6_col1" class="data row6 col1">[@e4b074,45,65) "Results be..."</td>
</tr>
<tr class="even">
<td id="T_52afb_row7_col0" class="data row7 col0">sample2.txt</td>
<td id="T_52afb_row7_col1" class="data row7 col1">[@e4b074,66,115) "patient un..."</td>
</tr>
<tr class="odd">
<td id="T_52afb_row8_col0" class="data row8 col0">sample3.txt</td>
<td id="T_52afb_row8_col1" class="data row8 col1">[@882253,0,23) "Problem Li..."</td>
</tr>
<tr class="even">
<td id="T_52afb_row9_col0" class="data row9 col0">sample3.txt</td>
<td id="T_52afb_row9_col1" class="data row9 col1">[@882253,24,43) "Pneumonia ..."</td>
</tr>
<tr class="odd">
<td id="T_52afb_row10_col0" class="data row10 col0">sample3.txt</td>
<td id="T_52afb_row10_col1" class="data row10 col1">[@882253,44,61) "COVID-19 l..."</td>
</tr>
<tr class="even">
<td id="T_52afb_row11_col0" class="data row11 col0">sample4.txt</td>
<td id="T_52afb_row11_col1" class="data row11 col1">[@77c574,0,23) "neg COVID-..."</td>
</tr>
<tr class="odd">
<td id="T_52afb_row12_col0" class="data row12 col0">sample5.txt</td>
<td id="T_52afb_row12_col1" class="data row12 col1">[@ffb7c7,0,29) "positive C..."</td>
</tr>
<tr class="even">
<td id="T_52afb_row13_col0" class="data row13 col0">sample6.txt</td>
<td id="T_52afb_row13_col1" class="data row13 col1">[@b2612f,0,35) "The patien..."</td>
</tr>
<tr class="odd">
<td id="T_52afb_row14_col0" class="data row14 col0">sample7.txt</td>
<td id="T_52afb_row14_col1" class="data row14 col1">[@a2c41c,0,82) "Elevated c..."</td>
</tr>
<tr class="even">
<td id="T_52afb_row15_col0" class="data row15 col0">sample8.txt</td>
<td id="T_52afb_row15_col1" class="data row15 col1">[@3db2e4,0,36) "patient be..."</td>
</tr>
<tr class="odd">
<td id="T_52afb_row16_col0" class="data row16 col0">sample8.txt</td>
<td id="T_52afb_row16_col1" class="data row16 col1">[@3db2e4,37,74) "other_expe..."</td>
</tr>
<tr class="even">
<td id="T_52afb_row17_col0" class="data row17 col0">sample9.txt</td>
<td id="T_52afb_row17_col1" class="data row17 col1">[@6d2862,0,43) "patient ha..."</td>
</tr>
<tr class="odd">
<td id="T_52afb_row18_col0" class="data row18 col0">sample9.txt</td>
<td id="T_52afb_row18_col1" class="data row18 col1">[@6d2862,44,75) "positive c..."</td>
</tr>
</tbody>
</table>


<script type="module">
    const { DataTable, jQuery: $ } = await import(window._datatables_src_for_itables_2_1_4);

    document.querySelectorAll("#T_52afb:not(.dataTable)").forEach(table => {
        // Define the table data
        

        // Define the dt_args
        let dt_args = {"columnDefs": [{"targets": ["P", "S"], "render": function(data, type, row) {
                    return '<div style="white-space: normal; word-wrap: break-word;">' + data + '</div>';
                }, "width": "300px"}], "escape": true, "layout": {"topStart": "pageLength", "topEnd": "search", "bottomStart": "info", "bottomEnd": "paging"}, "display_logo_when_loading": true, "order": []};
        

        
        new DataTable(table, dt_args);
    });
</script>
</div>
</div>
</section>
<section id="pair-of-sentences" class="level4">
<h4 class="anchored" data-anchor-id="pair-of-sentences">Pair of sentences</h4>
<p>We will show 3 ways of getting pairs of adjacent sentences, The first is simply to make an ie function out of them</p>
<section id="alternative-1-build-a-dedicated-ie-function" class="level5">
<h5 class="anchored" data-anchor-id="alternative-1-build-a-dedicated-ie-function">Alternative 1, build a dedicated ie function</h5>
<div id="cell-89" class="cell">
<div class="sourceCode cell-code" id="cb62"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> itertools <span class="im">import</span> pairwise</span>
<span id="cb62-2"><a href="#cb62-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-3"><a href="#cb62-3" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> sentence_pairs(text):</span>
<span id="cb62-4"><a href="#cb62-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">yield</span> <span class="cf">from</span> pairwise(split_sentence(text))</span>
<span id="cb62-5"><a href="#cb62-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-6"><a href="#cb62-6" aria-hidden="true" tabindex="-1"></a>sess.register(<span class="st">'sentence_pairs'</span>,sentence_pairs,[(<span class="bu">str</span>,Span)],[Span,Span])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-90" class="cell">
<div class="sourceCode cell-code" id="cb63"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a>SentPairs_ver1(P,S1,S2)<span class="op">&lt;-</span>Docs(P,D,<span class="st">"target_concept"</span>),sentence_pairs(D)<span class="op">-&gt;</span>(S1,S2).</span>
<span id="cb63-2"><a href="#cb63-2" aria-hidden="true" tabindex="-1"></a>?SentPairs_ver1(P,S1,S2)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>'?SentPairs_ver1(P,S1,S2)'</code></pre>
</div>
<div class="cell-output cell-output-display">
<style type="text/css">
#T_5a063_row0_col0, #T_5a063_row0_col1, #T_5a063_row0_col2, #T_5a063_row1_col0, #T_5a063_row1_col1, #T_5a063_row1_col2, #T_5a063_row2_col0, #T_5a063_row2_col1, #T_5a063_row2_col2, #T_5a063_row3_col0, #T_5a063_row3_col1, #T_5a063_row3_col2, #T_5a063_row4_col0, #T_5a063_row4_col1, #T_5a063_row4_col2, #T_5a063_row5_col0, #T_5a063_row5_col1, #T_5a063_row5_col2, #T_5a063_row6_col0, #T_5a063_row6_col1, #T_5a063_row6_col2, #T_5a063_row7_col0, #T_5a063_row7_col1, #T_5a063_row7_col2, #T_5a063_row8_col0, #T_5a063_row8_col1, #T_5a063_row8_col2 {
  overflow-wrap: break-word;
  max-width: 800px;
  text-align: left;
}
</style>

<table id="T_5a063" class="display nowrap caption-top table table-sm table-striped small" data-quarto-postprocess="true">
<thead>
<tr class="header">
<th id="T_5a063_level0_col0" class="col_heading level0 col0" data-quarto-table-cell-role="th">P</th>
<th id="T_5a063_level0_col1" class="col_heading level0 col1" data-quarto-table-cell-role="th">S1</th>
<th id="T_5a063_level0_col2" class="col_heading level0 col2" data-quarto-table-cell-role="th">S2</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td id="T_5a063_row0_col0" class="data row0 col0">sample1.txt</td>
<td id="T_5a063_row0_col1" class="data row0 col1">[@931cb5,0,43) "patient pr..."</td>
<td id="T_5a063_row0_col2" class="data row0 col2">[@931cb5,44,93) "His family..."</td>
</tr>
<tr class="even">
<td id="T_5a063_row1_col0" class="data row1 col0">sample1.txt</td>
<td id="T_5a063_row1_col1" class="data row1 col1">[@931cb5,44,93) "His family..."</td>
<td id="T_5a063_row1_col2" class="data row1 col2">[@931cb5,94,130) "COVID-19 r..."</td>
</tr>
<tr class="odd">
<td id="T_5a063_row2_col0" class="data row2 col0">sample10.txt</td>
<td id="T_5a063_row2_col1" class="data row2 col1">[@f3a9fd,0,31) "patient be..."</td>
<td id="T_5a063_row2_col2" class="data row2 col2">[@f3a9fd,32,59) "results ca..."</td>
</tr>
<tr class="even">
<td id="T_5a063_row3_col0" class="data row3 col0">sample2.txt</td>
<td id="T_5a063_row3_col1" class="data row3 col1">[@e4b074,0,44) "The patien..."</td>
<td id="T_5a063_row3_col2" class="data row3 col2">[@e4b074,45,65) "Results be..."</td>
</tr>
<tr class="odd">
<td id="T_5a063_row4_col0" class="data row4 col0">sample2.txt</td>
<td id="T_5a063_row4_col1" class="data row4 col1">[@e4b074,45,65) "Results be..."</td>
<td id="T_5a063_row4_col2" class="data row4 col2">[@e4b074,66,115) "patient un..."</td>
</tr>
<tr class="even">
<td id="T_5a063_row5_col0" class="data row5 col0">sample3.txt</td>
<td id="T_5a063_row5_col1" class="data row5 col1">[@882253,0,23) "Problem Li..."</td>
<td id="T_5a063_row5_col2" class="data row5 col2">[@882253,24,43) "Pneumonia ..."</td>
</tr>
<tr class="odd">
<td id="T_5a063_row6_col0" class="data row6 col0">sample3.txt</td>
<td id="T_5a063_row6_col1" class="data row6 col1">[@882253,24,43) "Pneumonia ..."</td>
<td id="T_5a063_row6_col2" class="data row6 col2">[@882253,44,61) "COVID-19 l..."</td>
</tr>
<tr class="even">
<td id="T_5a063_row7_col0" class="data row7 col0">sample8.txt</td>
<td id="T_5a063_row7_col1" class="data row7 col1">[@3db2e4,0,36) "patient be..."</td>
<td id="T_5a063_row7_col2" class="data row7 col2">[@3db2e4,37,74) "other_expe..."</td>
</tr>
<tr class="odd">
<td id="T_5a063_row8_col0" class="data row8 col0">sample9.txt</td>
<td id="T_5a063_row8_col1" class="data row8 col1">[@6d2862,0,43) "patient ha..."</td>
<td id="T_5a063_row8_col2" class="data row8 col2">[@6d2862,44,75) "positive c..."</td>
</tr>
</tbody>
</table>


<script type="module">
    const { DataTable, jQuery: $ } = await import(window._datatables_src_for_itables_2_1_4);

    document.querySelectorAll("#T_5a063:not(.dataTable)").forEach(table => {
        // Define the table data
        

        // Define the dt_args
        let dt_args = {"columnDefs": [{"targets": ["P", "S1", "S2"], "render": function(data, type, row) {
                    return '<div style="white-space: normal; word-wrap: break-word;">' + data + '</div>';
                }, "width": "300px"}], "escape": true, "layout": {"topStart": null, "topEnd": null, "bottomStart": null, "bottomEnd": null}, "display_logo_when_loading": true, "order": []};
        

        
        new DataTable(table, dt_args);
    });
</script>
</div>
</div>
<p>The weakness in this approach is that we had build an IE function to do the extraction from scratch, obfuscating the fact that it and the split_sentence ie function share some logic. In our case since generating adjacent pairs is simple using itertools, this wasn’t so bad.</p>
</section>
<section id="generate-pairs-declaratively-and-build-a-filter-ie-function" class="level5">
<h5 class="anchored" data-anchor-id="generate-pairs-declaratively-and-build-a-filter-ie-function">Generate pairs declaratively, and build a filter ie function</h5>
<div id="cell-93" class="cell">
<div class="sourceCode cell-code" id="cb65"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> is_adjacent(span1,span2):</span>
<span id="cb65-2"><a href="#cb65-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">yield</span> span1.doc<span class="op">==</span>span2.doc <span class="kw">and</span> span1.end <span class="op">+</span><span class="dv">1</span> <span class="op">==</span> span2.start</span>
<span id="cb65-3"><a href="#cb65-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-4"><a href="#cb65-4" aria-hidden="true" tabindex="-1"></a>sess.register(<span class="st">'is_adjacent'</span>,is_adjacent,[Span,Span],[<span class="bu">bool</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-94" class="cell">
<div class="sourceCode cell-code" id="cb66"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb66-1"><a href="#cb66-1" aria-hidden="true" tabindex="-1"></a>SentPairs_ver2(P,S1,S2)<span class="op">&lt;-</span>Sents(P,S1),Sents(P,S2),is_adjacent(S1,S2)<span class="op">-&gt;</span>(<span class="va">True</span>).</span>
<span id="cb66-2"><a href="#cb66-2" aria-hidden="true" tabindex="-1"></a>?SentPairs_ver2(P,S1,S2)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>'?SentPairs_ver2(P,S1,S2)'</code></pre>
</div>
<div class="cell-output cell-output-display">
<style type="text/css">
#T_287f0_row0_col0, #T_287f0_row0_col1, #T_287f0_row0_col2, #T_287f0_row1_col0, #T_287f0_row1_col1, #T_287f0_row1_col2, #T_287f0_row2_col0, #T_287f0_row2_col1, #T_287f0_row2_col2, #T_287f0_row3_col0, #T_287f0_row3_col1, #T_287f0_row3_col2, #T_287f0_row4_col0, #T_287f0_row4_col1, #T_287f0_row4_col2, #T_287f0_row5_col0, #T_287f0_row5_col1, #T_287f0_row5_col2, #T_287f0_row6_col0, #T_287f0_row6_col1, #T_287f0_row6_col2, #T_287f0_row7_col0, #T_287f0_row7_col1, #T_287f0_row7_col2, #T_287f0_row8_col0, #T_287f0_row8_col1, #T_287f0_row8_col2 {
  overflow-wrap: break-word;
  max-width: 800px;
  text-align: left;
}
</style>

<table id="T_287f0" class="display nowrap caption-top table table-sm table-striped small" data-quarto-postprocess="true">
<thead>
<tr class="header">
<th id="T_287f0_level0_col0" class="col_heading level0 col0" data-quarto-table-cell-role="th">P</th>
<th id="T_287f0_level0_col1" class="col_heading level0 col1" data-quarto-table-cell-role="th">S1</th>
<th id="T_287f0_level0_col2" class="col_heading level0 col2" data-quarto-table-cell-role="th">S2</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td id="T_287f0_row0_col0" class="data row0 col0">sample1.txt</td>
<td id="T_287f0_row0_col1" class="data row0 col1">[@931cb5,0,43) "patient pr..."</td>
<td id="T_287f0_row0_col2" class="data row0 col2">[@931cb5,44,93) "His family..."</td>
</tr>
<tr class="even">
<td id="T_287f0_row1_col0" class="data row1 col0">sample1.txt</td>
<td id="T_287f0_row1_col1" class="data row1 col1">[@931cb5,44,93) "His family..."</td>
<td id="T_287f0_row1_col2" class="data row1 col2">[@931cb5,94,130) "COVID-19 r..."</td>
</tr>
<tr class="odd">
<td id="T_287f0_row2_col0" class="data row2 col0">sample10.txt</td>
<td id="T_287f0_row2_col1" class="data row2 col1">[@f3a9fd,0,31) "patient be..."</td>
<td id="T_287f0_row2_col2" class="data row2 col2">[@f3a9fd,32,59) "results ca..."</td>
</tr>
<tr class="even">
<td id="T_287f0_row3_col0" class="data row3 col0">sample2.txt</td>
<td id="T_287f0_row3_col1" class="data row3 col1">[@e4b074,0,44) "The patien..."</td>
<td id="T_287f0_row3_col2" class="data row3 col2">[@e4b074,45,65) "Results be..."</td>
</tr>
<tr class="odd">
<td id="T_287f0_row4_col0" class="data row4 col0">sample2.txt</td>
<td id="T_287f0_row4_col1" class="data row4 col1">[@e4b074,45,65) "Results be..."</td>
<td id="T_287f0_row4_col2" class="data row4 col2">[@e4b074,66,115) "patient un..."</td>
</tr>
<tr class="even">
<td id="T_287f0_row5_col0" class="data row5 col0">sample3.txt</td>
<td id="T_287f0_row5_col1" class="data row5 col1">[@882253,0,23) "Problem Li..."</td>
<td id="T_287f0_row5_col2" class="data row5 col2">[@882253,24,43) "Pneumonia ..."</td>
</tr>
<tr class="odd">
<td id="T_287f0_row6_col0" class="data row6 col0">sample3.txt</td>
<td id="T_287f0_row6_col1" class="data row6 col1">[@882253,24,43) "Pneumonia ..."</td>
<td id="T_287f0_row6_col2" class="data row6 col2">[@882253,44,61) "COVID-19 l..."</td>
</tr>
<tr class="even">
<td id="T_287f0_row7_col0" class="data row7 col0">sample8.txt</td>
<td id="T_287f0_row7_col1" class="data row7 col1">[@3db2e4,0,36) "patient be..."</td>
<td id="T_287f0_row7_col2" class="data row7 col2">[@3db2e4,37,74) "other_expe..."</td>
</tr>
<tr class="odd">
<td id="T_287f0_row8_col0" class="data row8 col0">sample9.txt</td>
<td id="T_287f0_row8_col1" class="data row8 col1">[@6d2862,0,43) "patient ha..."</td>
<td id="T_287f0_row8_col2" class="data row8 col2">[@6d2862,44,75) "positive c..."</td>
</tr>
</tbody>
</table>


<script type="module">
    const { DataTable, jQuery: $ } = await import(window._datatables_src_for_itables_2_1_4);

    document.querySelectorAll("#T_287f0:not(.dataTable)").forEach(table => {
        // Define the table data
        

        // Define the dt_args
        let dt_args = {"columnDefs": [{"targets": ["P", "S1", "S2"], "render": function(data, type, row) {
                    return '<div style="white-space: normal; word-wrap: break-word;">' + data + '</div>';
                }, "width": "300px"}], "escape": true, "layout": {"topStart": null, "topEnd": null, "bottomStart": null, "bottomEnd": null}, "display_logo_when_loading": true, "order": []};
        

        
        new DataTable(table, dt_args);
    });
</script>
</div>
</div>
<p>This is simpler than the first alternative, and we get to reuse the Sent rules, however it might seem a little bother some to implement and register an ie function for every so called “WHERE” clause we would like to implement.</p>
</section>
<section id="third-alternative-a-generic-boolean-expression-evaluator" class="level5">
<h5 class="anchored" data-anchor-id="third-alternative-a-generic-boolean-expression-evaluator">Third alternative, a generic boolean expression evaluator</h5>
<div id="cell-97" class="cell">
<div class="sourceCode cell-code" id="cb68"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb68-1"><a href="#cb68-1" aria-hidden="true" tabindex="-1"></a>SentPairs(P,S1,S2)<span class="op">&lt;-</span>Sents(P,S1),Sents(P,S2),expr_eval(<span class="st">"</span><span class="sc">{0}</span><span class="st">.end +1 == </span><span class="sc">{1}</span><span class="st">.start"</span>,S1,S2)<span class="op">-&gt;</span>(<span class="va">True</span>).</span>
<span id="cb68-2"><a href="#cb68-2" aria-hidden="true" tabindex="-1"></a>?SentPairs(P,S1,S2)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>'?SentPairs(P,S1,S2)'</code></pre>
</div>
<div class="cell-output cell-output-display">
<style type="text/css">
#T_35fee_row0_col0, #T_35fee_row0_col1, #T_35fee_row0_col2, #T_35fee_row1_col0, #T_35fee_row1_col1, #T_35fee_row1_col2, #T_35fee_row2_col0, #T_35fee_row2_col1, #T_35fee_row2_col2, #T_35fee_row3_col0, #T_35fee_row3_col1, #T_35fee_row3_col2, #T_35fee_row4_col0, #T_35fee_row4_col1, #T_35fee_row4_col2, #T_35fee_row5_col0, #T_35fee_row5_col1, #T_35fee_row5_col2, #T_35fee_row6_col0, #T_35fee_row6_col1, #T_35fee_row6_col2, #T_35fee_row7_col0, #T_35fee_row7_col1, #T_35fee_row7_col2, #T_35fee_row8_col0, #T_35fee_row8_col1, #T_35fee_row8_col2 {
  overflow-wrap: break-word;
  max-width: 800px;
  text-align: left;
}
</style>

<table id="T_35fee" class="display nowrap caption-top table table-sm table-striped small" data-quarto-postprocess="true">
<thead>
<tr class="header">
<th id="T_35fee_level0_col0" class="col_heading level0 col0" data-quarto-table-cell-role="th">P</th>
<th id="T_35fee_level0_col1" class="col_heading level0 col1" data-quarto-table-cell-role="th">S1</th>
<th id="T_35fee_level0_col2" class="col_heading level0 col2" data-quarto-table-cell-role="th">S2</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td id="T_35fee_row0_col0" class="data row0 col0">sample1.txt</td>
<td id="T_35fee_row0_col1" class="data row0 col1">[@931cb5,0,43) "patient pr..."</td>
<td id="T_35fee_row0_col2" class="data row0 col2">[@931cb5,44,93) "His family..."</td>
</tr>
<tr class="even">
<td id="T_35fee_row1_col0" class="data row1 col0">sample1.txt</td>
<td id="T_35fee_row1_col1" class="data row1 col1">[@931cb5,44,93) "His family..."</td>
<td id="T_35fee_row1_col2" class="data row1 col2">[@931cb5,94,130) "COVID-19 r..."</td>
</tr>
<tr class="odd">
<td id="T_35fee_row2_col0" class="data row2 col0">sample10.txt</td>
<td id="T_35fee_row2_col1" class="data row2 col1">[@f3a9fd,0,31) "patient be..."</td>
<td id="T_35fee_row2_col2" class="data row2 col2">[@f3a9fd,32,59) "results ca..."</td>
</tr>
<tr class="even">
<td id="T_35fee_row3_col0" class="data row3 col0">sample2.txt</td>
<td id="T_35fee_row3_col1" class="data row3 col1">[@e4b074,0,44) "The patien..."</td>
<td id="T_35fee_row3_col2" class="data row3 col2">[@e4b074,45,65) "Results be..."</td>
</tr>
<tr class="odd">
<td id="T_35fee_row4_col0" class="data row4 col0">sample2.txt</td>
<td id="T_35fee_row4_col1" class="data row4 col1">[@e4b074,45,65) "Results be..."</td>
<td id="T_35fee_row4_col2" class="data row4 col2">[@e4b074,66,115) "patient un..."</td>
</tr>
<tr class="even">
<td id="T_35fee_row5_col0" class="data row5 col0">sample3.txt</td>
<td id="T_35fee_row5_col1" class="data row5 col1">[@882253,0,23) "Problem Li..."</td>
<td id="T_35fee_row5_col2" class="data row5 col2">[@882253,24,43) "Pneumonia ..."</td>
</tr>
<tr class="odd">
<td id="T_35fee_row6_col0" class="data row6 col0">sample3.txt</td>
<td id="T_35fee_row6_col1" class="data row6 col1">[@882253,24,43) "Pneumonia ..."</td>
<td id="T_35fee_row6_col2" class="data row6 col2">[@882253,44,61) "COVID-19 l..."</td>
</tr>
<tr class="even">
<td id="T_35fee_row7_col0" class="data row7 col0">sample8.txt</td>
<td id="T_35fee_row7_col1" class="data row7 col1">[@3db2e4,0,36) "patient be..."</td>
<td id="T_35fee_row7_col2" class="data row7 col2">[@3db2e4,37,74) "other_expe..."</td>
</tr>
<tr class="odd">
<td id="T_35fee_row8_col0" class="data row8 col0">sample9.txt</td>
<td id="T_35fee_row8_col1" class="data row8 col1">[@6d2862,0,43) "patient ha..."</td>
<td id="T_35fee_row8_col2" class="data row8 col2">[@6d2862,44,75) "positive c..."</td>
</tr>
</tbody>
</table>


<script type="module">
    const { DataTable, jQuery: $ } = await import(window._datatables_src_for_itables_2_1_4);

    document.querySelectorAll("#T_35fee:not(.dataTable)").forEach(table => {
        // Define the table data
        

        // Define the dt_args
        let dt_args = {"columnDefs": [{"targets": ["P", "S1", "S2"], "render": function(data, type, row) {
                    return '<div style="white-space: normal; word-wrap: break-word;">' + data + '</div>';
                }, "width": "300px"}], "escape": true, "layout": {"topStart": null, "topEnd": null, "bottomStart": null, "bottomEnd": null}, "display_logo_when_loading": true, "order": []};
        

        
        new DataTable(table, dt_args);
    });
</script>
</div>
</div>
<p>This alternative used a cheeky ie function from the standard library called <a href="https://DeanLight.github.io/spannerlib/callbacks/basic_ies.html#expr_eval"><code>expr_eval</code></a> that lets us evaluate simple pythonic expression by writing them in a format similar to python’s format strings. This ie function is quite useful for replacing simple filters but becomes error prone for large complex expressions.</p>
</section>
</section>
</section>
<section id="tagging-covid-mentions" class="level3">
<h3 class="anchored" data-anchor-id="tagging-covid-mentions">Tagging Covid Mentions</h3>
<p>Next we will tag covid mentions based on their context. This section replaces the rest of the Context and postprocessing rules</p>
<div id="cell-101" class="cell">
<div class="sourceCode cell-code" id="cb70"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb70-1"><a href="#cb70-1" aria-hidden="true" tabindex="-1"></a><span class="co"># first we get the covid mentions and their surrounding sentences, using the span_contained ie function</span></span>
<span id="cb70-2"><a href="#cb70-2" aria-hidden="true" tabindex="-1"></a>CovidMentions(Path, Span) <span class="op">&lt;-</span> Docs(Path,D,<span class="st">"target_concept"</span>), rgx(<span class="st">"COVID-19"</span>,D) <span class="op">-&gt;</span> (Span).</span>
<span id="cb70-3"><a href="#cb70-3" aria-hidden="true" tabindex="-1"></a>CovidMentionSents(P,Mention,Sent)<span class="op">&lt;-</span>CovidMentions(P,Mention),Sents(P,Sent),span_contained(Mention,Sent)<span class="op">-&gt;</span>(<span class="va">True</span>).</span>
<span id="cb70-4"><a href="#cb70-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-5"><a href="#cb70-5" aria-hidden="true" tabindex="-1"></a>?CovidMentions(Path, Span)</span>
<span id="cb70-6"><a href="#cb70-6" aria-hidden="true" tabindex="-1"></a>?CovidMentionSents(P,Mention,Sent)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>'?CovidMentions(Path,Span)'</code></pre>
</div>
<div class="cell-output cell-output-display">
<style type="text/css">
#T_ec625_row0_col0, #T_ec625_row0_col1, #T_ec625_row1_col0, #T_ec625_row1_col1, #T_ec625_row2_col0, #T_ec625_row2_col1, #T_ec625_row3_col0, #T_ec625_row3_col1, #T_ec625_row4_col0, #T_ec625_row4_col1, #T_ec625_row5_col0, #T_ec625_row5_col1, #T_ec625_row6_col0, #T_ec625_row6_col1, #T_ec625_row7_col0, #T_ec625_row7_col1, #T_ec625_row8_col0, #T_ec625_row8_col1, #T_ec625_row9_col0, #T_ec625_row9_col1, #T_ec625_row10_col0, #T_ec625_row10_col1 {
  overflow-wrap: break-word;
  max-width: 800px;
  text-align: left;
}
</style>

<table id="T_ec625" class="display nowrap caption-top table table-sm table-striped small" data-quarto-postprocess="true">
<thead>
<tr class="header">
<th id="T_ec625_level0_col0" class="col_heading level0 col0" data-quarto-table-cell-role="th">Path</th>
<th id="T_ec625_level0_col1" class="col_heading level0 col1" data-quarto-table-cell-role="th">Span</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td id="T_ec625_row0_col0" class="data row0 col0">sample1.txt</td>
<td id="T_ec625_row0_col1" class="data row0 col1">[@931cb5,34,42) "COVID-19"</td>
</tr>
<tr class="even">
<td id="T_ec625_row1_col0" class="data row1 col0">sample1.txt</td>
<td id="T_ec625_row1_col1" class="data row1 col1">[@931cb5,84,92) "COVID-19"</td>
</tr>
<tr class="odd">
<td id="T_ec625_row2_col0" class="data row2 col0">sample1.txt</td>
<td id="T_ec625_row2_col1" class="data row2 col1">[@931cb5,94,102) "COVID-19"</td>
</tr>
<tr class="even">
<td id="T_ec625_row3_col0" class="data row3 col0">sample2.txt</td>
<td id="T_ec625_row3_col1" class="data row3 col1">[@e4b074,26,34) "COVID-19"</td>
</tr>
<tr class="odd">
<td id="T_ec625_row4_col0" class="data row4 col0">sample2.txt</td>
<td id="T_ec625_row4_col1" class="data row4 col1">[@e4b074,87,95) "COVID-19"</td>
</tr>
<tr class="even">
<td id="T_ec625_row5_col0" class="data row5 col0">sample3.txt</td>
<td id="T_ec625_row5_col1" class="data row5 col1">[@882253,44,52) "COVID-19"</td>
</tr>
<tr class="odd">
<td id="T_ec625_row6_col0" class="data row6 col0">sample4.txt</td>
<td id="T_ec625_row6_col1" class="data row6 col1">[@77c574,4,12) "COVID-19"</td>
</tr>
<tr class="even">
<td id="T_ec625_row7_col0" class="data row7 col0">sample5.txt</td>
<td id="T_ec625_row7_col1" class="data row7 col1">[@ffb7c7,9,17) "COVID-19"</td>
</tr>
<tr class="odd">
<td id="T_ec625_row8_col0" class="data row8 col0">sample6.txt</td>
<td id="T_ec625_row8_col1" class="data row8 col1">[@b2612f,26,34) "COVID-19"</td>
</tr>
<tr class="even">
<td id="T_ec625_row9_col0" class="data row9 col0">sample8.txt</td>
<td id="T_ec625_row9_col1" class="data row9 col1">[@3db2e4,22,30) "COVID-19"</td>
</tr>
<tr class="odd">
<td id="T_ec625_row10_col0" class="data row10 col0">sample9.txt</td>
<td id="T_ec625_row10_col1" class="data row10 col1">[@6d2862,34,42) "COVID-19"</td>
</tr>
</tbody>
</table>


<script type="module">
    const { DataTable, jQuery: $ } = await import(window._datatables_src_for_itables_2_1_4);

    document.querySelectorAll("#T_ec625:not(.dataTable)").forEach(table => {
        // Define the table data
        

        // Define the dt_args
        let dt_args = {"columnDefs": [{"targets": ["Path", "Span"], "render": function(data, type, row) {
                    return '<div style="white-space: normal; word-wrap: break-word;">' + data + '</div>';
                }, "width": "300px"}], "escape": true, "layout": {"topStart": "pageLength", "topEnd": "search", "bottomStart": "info", "bottomEnd": "paging"}, "display_logo_when_loading": true, "order": []};
        

        
        new DataTable(table, dt_args);
    });
</script>
</div>
<div class="cell-output cell-output-display">
<pre><code>'?CovidMentionSents(P,Mention,Sent)'</code></pre>
</div>
<div class="cell-output cell-output-display">
<style type="text/css">
#T_a0ab8_row0_col0, #T_a0ab8_row0_col1, #T_a0ab8_row0_col2, #T_a0ab8_row1_col0, #T_a0ab8_row1_col1, #T_a0ab8_row1_col2, #T_a0ab8_row2_col0, #T_a0ab8_row2_col1, #T_a0ab8_row2_col2, #T_a0ab8_row3_col0, #T_a0ab8_row3_col1, #T_a0ab8_row3_col2, #T_a0ab8_row4_col0, #T_a0ab8_row4_col1, #T_a0ab8_row4_col2, #T_a0ab8_row5_col0, #T_a0ab8_row5_col1, #T_a0ab8_row5_col2, #T_a0ab8_row6_col0, #T_a0ab8_row6_col1, #T_a0ab8_row6_col2, #T_a0ab8_row7_col0, #T_a0ab8_row7_col1, #T_a0ab8_row7_col2, #T_a0ab8_row8_col0, #T_a0ab8_row8_col1, #T_a0ab8_row8_col2, #T_a0ab8_row9_col0, #T_a0ab8_row9_col1, #T_a0ab8_row9_col2, #T_a0ab8_row10_col0, #T_a0ab8_row10_col1, #T_a0ab8_row10_col2 {
  overflow-wrap: break-word;
  max-width: 800px;
  text-align: left;
}
</style>

<table id="T_a0ab8" class="display nowrap caption-top table table-sm table-striped small" data-quarto-postprocess="true">
<thead>
<tr class="header">
<th id="T_a0ab8_level0_col0" class="col_heading level0 col0" data-quarto-table-cell-role="th">P</th>
<th id="T_a0ab8_level0_col1" class="col_heading level0 col1" data-quarto-table-cell-role="th">Mention</th>
<th id="T_a0ab8_level0_col2" class="col_heading level0 col2" data-quarto-table-cell-role="th">Sent</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td id="T_a0ab8_row0_col0" class="data row0 col0">sample1.txt</td>
<td id="T_a0ab8_row0_col1" class="data row0 col1">[@931cb5,34,42) "COVID-19"</td>
<td id="T_a0ab8_row0_col2" class="data row0 col2">[@931cb5,0,43) "patient pr..."</td>
</tr>
<tr class="even">
<td id="T_a0ab8_row1_col0" class="data row1 col0">sample1.txt</td>
<td id="T_a0ab8_row1_col1" class="data row1 col1">[@931cb5,84,92) "COVID-19"</td>
<td id="T_a0ab8_row1_col2" class="data row1 col2">[@931cb5,44,93) "His family..."</td>
</tr>
<tr class="odd">
<td id="T_a0ab8_row2_col0" class="data row2 col0">sample1.txt</td>
<td id="T_a0ab8_row2_col1" class="data row2 col1">[@931cb5,94,102) "COVID-19"</td>
<td id="T_a0ab8_row2_col2" class="data row2 col2">[@931cb5,94,130) "COVID-19 r..."</td>
</tr>
<tr class="even">
<td id="T_a0ab8_row3_col0" class="data row3 col0">sample2.txt</td>
<td id="T_a0ab8_row3_col1" class="data row3 col1">[@e4b074,26,34) "COVID-19"</td>
<td id="T_a0ab8_row3_col2" class="data row3 col2">[@e4b074,0,44) "The patien..."</td>
</tr>
<tr class="odd">
<td id="T_a0ab8_row4_col0" class="data row4 col0">sample2.txt</td>
<td id="T_a0ab8_row4_col1" class="data row4 col1">[@e4b074,87,95) "COVID-19"</td>
<td id="T_a0ab8_row4_col2" class="data row4 col2">[@e4b074,66,115) "patient un..."</td>
</tr>
<tr class="even">
<td id="T_a0ab8_row5_col0" class="data row5 col0">sample3.txt</td>
<td id="T_a0ab8_row5_col1" class="data row5 col1">[@882253,44,52) "COVID-19"</td>
<td id="T_a0ab8_row5_col2" class="data row5 col2">[@882253,44,61) "COVID-19 l..."</td>
</tr>
<tr class="odd">
<td id="T_a0ab8_row6_col0" class="data row6 col0">sample4.txt</td>
<td id="T_a0ab8_row6_col1" class="data row6 col1">[@77c574,4,12) "COVID-19"</td>
<td id="T_a0ab8_row6_col2" class="data row6 col2">[@77c574,0,23) "neg COVID-..."</td>
</tr>
<tr class="even">
<td id="T_a0ab8_row7_col0" class="data row7 col0">sample5.txt</td>
<td id="T_a0ab8_row7_col1" class="data row7 col1">[@ffb7c7,9,17) "COVID-19"</td>
<td id="T_a0ab8_row7_col2" class="data row7 col2">[@ffb7c7,0,29) "positive C..."</td>
</tr>
<tr class="odd">
<td id="T_a0ab8_row8_col0" class="data row8 col0">sample6.txt</td>
<td id="T_a0ab8_row8_col1" class="data row8 col1">[@b2612f,26,34) "COVID-19"</td>
<td id="T_a0ab8_row8_col2" class="data row8 col2">[@b2612f,0,35) "The patien..."</td>
</tr>
<tr class="even">
<td id="T_a0ab8_row9_col0" class="data row9 col0">sample8.txt</td>
<td id="T_a0ab8_row9_col1" class="data row9 col1">[@3db2e4,22,30) "COVID-19"</td>
<td id="T_a0ab8_row9_col2" class="data row9 col2">[@3db2e4,0,36) "patient be..."</td>
</tr>
<tr class="odd">
<td id="T_a0ab8_row10_col0" class="data row10 col0">sample9.txt</td>
<td id="T_a0ab8_row10_col1" class="data row10 col1">[@6d2862,34,42) "COVID-19"</td>
<td id="T_a0ab8_row10_col2" class="data row10 col2">[@6d2862,0,43) "patient ha..."</td>
</tr>
</tbody>
</table>


<script type="module">
    const { DataTable, jQuery: $ } = await import(window._datatables_src_for_itables_2_1_4);

    document.querySelectorAll("#T_a0ab8:not(.dataTable)").forEach(table => {
        // Define the table data
        

        // Define the dt_args
        let dt_args = {"columnDefs": [{"targets": ["P", "Mention", "Sent"], "render": function(data, type, row) {
                    return '<div style="white-space: normal; word-wrap: break-word;">' + data + '</div>';
                }, "width": "300px"}], "escape": true, "layout": {"topStart": "pageLength", "topEnd": "search", "bottomStart": "info", "bottomEnd": "paging"}, "display_logo_when_loading": true, "order": []};
        

        
        new DataTable(table, dt_args);
    });
</script>
</div>
</div>
<p>Now we define how to derive covid tags using sections, context and the different postprocessing rule types. Notice how easy it is to convey complex control flow that combines multiple data sources elegantly using Spannerlog.</p>
<div id="cell-103" class="cell">
<div class="sourceCode cell-code" id="cb73"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb73-1"><a href="#cb73-1" aria-hidden="true" tabindex="-1"></a><span class="co"># note that for ease of debugging, we extended our head to track which rule a fact was derived from</span></span>
<span id="cb73-2"><a href="#cb73-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-3"><a href="#cb73-3" aria-hidden="true" tabindex="-1"></a><span class="co"># a tag is positive if it is contained in a positive section</span></span>
<span id="cb73-4"><a href="#cb73-4" aria-hidden="true" tabindex="-1"></a>CovidTags(Path,Mention,<span class="st">'positive'</span>,<span class="st">'section'</span>)<span class="op">&lt;-</span></span>
<span id="cb73-5"><a href="#cb73-5" aria-hidden="true" tabindex="-1"></a>    PositiveSections(Path,D,Title,Section),</span>
<span id="cb73-6"><a href="#cb73-6" aria-hidden="true" tabindex="-1"></a>    CovidMentions(Path,Mention),</span>
<span id="cb73-7"><a href="#cb73-7" aria-hidden="true" tabindex="-1"></a>    span_contained(Mention,Section)<span class="op">-&gt;</span>(<span class="va">True</span>).</span>
<span id="cb73-8"><a href="#cb73-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-9"><a href="#cb73-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Context rules tags</span></span>
<span id="cb73-10"><a href="#cb73-10" aria-hidden="true" tabindex="-1"></a>CovidTags(Path,Mention,Tag,<span class="st">'sentence context'</span>)<span class="op">&lt;-</span></span>
<span id="cb73-11"><a href="#cb73-11" aria-hidden="true" tabindex="-1"></a>    CovidMentionSents(Path,Mention,Sent),</span>
<span id="cb73-12"><a href="#cb73-12" aria-hidden="true" tabindex="-1"></a>    SentenceContextRules(Pattern,Tag,DisambiguationPattern),</span>
<span id="cb73-13"><a href="#cb73-13" aria-hidden="true" tabindex="-1"></a>    rgx(Pattern,Sent)<span class="op">-&gt;</span>(ContextSpan),</span>
<span id="cb73-14"><a href="#cb73-14" aria-hidden="true" tabindex="-1"></a>    span_contained(Mention,ContextSpan)<span class="op">-&gt;</span>(<span class="va">True</span>),</span>
<span id="cb73-15"><a href="#cb73-15" aria-hidden="true" tabindex="-1"></a>    rgx_is_match(DisambiguationPattern,Sent)<span class="op">-&gt;</span>(<span class="va">False</span>).</span>
<span id="cb73-16"><a href="#cb73-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-17"><a href="#cb73-17" aria-hidden="true" tabindex="-1"></a><span class="co"># post processing based on pattern</span></span>
<span id="cb73-18"><a href="#cb73-18" aria-hidden="true" tabindex="-1"></a>CovidTags(Path,Mention,Tag,<span class="st">'post pattern'</span>)<span class="op">&lt;-</span></span>
<span id="cb73-19"><a href="#cb73-19" aria-hidden="true" tabindex="-1"></a>    CovidMentionSents(Path,Mention,Sent),</span>
<span id="cb73-20"><a href="#cb73-20" aria-hidden="true" tabindex="-1"></a>    PostprocessPatternRules(Pattern,Tag),</span>
<span id="cb73-21"><a href="#cb73-21" aria-hidden="true" tabindex="-1"></a>    rgx(Pattern,Sent)<span class="op">-&gt;</span>(ContextSpan),</span>
<span id="cb73-22"><a href="#cb73-22" aria-hidden="true" tabindex="-1"></a>    span_contained(Mention,ContextSpan)<span class="op">-&gt;</span>(<span class="va">True</span>).</span>
<span id="cb73-23"><a href="#cb73-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-24"><a href="#cb73-24" aria-hidden="true" tabindex="-1"></a><span class="co"># post processing based on pattern and existing attributes</span></span>
<span id="cb73-25"><a href="#cb73-25" aria-hidden="true" tabindex="-1"></a><span class="co"># notice the recursive call to CovidTags</span></span>
<span id="cb73-26"><a href="#cb73-26" aria-hidden="true" tabindex="-1"></a>CovidTags(Path,Mention,Tag,<span class="st">"post attribute change"</span>)<span class="op">&lt;-</span></span>
<span id="cb73-27"><a href="#cb73-27" aria-hidden="true" tabindex="-1"></a>    CovidTags(Path,Mention,OldTag,Derivation),</span>
<span id="cb73-28"><a href="#cb73-28" aria-hidden="true" tabindex="-1"></a>    PostprocessRulesWithAttributes(Pattern,OldTag,Tag),</span>
<span id="cb73-29"><a href="#cb73-29" aria-hidden="true" tabindex="-1"></a>    CovidMentionSents(Path,Mention,Sent),</span>
<span id="cb73-30"><a href="#cb73-30" aria-hidden="true" tabindex="-1"></a>    rgx(Pattern,Sent)<span class="op">-&gt;</span>(ContextSpan),</span>
<span id="cb73-31"><a href="#cb73-31" aria-hidden="true" tabindex="-1"></a>    span_contained(Mention,ContextSpan)<span class="op">-&gt;</span>(<span class="va">True</span>).</span>
<span id="cb73-32"><a href="#cb73-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-33"><a href="#cb73-33" aria-hidden="true" tabindex="-1"></a><span class="co"># post processing based on pattern in the next sentence</span></span>
<span id="cb73-34"><a href="#cb73-34" aria-hidden="true" tabindex="-1"></a>CovidTags(Path,Mention,Tag,<span class="st">"next sentence"</span>)<span class="op">&lt;-</span></span>
<span id="cb73-35"><a href="#cb73-35" aria-hidden="true" tabindex="-1"></a>    CovidMentionSents(Path,Mention,Sent),</span>
<span id="cb73-36"><a href="#cb73-36" aria-hidden="true" tabindex="-1"></a>    SentPairs(Path,Sent,NextSent),</span>
<span id="cb73-37"><a href="#cb73-37" aria-hidden="true" tabindex="-1"></a>    PostprocessPatternRules(Pattern,Tag),</span>
<span id="cb73-38"><a href="#cb73-38" aria-hidden="true" tabindex="-1"></a>    rgx(Pattern,NextSent)<span class="op">-&gt;</span>(ContextSpan).</span>
<span id="cb73-39"><a href="#cb73-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-40"><a href="#cb73-40" aria-hidden="true" tabindex="-1"></a>?CovidTags(Path,Mention,Tag,Derivation)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>'?CovidTags(Path,Mention,Tag,Derivation)'</code></pre>
</div>
<div class="cell-output cell-output-display">
<style type="text/css">
#T_a7163_row0_col0, #T_a7163_row0_col1, #T_a7163_row0_col2, #T_a7163_row0_col3, #T_a7163_row1_col0, #T_a7163_row1_col1, #T_a7163_row1_col2, #T_a7163_row1_col3, #T_a7163_row2_col0, #T_a7163_row2_col1, #T_a7163_row2_col2, #T_a7163_row2_col3, #T_a7163_row3_col0, #T_a7163_row3_col1, #T_a7163_row3_col2, #T_a7163_row3_col3, #T_a7163_row4_col0, #T_a7163_row4_col1, #T_a7163_row4_col2, #T_a7163_row4_col3, #T_a7163_row5_col0, #T_a7163_row5_col1, #T_a7163_row5_col2, #T_a7163_row5_col3, #T_a7163_row6_col0, #T_a7163_row6_col1, #T_a7163_row6_col2, #T_a7163_row6_col3, #T_a7163_row7_col0, #T_a7163_row7_col1, #T_a7163_row7_col2, #T_a7163_row7_col3, #T_a7163_row8_col0, #T_a7163_row8_col1, #T_a7163_row8_col2, #T_a7163_row8_col3, #T_a7163_row9_col0, #T_a7163_row9_col1, #T_a7163_row9_col2, #T_a7163_row9_col3, #T_a7163_row10_col0, #T_a7163_row10_col1, #T_a7163_row10_col2, #T_a7163_row10_col3, #T_a7163_row11_col0, #T_a7163_row11_col1, #T_a7163_row11_col2, #T_a7163_row11_col3, #T_a7163_row12_col0, #T_a7163_row12_col1, #T_a7163_row12_col2, #T_a7163_row12_col3, #T_a7163_row13_col0, #T_a7163_row13_col1, #T_a7163_row13_col2, #T_a7163_row13_col3 {
  overflow-wrap: break-word;
  max-width: 800px;
  text-align: left;
}
</style>

<table id="T_a7163" class="display nowrap caption-top table table-sm table-striped small" data-quarto-postprocess="true">
<thead>
<tr class="header">
<th id="T_a7163_level0_col0" class="col_heading level0 col0" data-quarto-table-cell-role="th">Path</th>
<th id="T_a7163_level0_col1" class="col_heading level0 col1" data-quarto-table-cell-role="th">Mention</th>
<th id="T_a7163_level0_col2" class="col_heading level0 col2" data-quarto-table-cell-role="th">Tag</th>
<th id="T_a7163_level0_col3" class="col_heading level0 col3" data-quarto-table-cell-role="th">Derivation</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td id="T_a7163_row0_col0" class="data row0 col0">sample1.txt</td>
<td id="T_a7163_row0_col1" class="data row0 col1">[@931cb5,84,92) "COVID-19"</td>
<td id="T_a7163_row0_col2" class="data row0 col2">negated</td>
<td id="T_a7163_row0_col3" class="data row0 col3">sentence context</td>
</tr>
<tr class="even">
<td id="T_a7163_row1_col0" class="data row1 col0">sample1.txt</td>
<td id="T_a7163_row1_col1" class="data row1 col1">[@931cb5,84,92) "COVID-19"</td>
<td id="T_a7163_row1_col2" class="data row1 col2">positive</td>
<td id="T_a7163_row1_col3" class="data row1 col3">sentence context</td>
</tr>
<tr class="odd">
<td id="T_a7163_row2_col0" class="data row2 col0">sample1.txt</td>
<td id="T_a7163_row2_col1" class="data row2 col1">[@931cb5,94,102) "COVID-19"</td>
<td id="T_a7163_row2_col2" class="data row2 col2">positive</td>
<td id="T_a7163_row2_col3" class="data row2 col3">sentence context</td>
</tr>
<tr class="even">
<td id="T_a7163_row3_col0" class="data row3 col0">sample2.txt</td>
<td id="T_a7163_row3_col1" class="data row3 col1">[@e4b074,87,95) "COVID-19"</td>
<td id="T_a7163_row3_col2" class="data row3 col2">IGNORE</td>
<td id="T_a7163_row3_col3" class="data row3 col3">post pattern</td>
</tr>
<tr class="odd">
<td id="T_a7163_row4_col0" class="data row4 col0">sample2.txt</td>
<td id="T_a7163_row4_col1" class="data row4 col1">[@e4b074,87,95) "COVID-19"</td>
<td id="T_a7163_row4_col2" class="data row4 col2">future</td>
<td id="T_a7163_row4_col3" class="data row4 col3">sentence context</td>
</tr>
<tr class="even">
<td id="T_a7163_row5_col0" class="data row5 col0">sample2.txt</td>
<td id="T_a7163_row5_col1" class="data row5 col1">[@e4b074,87,95) "COVID-19"</td>
<td id="T_a7163_row5_col2" class="data row5 col2">negated</td>
<td id="T_a7163_row5_col3" class="data row5 col3">sentence context</td>
</tr>
<tr class="odd">
<td id="T_a7163_row6_col0" class="data row6 col0">sample3.txt</td>
<td id="T_a7163_row6_col1" class="data row6 col1">[@882253,44,52) "COVID-19"</td>
<td id="T_a7163_row6_col2" class="data row6 col2">positive</td>
<td id="T_a7163_row6_col3" class="data row6 col3">section</td>
</tr>
<tr class="even">
<td id="T_a7163_row7_col0" class="data row7 col0">sample4.txt</td>
<td id="T_a7163_row7_col1" class="data row7 col1">[@77c574,4,12) "COVID-19"</td>
<td id="T_a7163_row7_col2" class="data row7 col2">IGNORE</td>
<td id="T_a7163_row7_col3" class="data row7 col3">post pattern</td>
</tr>
<tr class="odd">
<td id="T_a7163_row8_col0" class="data row8 col0">sample4.txt</td>
<td id="T_a7163_row8_col1" class="data row8 col1">[@77c574,4,12) "COVID-19"</td>
<td id="T_a7163_row8_col2" class="data row8 col2">future</td>
<td id="T_a7163_row8_col3" class="data row8 col3">sentence context</td>
</tr>
<tr class="even">
<td id="T_a7163_row9_col0" class="data row9 col0">sample4.txt</td>
<td id="T_a7163_row9_col1" class="data row9 col1">[@77c574,4,12) "COVID-19"</td>
<td id="T_a7163_row9_col2" class="data row9 col2">negated</td>
<td id="T_a7163_row9_col3" class="data row9 col3">sentence context</td>
</tr>
<tr class="odd">
<td id="T_a7163_row10_col0" class="data row10 col0">sample5.txt</td>
<td id="T_a7163_row10_col1" class="data row10 col1">[@ffb7c7,9,17) "COVID-19"</td>
<td id="T_a7163_row10_col2" class="data row10 col2">future</td>
<td id="T_a7163_row10_col3" class="data row10 col3">sentence context</td>
</tr>
<tr class="even">
<td id="T_a7163_row11_col0" class="data row11 col0">sample5.txt</td>
<td id="T_a7163_row11_col1" class="data row11 col1">[@ffb7c7,9,17) "COVID-19"</td>
<td id="T_a7163_row11_col2" class="data row11 col2">no_future</td>
<td id="T_a7163_row11_col3" class="data row11 col3">post attribute change</td>
</tr>
<tr class="odd">
<td id="T_a7163_row12_col0" class="data row12 col0">sample5.txt</td>
<td id="T_a7163_row12_col1" class="data row12 col1">[@ffb7c7,9,17) "COVID-19"</td>
<td id="T_a7163_row12_col2" class="data row12 col2">positive</td>
<td id="T_a7163_row12_col3" class="data row12 col3">sentence context</td>
</tr>
<tr class="even">
<td id="T_a7163_row13_col0" class="data row13 col0">sample6.txt</td>
<td id="T_a7163_row13_col1" class="data row13 col1">[@b2612f,26,34) "COVID-19"</td>
<td id="T_a7163_row13_col2" class="data row13 col2">patient_experiencer</td>
<td id="T_a7163_row13_col3" class="data row13 col3">sentence context</td>
</tr>
</tbody>
</table>


<script type="module">
    const { DataTable, jQuery: $ } = await import(window._datatables_src_for_itables_2_1_4);

    document.querySelectorAll("#T_a7163:not(.dataTable)").forEach(table => {
        // Define the table data
        

        // Define the dt_args
        let dt_args = {"columnDefs": [{"targets": ["Path", "Mention", "Tag", "Derivation"], "render": function(data, type, row) {
                    return '<div style="white-space: normal; word-wrap: break-word;">' + data + '</div>';
                }, "width": "300px"}], "escape": true, "layout": {"topStart": "pageLength", "topEnd": "search", "bottomStart": "info", "bottomEnd": "paging"}, "display_logo_when_loading": true, "order": []};
        

        
        new DataTable(table, dt_args);
    });
</script>
</div>
</div>
</section>
<section id="document-classificaiton" class="level3">
<h3 class="anchored" data-anchor-id="document-classificaiton">Document Classificaiton</h3>
<p>In the following section we will aggregate tags on mentions into document classification in two stages, aggregation of tags per mention and aggregation of mentions per document. This section replaces the document classification state in the original pipeline.</p>
<div id="cell-108" class="cell">
<div class="sourceCode cell-code" id="cb75"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb75-1"><a href="#cb75-1" aria-hidden="true" tabindex="-1"></a>AggregatedCovidTags(Path,Mention,agg_mention(Tag))<span class="op">&lt;-</span></span>
<span id="cb75-2"><a href="#cb75-2" aria-hidden="true" tabindex="-1"></a>    CovidTags(Path,Mention,Tag,Derivation).</span>
<span id="cb75-3"><a href="#cb75-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-4"><a href="#cb75-4" aria-hidden="true" tabindex="-1"></a>?AggregatedCovidTags(Path,Mention,Tag)</span>
<span id="cb75-5"><a href="#cb75-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-6"><a href="#cb75-6" aria-hidden="true" tabindex="-1"></a>DocumentTags(Path,agg_doc_tags(Tag))<span class="op">&lt;-</span></span>
<span id="cb75-7"><a href="#cb75-7" aria-hidden="true" tabindex="-1"></a>    AggregatedCovidTags(Path,Mention,Tag).</span>
<span id="cb75-8"><a href="#cb75-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-9"><a href="#cb75-9" aria-hidden="true" tabindex="-1"></a>?DocumentTags(Path,Tag)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>'?AggregatedCovidTags(Path,Mention,Tag)'</code></pre>
</div>
<div class="cell-output cell-output-display">
<style type="text/css">
#T_9b49a_row0_col0, #T_9b49a_row0_col1, #T_9b49a_row0_col2, #T_9b49a_row1_col0, #T_9b49a_row1_col1, #T_9b49a_row1_col2, #T_9b49a_row2_col0, #T_9b49a_row2_col1, #T_9b49a_row2_col2, #T_9b49a_row3_col0, #T_9b49a_row3_col1, #T_9b49a_row3_col2, #T_9b49a_row4_col0, #T_9b49a_row4_col1, #T_9b49a_row4_col2, #T_9b49a_row5_col0, #T_9b49a_row5_col1, #T_9b49a_row5_col2, #T_9b49a_row6_col0, #T_9b49a_row6_col1, #T_9b49a_row6_col2 {
  overflow-wrap: break-word;
  max-width: 800px;
  text-align: left;
}
</style>

<table id="T_9b49a" class="display nowrap caption-top table table-sm table-striped small" data-quarto-postprocess="true">
<thead>
<tr class="header">
<th id="T_9b49a_level0_col0" class="col_heading level0 col0" data-quarto-table-cell-role="th">Path</th>
<th id="T_9b49a_level0_col1" class="col_heading level0 col1" data-quarto-table-cell-role="th">Mention</th>
<th id="T_9b49a_level0_col2" class="col_heading level0 col2" data-quarto-table-cell-role="th">Tag</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td id="T_9b49a_row0_col0" class="data row0 col0">sample1.txt</td>
<td id="T_9b49a_row0_col1" class="data row0 col1">[@931cb5,84,92) "COVID-19"</td>
<td id="T_9b49a_row0_col2" class="data row0 col2">negated</td>
</tr>
<tr class="even">
<td id="T_9b49a_row1_col0" class="data row1 col0">sample1.txt</td>
<td id="T_9b49a_row1_col1" class="data row1 col1">[@931cb5,94,102) "COVID-19"</td>
<td id="T_9b49a_row1_col2" class="data row1 col2">positive</td>
</tr>
<tr class="odd">
<td id="T_9b49a_row2_col0" class="data row2 col0">sample2.txt</td>
<td id="T_9b49a_row2_col1" class="data row2 col1">[@e4b074,87,95) "COVID-19"</td>
<td id="T_9b49a_row2_col2" class="data row2 col2">IGNORE</td>
</tr>
<tr class="even">
<td id="T_9b49a_row3_col0" class="data row3 col0">sample3.txt</td>
<td id="T_9b49a_row3_col1" class="data row3 col1">[@882253,44,52) "COVID-19"</td>
<td id="T_9b49a_row3_col2" class="data row3 col2">positive</td>
</tr>
<tr class="odd">
<td id="T_9b49a_row4_col0" class="data row4 col0">sample4.txt</td>
<td id="T_9b49a_row4_col1" class="data row4 col1">[@77c574,4,12) "COVID-19"</td>
<td id="T_9b49a_row4_col2" class="data row4 col2">IGNORE</td>
</tr>
<tr class="even">
<td id="T_9b49a_row5_col0" class="data row5 col0">sample5.txt</td>
<td id="T_9b49a_row5_col1" class="data row5 col1">[@ffb7c7,9,17) "COVID-19"</td>
<td id="T_9b49a_row5_col2" class="data row5 col2">positive</td>
</tr>
<tr class="odd">
<td id="T_9b49a_row6_col0" class="data row6 col0">sample6.txt</td>
<td id="T_9b49a_row6_col1" class="data row6 col1">[@b2612f,26,34) "COVID-19"</td>
<td id="T_9b49a_row6_col2" class="data row6 col2">uncertain</td>
</tr>
</tbody>
</table>


<script type="module">
    const { DataTable, jQuery: $ } = await import(window._datatables_src_for_itables_2_1_4);

    document.querySelectorAll("#T_9b49a:not(.dataTable)").forEach(table => {
        // Define the table data
        

        // Define the dt_args
        let dt_args = {"columnDefs": [{"targets": ["Path", "Mention", "Tag"], "render": function(data, type, row) {
                    return '<div style="white-space: normal; word-wrap: break-word;">' + data + '</div>';
                }, "width": "300px"}], "escape": true, "layout": {"topStart": null, "topEnd": null, "bottomStart": null, "bottomEnd": null}, "display_logo_when_loading": true, "order": []};
        

        
        new DataTable(table, dt_args);
    });
</script>
</div>
<div class="cell-output cell-output-display">
<pre><code>'?DocumentTags(Path,Tag)'</code></pre>
</div>
<div class="cell-output cell-output-display">
<style type="text/css">
#T_ec8fe_row0_col0, #T_ec8fe_row0_col1, #T_ec8fe_row1_col0, #T_ec8fe_row1_col1, #T_ec8fe_row2_col0, #T_ec8fe_row2_col1, #T_ec8fe_row3_col0, #T_ec8fe_row3_col1, #T_ec8fe_row4_col0, #T_ec8fe_row4_col1, #T_ec8fe_row5_col0, #T_ec8fe_row5_col1 {
  overflow-wrap: break-word;
  max-width: 800px;
  text-align: left;
}
</style>

<table id="T_ec8fe" class="display nowrap caption-top table table-sm table-striped small" data-quarto-postprocess="true">
<thead>
<tr class="header">
<th id="T_ec8fe_level0_col0" class="col_heading level0 col0" data-quarto-table-cell-role="th">Path</th>
<th id="T_ec8fe_level0_col1" class="col_heading level0 col1" data-quarto-table-cell-role="th">Tag</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td id="T_ec8fe_row0_col0" class="data row0 col0">sample1.txt</td>
<td id="T_ec8fe_row0_col1" class="data row0 col1">POS</td>
</tr>
<tr class="even">
<td id="T_ec8fe_row1_col0" class="data row1 col0">sample2.txt</td>
<td id="T_ec8fe_row1_col1" class="data row1 col1">UNK</td>
</tr>
<tr class="odd">
<td id="T_ec8fe_row2_col0" class="data row2 col0">sample3.txt</td>
<td id="T_ec8fe_row2_col1" class="data row2 col1">POS</td>
</tr>
<tr class="even">
<td id="T_ec8fe_row3_col0" class="data row3 col0">sample4.txt</td>
<td id="T_ec8fe_row3_col1" class="data row3 col1">UNK</td>
</tr>
<tr class="odd">
<td id="T_ec8fe_row4_col0" class="data row4 col0">sample5.txt</td>
<td id="T_ec8fe_row4_col1" class="data row4 col1">POS</td>
</tr>
<tr class="even">
<td id="T_ec8fe_row5_col0" class="data row5 col0">sample6.txt</td>
<td id="T_ec8fe_row5_col1" class="data row5 col1">UNK</td>
</tr>
</tbody>
</table>


<script type="module">
    const { DataTable, jQuery: $ } = await import(window._datatables_src_for_itables_2_1_4);

    document.querySelectorAll("#T_ec8fe:not(.dataTable)").forEach(table => {
        // Define the table data
        

        // Define the dt_args
        let dt_args = {"columnDefs": [{"targets": ["Path", "Tag"], "render": function(data, type, row) {
                    return '<div style="white-space: normal; word-wrap: break-word;">' + data + '</div>';
                }, "width": "300px"}], "escape": true, "layout": {"topStart": null, "topEnd": null, "bottomStart": null, "bottomEnd": null}, "display_logo_when_loading": true, "order": []};
        

        
        new DataTable(table, dt_args);
    });
</script>
</div>
</div>
<section id="handling-unmentioned-paths" class="level4">
<h4 class="anchored" data-anchor-id="handling-unmentioned-paths">Handling unmentioned paths:</h4>
<p>At this step, we assign a classification result ‘UNK’ to paths not identified in the previous DataFrame result. This occurs when our pipeline doesn’t detect any mention of COVID-19 or its synonyms in the text of those paths. As a result, these paths are excluded from all types of relations, consistent with our primary focus on COVID-19 entities.</p>
<p>And with this we have completed the pipeline. In the next section we will look at the entire code base, compare lines of code and analyze the advantages of the spannerlib implementation form a software engineering perspective.</p>
</section>
</section>
</section>
<section id="end-to-end-implementation" class="level2">
<h2 class="anchored" data-anchor-id="end-to-end-implementation">End to End implementation</h2>
<section id="imports-and-configurations" class="level3">
<h3 class="anchored" data-anchor-id="imports-and-configurations">imports and configurations</h3>
<div class="sourceCode" id="cb78"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb78-1"><a href="#cb78-1" aria-hidden="true" tabindex="-1"></a><span class="co"># imports</span></span>
<span id="cb78-2"><a href="#cb78-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> glob <span class="im">import</span> glob</span>
<span id="cb78-3"><a href="#cb78-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb78-4"><a href="#cb78-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pandas <span class="im">import</span> DataFrame</span>
<span id="cb78-5"><a href="#cb78-5" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pathlib <span class="im">import</span> Path</span>
<span id="cb78-6"><a href="#cb78-6" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> spannerlib <span class="im">import</span> get_magic_session,Session,Span</span>
<span id="cb78-7"><a href="#cb78-7" aria-hidden="true" tabindex="-1"></a>sess <span class="op">=</span> get_magic_session()</span>
<span id="cb78-8"><a href="#cb78-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb78-9"><a href="#cb78-9" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> spacy</span>
<span id="cb78-10"><a href="#cb78-10" aria-hidden="true" tabindex="-1"></a>nlp <span class="op">=</span> spacy.load(<span class="st">"en_core_web_sm"</span>)</span>
<span id="cb78-11"><a href="#cb78-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb78-12"><a href="#cb78-12" aria-hidden="true" tabindex="-1"></a><span class="co"># configurations</span></span>
<span id="cb78-13"><a href="#cb78-13" aria-hidden="true" tabindex="-1"></a>slog_file <span class="op">=</span> Path(<span class="st">'covid_data/covid_logic.pl'</span>)</span>
<span id="cb78-14"><a href="#cb78-14" aria-hidden="true" tabindex="-1"></a>input_dir <span class="op">=</span> Path(<span class="st">'covid_data/sample_inputs'</span>)</span>
<span id="cb78-15"><a href="#cb78-15" aria-hidden="true" tabindex="-1"></a>data_dir <span class="op">=</span> Path(<span class="st">'covid_data/rules_data'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="spannerlog-code" class="level3">
<h3 class="anchored" data-anchor-id="spannerlog-code">Spannerlog Code</h3>
<div class="sourceCode" id="cb79"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb79-1"><a href="#cb79-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>spannerlog</span>
<span id="cb79-2"><a href="#cb79-2" aria-hidden="true" tabindex="-1"></a>Lemmas(P,D,Word,Lem)<span class="op">&lt;-</span>Docs(P,D,<span class="st">"raw_text"</span>),lemma(D)<span class="op">-&gt;</span>(Word,Lem)</span>
<span id="cb79-3"><a href="#cb79-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb79-4"><a href="#cb79-4" aria-hidden="true" tabindex="-1"></a>LemmaConceptMatches(Path,Doc,Span,Label) <span class="op">&lt;-</span> <span class="op">\</span></span>
<span id="cb79-5"><a href="#cb79-5" aria-hidden="true" tabindex="-1"></a>    Docs(Path,Doc,<span class="st">"lemma"</span>),<span class="op">\</span></span>
<span id="cb79-6"><a href="#cb79-6" aria-hidden="true" tabindex="-1"></a>    ConceptTagRules(Pattern, Label, <span class="st">"lemma"</span>),<span class="op">\</span></span>
<span id="cb79-7"><a href="#cb79-7" aria-hidden="true" tabindex="-1"></a>    rgx(Pattern,Doc) <span class="op">-&gt;</span> (Span)</span>
<span id="cb79-8"><a href="#cb79-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb79-9"><a href="#cb79-9" aria-hidden="true" tabindex="-1"></a><span class="co"># here we get the spans of all POS</span></span>
<span id="cb79-10"><a href="#cb79-10" aria-hidden="true" tabindex="-1"></a>Pos(P,D,Word,Lem)<span class="op">&lt;-</span>Docs(P,D,<span class="st">"lemma_concept"</span>),pos(D)<span class="op">-&gt;</span>(Word,Lem)</span>
<span id="cb79-11"><a href="#cb79-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb79-12"><a href="#cb79-12" aria-hidden="true" tabindex="-1"></a><span class="co"># here we look for concept rule matches where the matched word is also tagged via POS</span></span>
<span id="cb79-13"><a href="#cb79-13" aria-hidden="true" tabindex="-1"></a>PosConceptMatches(Path,Doc,Span,Label) <span class="op">&lt;-</span> <span class="op">\</span></span>
<span id="cb79-14"><a href="#cb79-14" aria-hidden="true" tabindex="-1"></a>    Docs(Path,Doc,<span class="st">"lemma_concept"</span>),<span class="op">\</span></span>
<span id="cb79-15"><a href="#cb79-15" aria-hidden="true" tabindex="-1"></a>    ConceptTagRules(Pattern, Label, <span class="st">"pos"</span>),<span class="op">\</span></span>
<span id="cb79-16"><a href="#cb79-16" aria-hidden="true" tabindex="-1"></a>    rgx(Pattern,Doc) <span class="op">-&gt;</span> (Span),<span class="op">\</span></span>
<span id="cb79-17"><a href="#cb79-17" aria-hidden="true" tabindex="-1"></a>    Pos(Path,Doc,Span,POSLabel)</span>
<span id="cb79-18"><a href="#cb79-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb79-19"><a href="#cb79-19" aria-hidden="true" tabindex="-1"></a>TargetMatches(Path,Doc, Span, Label) <span class="op">&lt;-</span> <span class="op">\</span></span>
<span id="cb79-20"><a href="#cb79-20" aria-hidden="true" tabindex="-1"></a>    Docs(Path,Doc,<span class="st">"pos_concept"</span>),<span class="op">\</span></span>
<span id="cb79-21"><a href="#cb79-21" aria-hidden="true" tabindex="-1"></a>    TargetTagRules(Pattern, Label), rgx(Pattern,Doc) <span class="op">-&gt;</span> (Span)</span>
<span id="cb79-22"><a href="#cb79-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb79-23"><a href="#cb79-23" aria-hidden="true" tabindex="-1"></a><span class="co"># we get section spans and their content using our regex pattern and the rgx_split ie function</span></span>
<span id="cb79-24"><a href="#cb79-24" aria-hidden="true" tabindex="-1"></a>Sections(P,D,Sec,Content)<span class="op">&lt;-</span>Docs(P,D,<span class="st">"target_concept"</span>),<span class="op">\</span></span>
<span id="cb79-25"><a href="#cb79-25" aria-hidden="true" tabindex="-1"></a>    rgx_split($section_delimeter_pattern,D)<span class="op">-&gt;</span>(SecSpan,Content),<span class="op">\</span></span>
<span id="cb79-26"><a href="#cb79-26" aria-hidden="true" tabindex="-1"></a>    as_str(SecSpan)<span class="op">-&gt;</span>(Sec)</span>
<span id="cb79-27"><a href="#cb79-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb79-28"><a href="#cb79-28" aria-hidden="true" tabindex="-1"></a>PositiveSections(P,D,Sec,Content)<span class="op">&lt;-</span>Sections(P,D,Sec,Content),SectionTags(Sec,Tag),PositiveSectionTags(Tag)</span>
<span id="cb79-29"><a href="#cb79-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb79-30"><a href="#cb79-30" aria-hidden="true" tabindex="-1"></a>Sents(P,S)<span class="op">&lt;-</span>Docs(P,D,<span class="st">"target_concept"</span>),split_sentence(D)<span class="op">-&gt;</span>(S)</span>
<span id="cb79-31"><a href="#cb79-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb79-32"><a href="#cb79-32" aria-hidden="true" tabindex="-1"></a>SentPairs(P,S1,S2)<span class="op">&lt;-</span>Sents(P,S1),Sents(P,S2),expr_eval(<span class="st">"</span><span class="sc">{0}</span><span class="st">.end +1 == </span><span class="sc">{1}</span><span class="st">.start"</span>,S1,S2)<span class="op">-&gt;</span>(<span class="va">True</span>)</span>
<span id="cb79-33"><a href="#cb79-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb79-34"><a href="#cb79-34" aria-hidden="true" tabindex="-1"></a><span class="co"># first we get the covid mentions and their surrounding sentences, using the span_contained ie function</span></span>
<span id="cb79-35"><a href="#cb79-35" aria-hidden="true" tabindex="-1"></a>CovidMentions(Path, Span) <span class="op">&lt;-</span> Docs(Path,D,<span class="st">"target_concept"</span>), rgx(<span class="st">"COVID-19"</span>,D) <span class="op">-&gt;</span> (Span)</span>
<span id="cb79-36"><a href="#cb79-36" aria-hidden="true" tabindex="-1"></a>CovidMentionSents(P,Mention,Sent)<span class="op">&lt;-</span>CovidMentions(P,Mention),Sents(P,Sent),span_contained(Mention,Sent)<span class="op">-&gt;</span>(<span class="va">True</span>)</span>
<span id="cb79-37"><a href="#cb79-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb79-38"><a href="#cb79-38" aria-hidden="true" tabindex="-1"></a><span class="co"># note that for ease of debugging, we extended our head to track which rule a fact was derived from</span></span>
<span id="cb79-39"><a href="#cb79-39" aria-hidden="true" tabindex="-1"></a><span class="co"># a tag is positive if it is contained in a positive section</span></span>
<span id="cb79-40"><a href="#cb79-40" aria-hidden="true" tabindex="-1"></a>CovidTags(Path,Mention,<span class="st">'positive'</span>,<span class="st">'section'</span>)<span class="op">&lt;-\</span></span>
<span id="cb79-41"><a href="#cb79-41" aria-hidden="true" tabindex="-1"></a>    PositiveSections(Path,D,Title,Section),<span class="op">\</span></span>
<span id="cb79-42"><a href="#cb79-42" aria-hidden="true" tabindex="-1"></a>    CovidMentions(Path,Mention),<span class="op">\</span></span>
<span id="cb79-43"><a href="#cb79-43" aria-hidden="true" tabindex="-1"></a>    span_contained(Mention,Section)<span class="op">-&gt;</span>(<span class="va">True</span>)</span>
<span id="cb79-44"><a href="#cb79-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb79-45"><a href="#cb79-45" aria-hidden="true" tabindex="-1"></a><span class="co"># Context rules tags</span></span>
<span id="cb79-46"><a href="#cb79-46" aria-hidden="true" tabindex="-1"></a>CovidTags(Path,Mention,Tag,<span class="st">'sentence context'</span>)<span class="op">&lt;-\</span></span>
<span id="cb79-47"><a href="#cb79-47" aria-hidden="true" tabindex="-1"></a>    CovidMentionSents(Path,Mention,Sent),<span class="op">\</span></span>
<span id="cb79-48"><a href="#cb79-48" aria-hidden="true" tabindex="-1"></a>    SentenceContextRules(Pattern,Tag,DisambiguationPattern),<span class="op">\</span></span>
<span id="cb79-49"><a href="#cb79-49" aria-hidden="true" tabindex="-1"></a>    rgx(Pattern,Sent)<span class="op">-&gt;</span>(ContextSpan),<span class="op">\</span></span>
<span id="cb79-50"><a href="#cb79-50" aria-hidden="true" tabindex="-1"></a>    span_contained(Mention,ContextSpan)<span class="op">-&gt;</span>(<span class="va">True</span>),<span class="op">\</span></span>
<span id="cb79-51"><a href="#cb79-51" aria-hidden="true" tabindex="-1"></a>    rgx_is_match(DisambiguationPattern,Sent)<span class="op">-&gt;</span>(<span class="va">False</span>)</span>
<span id="cb79-52"><a href="#cb79-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb79-53"><a href="#cb79-53" aria-hidden="true" tabindex="-1"></a><span class="co"># post processing based on pattern</span></span>
<span id="cb79-54"><a href="#cb79-54" aria-hidden="true" tabindex="-1"></a>CovidTags(Path,Mention,Tag,<span class="st">'post pattern'</span>)<span class="op">&lt;-\</span></span>
<span id="cb79-55"><a href="#cb79-55" aria-hidden="true" tabindex="-1"></a>    CovidMentionSents(Path,Mention,Sent),<span class="op">\</span></span>
<span id="cb79-56"><a href="#cb79-56" aria-hidden="true" tabindex="-1"></a>    PostprocessPatternRules(Pattern,Tag),<span class="op">\</span></span>
<span id="cb79-57"><a href="#cb79-57" aria-hidden="true" tabindex="-1"></a>    rgx(Pattern,Sent)<span class="op">-&gt;</span>(ContextSpan),<span class="op">\</span></span>
<span id="cb79-58"><a href="#cb79-58" aria-hidden="true" tabindex="-1"></a>    span_contained(Mention,ContextSpan)<span class="op">-&gt;</span>(<span class="va">True</span>)</span>
<span id="cb79-59"><a href="#cb79-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb79-60"><a href="#cb79-60" aria-hidden="true" tabindex="-1"></a><span class="co"># post processing based on pattern and existing attributes</span></span>
<span id="cb79-61"><a href="#cb79-61" aria-hidden="true" tabindex="-1"></a><span class="co"># notice the recursive call to CovidTags</span></span>
<span id="cb79-62"><a href="#cb79-62" aria-hidden="true" tabindex="-1"></a>CovidTags(Path,Mention,Tag,<span class="st">"post attribute change"</span>)<span class="op">&lt;-\</span></span>
<span id="cb79-63"><a href="#cb79-63" aria-hidden="true" tabindex="-1"></a>    CovidTags(Path,Mention,OldTag,Derivation),<span class="op">\</span></span>
<span id="cb79-64"><a href="#cb79-64" aria-hidden="true" tabindex="-1"></a>    PostprocessRulesWithAttributes(Pattern,OldTag,Tag),<span class="op">\</span></span>
<span id="cb79-65"><a href="#cb79-65" aria-hidden="true" tabindex="-1"></a>    CovidMentionSents(Path,Mention,Sent),<span class="op">\</span></span>
<span id="cb79-66"><a href="#cb79-66" aria-hidden="true" tabindex="-1"></a>    rgx(Pattern,Sent)<span class="op">-&gt;</span>(ContextSpan),<span class="op">\</span></span>
<span id="cb79-67"><a href="#cb79-67" aria-hidden="true" tabindex="-1"></a>    span_contained(Mention,ContextSpan)<span class="op">-&gt;</span>(<span class="va">True</span>)</span>
<span id="cb79-68"><a href="#cb79-68" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb79-69"><a href="#cb79-69" aria-hidden="true" tabindex="-1"></a><span class="co"># post processing based on pattern in the next sentence</span></span>
<span id="cb79-70"><a href="#cb79-70" aria-hidden="true" tabindex="-1"></a>CovidTags(Path,Mention,Tag,<span class="st">"next sentence"</span>)<span class="op">&lt;-\</span></span>
<span id="cb79-71"><a href="#cb79-71" aria-hidden="true" tabindex="-1"></a>    CovidMentionSents(Path,Mention,Sent),<span class="op">\</span></span>
<span id="cb79-72"><a href="#cb79-72" aria-hidden="true" tabindex="-1"></a>    SentPairs(Path,Sent,NextSent),<span class="op">\</span></span>
<span id="cb79-73"><a href="#cb79-73" aria-hidden="true" tabindex="-1"></a>    PostprocessPatternRules(Pattern,Tag),<span class="op">\</span></span>
<span id="cb79-74"><a href="#cb79-74" aria-hidden="true" tabindex="-1"></a>    rgx(Pattern,NextSent)<span class="op">-&gt;</span>(ContextSpan)</span>
<span id="cb79-75"><a href="#cb79-75" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb79-76"><a href="#cb79-76" aria-hidden="true" tabindex="-1"></a>AggregatedCovidTags(Path,Mention,agg_mention(Tag))<span class="op">&lt;-\</span></span>
<span id="cb79-77"><a href="#cb79-77" aria-hidden="true" tabindex="-1"></a>    CovidTags(Path,Mention,Tag,Derivation)</span>
<span id="cb79-78"><a href="#cb79-78" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb79-79"><a href="#cb79-79" aria-hidden="true" tabindex="-1"></a>DocumentTags(Path,agg_doc_tags(Tag))<span class="op">&lt;-\</span></span>
<span id="cb79-80"><a href="#cb79-80" aria-hidden="true" tabindex="-1"></a>    AggregatedCovidTags(Path,Mention,Tag)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="ie-and-agg-functions" class="level3">
<h3 class="anchored" data-anchor-id="ie-and-agg-functions">IE and Agg functions:</h3>
<div class="sourceCode" id="cb80"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb80-1"><a href="#cb80-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> split_sentence(text):</span>
<span id="cb80-2"><a href="#cb80-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb80-3"><a href="#cb80-3" aria-hidden="true" tabindex="-1"></a><span class="co">    Splits a text into individual sentences. using spacy's sentence detection.</span></span>
<span id="cb80-4"><a href="#cb80-4" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb80-5"><a href="#cb80-5" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns:</span></span>
<span id="cb80-6"><a href="#cb80-6" aria-hidden="true" tabindex="-1"></a><span class="co">        str: Individual sentences extracted from the input text.</span></span>
<span id="cb80-7"><a href="#cb80-7" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb80-8"><a href="#cb80-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-9"><a href="#cb80-9" aria-hidden="true" tabindex="-1"></a>    doc <span class="op">=</span> nlp(<span class="bu">str</span>(text))</span>
<span id="cb80-10"><a href="#cb80-10" aria-hidden="true" tabindex="-1"></a>    start <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb80-11"><a href="#cb80-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> sentence <span class="kw">in</span> doc.sents:</span>
<span id="cb80-12"><a href="#cb80-12" aria-hidden="true" tabindex="-1"></a>        end <span class="op">=</span> start<span class="op">+</span><span class="bu">len</span>(sentence.text)</span>
<span id="cb80-13"><a href="#cb80-13" aria-hidden="true" tabindex="-1"></a>        <span class="co"># note that we yield a Span object, so we can keep track of the locations of the sentences</span></span>
<span id="cb80-14"><a href="#cb80-14" aria-hidden="true" tabindex="-1"></a>        <span class="cf">yield</span> Span(text,start,end)</span>
<span id="cb80-15"><a href="#cb80-15" aria-hidden="true" tabindex="-1"></a>        start <span class="op">=</span> end <span class="op">+</span> <span class="dv">1</span></span>
<span id="cb80-16"><a href="#cb80-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-17"><a href="#cb80-17" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> LemmaFromList():</span>
<span id="cb80-18"><a href="#cb80-18" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>,lemma_list):</span>
<span id="cb80-19"><a href="#cb80-19" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.lemma_list <span class="op">=</span> lemma_list</span>
<span id="cb80-20"><a href="#cb80-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-21"><a href="#cb80-21" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__call__</span>(<span class="va">self</span>,text):</span>
<span id="cb80-22"><a href="#cb80-22" aria-hidden="true" tabindex="-1"></a>        doc <span class="op">=</span> nlp(<span class="bu">str</span>(text))</span>
<span id="cb80-23"><a href="#cb80-23" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> word <span class="kw">in</span> doc:</span>
<span id="cb80-24"><a href="#cb80-24" aria-hidden="true" tabindex="-1"></a>            start <span class="op">=</span> word.idx</span>
<span id="cb80-25"><a href="#cb80-25" aria-hidden="true" tabindex="-1"></a>            end <span class="op">=</span> start <span class="op">+</span> <span class="bu">len</span>(word.text)</span>
<span id="cb80-26"><a href="#cb80-26" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> word.lemma_ <span class="kw">in</span> <span class="va">self</span>.lemma_list:</span>
<span id="cb80-27"><a href="#cb80-27" aria-hidden="true" tabindex="-1"></a>                <span class="cf">yield</span> (Span(text,start,end),word.lemma_)</span>
<span id="cb80-28"><a href="#cb80-28" aria-hidden="true" tabindex="-1"></a>            <span class="cf">elif</span> word.like_num:</span>
<span id="cb80-29"><a href="#cb80-29" aria-hidden="true" tabindex="-1"></a>                <span class="cf">yield</span> (Span(text,start,end),<span class="st">'like_num'</span>)</span>
<span id="cb80-30"><a href="#cb80-30" aria-hidden="true" tabindex="-1"></a>            <span class="cf">else</span>:</span>
<span id="cb80-31"><a href="#cb80-31" aria-hidden="true" tabindex="-1"></a>                <span class="cf">pass</span></span>
<span id="cb80-32"><a href="#cb80-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-33"><a href="#cb80-33" aria-hidden="true" tabindex="-1"></a>lemma_list <span class="op">=</span> (data_dir<span class="op">/</span><span class="st">'lemma_words.txt'</span>).read_text().split()</span>
<span id="cb80-34"><a href="#cb80-34" aria-hidden="true" tabindex="-1"></a>lemmatizer <span class="op">=</span> LemmaFromList(lemma_list)</span>
<span id="cb80-35"><a href="#cb80-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-36"><a href="#cb80-36" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> PosFromList():</span>
<span id="cb80-37"><a href="#cb80-37" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>,pos_list):</span>
<span id="cb80-38"><a href="#cb80-38" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.pos_list <span class="op">=</span> pos_list</span>
<span id="cb80-39"><a href="#cb80-39" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__call__</span>(<span class="va">self</span>,text):</span>
<span id="cb80-40"><a href="#cb80-40" aria-hidden="true" tabindex="-1"></a>        doc <span class="op">=</span> nlp(<span class="bu">str</span>(text))</span>
<span id="cb80-41"><a href="#cb80-41" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> word <span class="kw">in</span> doc:</span>
<span id="cb80-42"><a href="#cb80-42" aria-hidden="true" tabindex="-1"></a>            start <span class="op">=</span> word.idx</span>
<span id="cb80-43"><a href="#cb80-43" aria-hidden="true" tabindex="-1"></a>            end <span class="op">=</span> start <span class="op">+</span> <span class="bu">len</span>(word.text)</span>
<span id="cb80-44"><a href="#cb80-44" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> word.pos_ <span class="kw">in</span> <span class="va">self</span>.pos_list:</span>
<span id="cb80-45"><a href="#cb80-45" aria-hidden="true" tabindex="-1"></a>                <span class="cf">yield</span> (Span(text,start,end),word.pos_)</span>
<span id="cb80-46"><a href="#cb80-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-47"><a href="#cb80-47" aria-hidden="true" tabindex="-1"></a>pos_annotator <span class="op">=</span> PosFromList([<span class="st">"NOUN"</span>, <span class="st">"PROPN"</span>, <span class="st">"PRON"</span>, <span class="st">"ADJ"</span>])</span>
<span id="cb80-48"><a href="#cb80-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-49"><a href="#cb80-49" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> agg_mention(group):</span>
<span id="cb80-50"><a href="#cb80-50" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb80-51"><a href="#cb80-51" aria-hidden="true" tabindex="-1"></a><span class="co">    aggregates attribute groups of covid spans</span></span>
<span id="cb80-52"><a href="#cb80-52" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb80-53"><a href="#cb80-53" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="st">'IGNORE'</span> <span class="kw">in</span> group.values:</span>
<span id="cb80-54"><a href="#cb80-54" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="st">'IGNORE'</span></span>
<span id="cb80-55"><a href="#cb80-55" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> <span class="st">'negated'</span> <span class="kw">in</span> group.values <span class="kw">and</span> <span class="kw">not</span> <span class="st">'no_negated'</span> <span class="kw">in</span> group.values:</span>
<span id="cb80-56"><a href="#cb80-56" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="st">'negated'</span></span>
<span id="cb80-57"><a href="#cb80-57" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> <span class="st">'future'</span> <span class="kw">in</span> group.values <span class="kw">and</span> <span class="kw">not</span> <span class="st">'no_future'</span> <span class="kw">in</span> group.values:</span>
<span id="cb80-58"><a href="#cb80-58" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="st">'negated'</span></span>
<span id="cb80-59"><a href="#cb80-59" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> <span class="st">'other experiencer'</span> <span class="kw">in</span> group.values <span class="kw">or</span> <span class="st">'not relevant'</span> <span class="kw">in</span> group.values:</span>
<span id="cb80-60"><a href="#cb80-60" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="st">'negated'</span></span>
<span id="cb80-61"><a href="#cb80-61" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> <span class="st">'positive'</span> <span class="kw">in</span> group.values <span class="kw">and</span> <span class="kw">not</span> <span class="st">'uncertain'</span> <span class="kw">in</span> group.values <span class="kw">and</span> <span class="kw">not</span> <span class="st">'no_positive'</span> <span class="kw">in</span> group.values:</span>
<span id="cb80-62"><a href="#cb80-62" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="st">'positive'</span></span>
<span id="cb80-63"><a href="#cb80-63" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb80-64"><a href="#cb80-64" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="st">'uncertain'</span></span>
<span id="cb80-65"><a href="#cb80-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-66"><a href="#cb80-66" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> AggDocumentTags(group):</span>
<span id="cb80-67"><a href="#cb80-67" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb80-68"><a href="#cb80-68" aria-hidden="true" tabindex="-1"></a><span class="co">    Classifies a document as 'POS', 'UNK', or 'NEG' based on COVID-19 attributes.</span></span>
<span id="cb80-69"><a href="#cb80-69" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb80-70"><a href="#cb80-70" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="st">'positive'</span> <span class="kw">in</span> group.values:</span>
<span id="cb80-71"><a href="#cb80-71" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="st">'POS'</span></span>
<span id="cb80-72"><a href="#cb80-72" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> <span class="st">'uncertain'</span> <span class="kw">in</span> group.values:</span>
<span id="cb80-73"><a href="#cb80-73" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="st">'UNK'</span></span>
<span id="cb80-74"><a href="#cb80-74" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> <span class="st">'negated'</span> <span class="kw">in</span> group.values:</span>
<span id="cb80-75"><a href="#cb80-75" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="st">'NEG'</span></span>
<span id="cb80-76"><a href="#cb80-76" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb80-77"><a href="#cb80-77" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="st">'UNK'</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="regular-python-utilities" class="level3">
<h3 class="anchored" data-anchor-id="regular-python-utilities">Regular python utilities</h3>
<div class="sourceCode" id="cb81"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb81-1"><a href="#cb81-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> rewrite(text,span_label_pairs):</span>
<span id="cb81-2"><a href="#cb81-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""rewrites a string given a dataframe with spans and the string to rewrite them to</span></span>
<span id="cb81-3"><a href="#cb81-3" aria-hidden="true" tabindex="-1"></a><span class="co">    assumes that the spans belong to the text</span></span>
<span id="cb81-4"><a href="#cb81-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-5"><a href="#cb81-5" aria-hidden="true" tabindex="-1"></a><span class="co">    Args:</span></span>
<span id="cb81-6"><a href="#cb81-6" aria-hidden="true" tabindex="-1"></a><span class="co">        text (str like): string to rewrite</span></span>
<span id="cb81-7"><a href="#cb81-7" aria-hidden="true" tabindex="-1"></a><span class="co">        span_label_pairs (pd.Dataframe) dataframe with two columns, first is spans in the doc to rewrite</span></span>
<span id="cb81-8"><a href="#cb81-8" aria-hidden="true" tabindex="-1"></a><span class="co">            second is what to rewrite to</span></span>
<span id="cb81-9"><a href="#cb81-9" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns:</span></span>
<span id="cb81-10"><a href="#cb81-10" aria-hidden="true" tabindex="-1"></a><span class="co">        The rewritten string</span></span>
<span id="cb81-11"><a href="#cb81-11" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span>    </span>
<span id="cb81-12"><a href="#cb81-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">isinstance</span>(text,Span):</span>
<span id="cb81-13"><a href="#cb81-13" aria-hidden="true" tabindex="-1"></a>        text <span class="op">=</span> text.as_str()</span>
<span id="cb81-14"><a href="#cb81-14" aria-hidden="true" tabindex="-1"></a>    span_label_pairs <span class="op">=</span> <span class="bu">sorted</span>(<span class="bu">list</span>(span_label_pairs.itertuples(index<span class="op">=</span><span class="va">False</span>,name<span class="op">=</span><span class="va">None</span>)), key<span class="op">=</span><span class="kw">lambda</span> x: x[<span class="dv">0</span>].start)</span>
<span id="cb81-15"><a href="#cb81-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-16"><a href="#cb81-16" aria-hidden="true" tabindex="-1"></a>    rewritten_text <span class="op">=</span> <span class="st">''</span></span>
<span id="cb81-17"><a href="#cb81-17" aria-hidden="true" tabindex="-1"></a>    current_pos <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb81-18"><a href="#cb81-18" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> span,label <span class="kw">in</span> span_label_pairs:</span>
<span id="cb81-19"><a href="#cb81-19" aria-hidden="true" tabindex="-1"></a>        rewritten_text <span class="op">+=</span> text[current_pos:span.start] <span class="op">+</span> label </span>
<span id="cb81-20"><a href="#cb81-20" aria-hidden="true" tabindex="-1"></a>        current_pos <span class="op">=</span> span.end</span>
<span id="cb81-21"><a href="#cb81-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-22"><a href="#cb81-22" aria-hidden="true" tabindex="-1"></a>    rewritten_text <span class="op">+=</span> text[current_pos:]</span>
<span id="cb81-23"><a href="#cb81-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-24"><a href="#cb81-24" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> rewritten_text</span>
<span id="cb81-25"><a href="#cb81-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-26"><a href="#cb81-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-27"><a href="#cb81-27" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> rewrite_docs(docs,span_label,new_version):</span>
<span id="cb81-28"><a href="#cb81-28" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Given a dataframe of documents of the form (path,doc,version) and a dataframe of spans to rewrite</span></span>
<span id="cb81-29"><a href="#cb81-29" aria-hidden="true" tabindex="-1"></a><span class="co">    of the form (path,word,from_span,to_tag), rewrites the documents and returns a new dataframe of the form</span></span>
<span id="cb81-30"><a href="#cb81-30" aria-hidden="true" tabindex="-1"></a><span class="co">    (path,doc,new_version)</span></span>
<span id="cb81-31"><a href="#cb81-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-32"><a href="#cb81-32" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb81-33"><a href="#cb81-33" aria-hidden="true" tabindex="-1"></a>    new_tuples <span class="op">=</span>[]</span>
<span id="cb81-34"><a href="#cb81-34" aria-hidden="true" tabindex="-1"></a>    span_label.columns <span class="op">=</span> [<span class="st">'P'</span>,<span class="st">'D'</span>,<span class="st">'W'</span>,<span class="st">'L'</span>]</span>
<span id="cb81-35"><a href="#cb81-35" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> path,doc,_ <span class="kw">in</span> docs.itertuples(index<span class="op">=</span><span class="va">False</span>,name<span class="op">=</span><span class="va">None</span>):</span>
<span id="cb81-36"><a href="#cb81-36" aria-hidden="true" tabindex="-1"></a>        span_label_per_doc <span class="op">=</span> span_label[span_label[<span class="st">'P'</span>] <span class="op">==</span> path][[<span class="st">'W'</span>,<span class="st">'L'</span>]]</span>
<span id="cb81-37"><a href="#cb81-37" aria-hidden="true" tabindex="-1"></a>        new_text <span class="op">=</span> rewrite(doc,span_label_per_doc)</span>
<span id="cb81-38"><a href="#cb81-38" aria-hidden="true" tabindex="-1"></a>        new_tuples.append((path,new_text,new_version))</span>
<span id="cb81-39"><a href="#cb81-39" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> pd.DataFrame(new_tuples,columns<span class="op">=</span>[<span class="st">'P'</span>,<span class="st">'D'</span>,<span class="st">'V'</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="main-pipeline" class="level3">
<h3 class="anchored" data-anchor-id="main-pipeline">Main pipeline</h3>
<div class="sourceCode" id="cb82"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb82-1"><a href="#cb82-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> main(input_dir,data_dir):</span>
<span id="cb82-2"><a href="#cb82-2" aria-hidden="true" tabindex="-1"></a>    sess <span class="op">=</span> Session()</span>
<span id="cb82-3"><a href="#cb82-3" aria-hidden="true" tabindex="-1"></a>    <span class="co"># define callback functions</span></span>
<span id="cb82-4"><a href="#cb82-4" aria-hidden="true" tabindex="-1"></a>    sess.register(<span class="st">'split_sentence'</span>,split_sentence,[(<span class="bu">str</span>,Span)],[Span])</span>
<span id="cb82-5"><a href="#cb82-5" aria-hidden="true" tabindex="-1"></a>    sess.register(<span class="st">'pos'</span>,pos_annotator,[(Span,<span class="bu">str</span>)],[Span,<span class="bu">str</span>])</span>
<span id="cb82-6"><a href="#cb82-6" aria-hidden="true" tabindex="-1"></a>    sess.register(<span class="st">'lemma'</span>,lemmatizer,[(Span,<span class="bu">str</span>)],[Span,<span class="bu">str</span>])</span>
<span id="cb82-7"><a href="#cb82-7" aria-hidden="true" tabindex="-1"></a>    sess.register_agg(<span class="st">'agg_mention'</span>,agg_mention,[<span class="bu">str</span>],[<span class="bu">str</span>])</span>
<span id="cb82-8"><a href="#cb82-8" aria-hidden="true" tabindex="-1"></a>    sess.register_agg(<span class="st">'agg_doc_tags'</span>,AggDocumentTags,[<span class="bu">str</span>],[<span class="bu">str</span>])</span>
<span id="cb82-9"><a href="#cb82-9" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb82-10"><a href="#cb82-10" aria-hidden="true" tabindex="-1"></a>    <span class="co"># bring in code as data</span></span>
<span id="cb82-11"><a href="#cb82-11" aria-hidden="true" tabindex="-1"></a>    sess.import_rel(<span class="st">"ConceptTagRules"</span>,data_dir<span class="op">/</span><span class="st">"concept_tags_rules.csv"</span> , delim<span class="op">=</span><span class="st">","</span>)</span>
<span id="cb82-12"><a href="#cb82-12" aria-hidden="true" tabindex="-1"></a>    sess.import_rel(<span class="st">"TargetTagRules"</span>,data_dir<span class="op">/</span><span class="st">"target_rules.csv"</span>,delim<span class="op">=</span><span class="st">","</span>)</span>
<span id="cb82-13"><a href="#cb82-13" aria-hidden="true" tabindex="-1"></a>    sess.import_rel(<span class="st">"SectionTags"</span>,data_dir<span class="op">/</span><span class="st">"section_tags.csv"</span>,delim<span class="op">=</span><span class="st">","</span>)</span>
<span id="cb82-14"><a href="#cb82-14" aria-hidden="true" tabindex="-1"></a>    sess.import_rel(<span class="st">"PositiveSectionTags"</span>,data_dir<span class="op">/</span><span class="st">"positive_section_tags.csv"</span>,delim<span class="op">=</span><span class="st">","</span>)</span>
<span id="cb82-15"><a href="#cb82-15" aria-hidden="true" tabindex="-1"></a>    sess.import_rel(<span class="st">"SentenceContextRules"</span>,data_dir<span class="op">/</span><span class="st">'sentence_context_rules.csv'</span>,delim<span class="op">=</span><span class="st">"#"</span>)</span>
<span id="cb82-16"><a href="#cb82-16" aria-hidden="true" tabindex="-1"></a>    sess.import_rel(<span class="st">"PostprocessPatternRules"</span>,data_dir<span class="op">/</span><span class="st">'postprocess_pattern_rules.csv'</span>,delim<span class="op">=</span><span class="st">"#"</span>)</span>
<span id="cb82-17"><a href="#cb82-17" aria-hidden="true" tabindex="-1"></a>    sess.import_rel(<span class="st">"PostprocessRulesWithAttributes"</span>,data_dir<span class="op">/</span><span class="st">'postprocess_attributes_rules.csv'</span>,delim<span class="op">=</span><span class="st">"#"</span>)</span>
<span id="cb82-18"><a href="#cb82-18" aria-hidden="true" tabindex="-1"></a>    sess.import_rel(<span class="st">"NextSentencePostprocessPatternRules"</span>,data_dir<span class="op">/</span><span class="st">'postprocess_pattern_next_sentence_rules.csv'</span>,delim<span class="op">=</span><span class="st">','</span>)</span>
<span id="cb82-19"><a href="#cb82-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-20"><a href="#cb82-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-21"><a href="#cb82-21" aria-hidden="true" tabindex="-1"></a>    <span class="co"># we will programatically build a regex that matches all the section patterns</span></span>
<span id="cb82-22"><a href="#cb82-22" aria-hidden="true" tabindex="-1"></a>    section_tags <span class="op">=</span> pd.read_csv(data_dir<span class="op">/</span><span class="st">'section_tags.csv'</span>,names<span class="op">=</span>[<span class="st">'literal'</span>,<span class="st">'tag'</span>])</span>
<span id="cb82-23"><a href="#cb82-23" aria-hidden="true" tabindex="-1"></a>    section_delimeter_pattern <span class="op">=</span> section_tags[<span class="st">'literal'</span>].<span class="bu">str</span>.cat(sep<span class="op">=</span><span class="st">'|'</span>)</span>
<span id="cb82-24"><a href="#cb82-24" aria-hidden="true" tabindex="-1"></a>    sess.import_var(<span class="st">'section_delimeter_pattern'</span>,section_delimeter_pattern)</span>
<span id="cb82-25"><a href="#cb82-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-26"><a href="#cb82-26" aria-hidden="true" tabindex="-1"></a>    <span class="co"># bring in data</span></span>
<span id="cb82-27"><a href="#cb82-27" aria-hidden="true" tabindex="-1"></a>    file_paths <span class="op">=</span> [Path(p) <span class="cf">for</span> p <span class="kw">in</span> glob(<span class="bu">str</span>(input_dir<span class="op">/</span><span class="st">'*.txt'</span>))]</span>
<span id="cb82-28"><a href="#cb82-28" aria-hidden="true" tabindex="-1"></a>    raw_docs <span class="op">=</span> pd.DataFrame([</span>
<span id="cb82-29"><a href="#cb82-29" aria-hidden="true" tabindex="-1"></a>        [p.name,p.read_text(),<span class="st">'raw_text'</span>] <span class="cf">for</span> p <span class="kw">in</span> file_paths</span>
<span id="cb82-30"><a href="#cb82-30" aria-hidden="true" tabindex="-1"></a>    ],columns<span class="op">=</span>[<span class="st">'Path'</span>,<span class="st">'Doc'</span>,<span class="st">'Version'</span>]</span>
<span id="cb82-31"><a href="#cb82-31" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb82-32"><a href="#cb82-32" aria-hidden="true" tabindex="-1"></a>    sess.import_rel(<span class="st">'Docs'</span>,raw_docs)</span>
<span id="cb82-33"><a href="#cb82-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-34"><a href="#cb82-34" aria-hidden="true" tabindex="-1"></a>    <span class="co"># load logic, note that since we did not define the data relations in the logic file,</span></span>
<span id="cb82-35"><a href="#cb82-35" aria-hidden="true" tabindex="-1"></a>    <span class="co"># we need to load the logic after the data has been loaded</span></span>
<span id="cb82-36"><a href="#cb82-36" aria-hidden="true" tabindex="-1"></a>    sess.export(logic_file.read_text())</span>
<span id="cb82-37"><a href="#cb82-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-38"><a href="#cb82-38" aria-hidden="true" tabindex="-1"></a>    <span class="co">## Rewritting the documents</span></span>
<span id="cb82-39"><a href="#cb82-39" aria-hidden="true" tabindex="-1"></a>    lemma_tags <span class="op">=</span> sess.export(<span class="st">'?Lemmas(P,D,W,L)'</span>)</span>
<span id="cb82-40"><a href="#cb82-40" aria-hidden="true" tabindex="-1"></a>    lemma_docs <span class="op">=</span> rewrite_docs(raw_docs,lemma_tags,<span class="st">'lemma'</span>)</span>
<span id="cb82-41"><a href="#cb82-41" aria-hidden="true" tabindex="-1"></a>    sess.import_rel(<span class="st">'Docs'</span>,lemma_docs)</span>
<span id="cb82-42"><a href="#cb82-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-43"><a href="#cb82-43" aria-hidden="true" tabindex="-1"></a>    lemma_concept_matches <span class="op">=</span> sess.export(<span class="st">'?LemmaConceptMatches(Path,Doc,Span,Label)'</span>)</span>
<span id="cb82-44"><a href="#cb82-44" aria-hidden="true" tabindex="-1"></a>    lemma_concepts <span class="op">=</span> rewrite_docs(lemma_docs,lemma_concept_matches,<span class="st">'lemma_concept'</span>)</span>
<span id="cb82-45"><a href="#cb82-45" aria-hidden="true" tabindex="-1"></a>    sess.import_rel(<span class="st">'Docs'</span>,lemma_concepts)</span>
<span id="cb82-46"><a href="#cb82-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-47"><a href="#cb82-47" aria-hidden="true" tabindex="-1"></a>    pos_concept_matches <span class="op">=</span> sess.export(<span class="st">'?PosConceptMatches(P,D,W,L)'</span>)</span>
<span id="cb82-48"><a href="#cb82-48" aria-hidden="true" tabindex="-1"></a>    pos_concept_docs <span class="op">=</span> rewrite_docs(lemma_concepts,pos_concept_matches,<span class="st">'pos_concept'</span>)</span>
<span id="cb82-49"><a href="#cb82-49" aria-hidden="true" tabindex="-1"></a>    sess.import_rel(<span class="st">'Docs'</span>,pos_concept_docs)</span>
<span id="cb82-50"><a href="#cb82-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-51"><a href="#cb82-51" aria-hidden="true" tabindex="-1"></a>    target_matches <span class="op">=</span> sess.export(<span class="st">'?TargetMatches(P,D,W,L)'</span>)</span>
<span id="cb82-52"><a href="#cb82-52" aria-hidden="true" tabindex="-1"></a>    target_rule_docs <span class="op">=</span> rewrite_docs(pos_concept_docs,target_matches,<span class="st">'target_concept'</span>)</span>
<span id="cb82-53"><a href="#cb82-53" aria-hidden="true" tabindex="-1"></a>    sess.import_rel(<span class="st">'Docs'</span>,target_rule_docs)</span>
<span id="cb82-54"><a href="#cb82-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-55"><a href="#cb82-55" aria-hidden="true" tabindex="-1"></a>    <span class="co">## computing the tags based on the target concept documents</span></span>
<span id="cb82-56"><a href="#cb82-56" aria-hidden="true" tabindex="-1"></a>    doc_tags <span class="op">=</span> sess.export(<span class="st">'?DocumentTags(P,T)'</span>)</span>
<span id="cb82-57"><a href="#cb82-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-58"><a href="#cb82-58" aria-hidden="true" tabindex="-1"></a>    <span class="co"># handling files with no mentions</span></span>
<span id="cb82-59"><a href="#cb82-59" aria-hidden="true" tabindex="-1"></a>    paths <span class="op">=</span> pd.DataFrame([p.name <span class="cf">for</span> p <span class="kw">in</span> file_paths],columns<span class="op">=</span>[<span class="st">'P'</span>])</span>
<span id="cb82-60"><a href="#cb82-60" aria-hidden="true" tabindex="-1"></a>    classification <span class="op">=</span> paths.merge(doc_tags,on<span class="op">=</span><span class="st">'P'</span>,how<span class="op">=</span><span class="st">'outer'</span>)</span>
<span id="cb82-61"><a href="#cb82-61" aria-hidden="true" tabindex="-1"></a>    classification[<span class="st">'T'</span>]<span class="op">=</span>classification[<span class="st">'T'</span>].fillna(<span class="st">'UNK'</span>)</span>
<span id="cb82-62"><a href="#cb82-62" aria-hidden="true" tabindex="-1"></a>    classification</span>
<span id="cb82-63"><a href="#cb82-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-64"><a href="#cb82-64" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> classification</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
</section>
<section id="code-comparison" class="level2">
<h2 class="anchored" data-anchor-id="code-comparison">Code comparison</h2>
<section id="lines-of-code" class="level3">
<h3 class="anchored" data-anchor-id="lines-of-code">Lines of code</h3>
<p>Summing the line of code analysis for both implementations we get:</p>
<table class="caption-top table">
<thead>
<tr class="header">
<th>Implementation</th>
<th>Code Type</th>
<th>~#code lines</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Original Implementation</td>
<td>Rules Collections</td>
<td>3903</td>
</tr>
<tr class="even">
<td></td>
<td>Vanilla Python</td>
<td>639</td>
</tr>
<tr class="odd">
<td>Spannerlib Implementation</td>
<td>Data</td>
<td>378</td>
</tr>
<tr class="even">
<td></td>
<td>IE/AGG functions</td>
<td>76</td>
</tr>
<tr class="odd">
<td></td>
<td>Spannerlog</td>
<td>80</td>
</tr>
<tr class="even">
<td></td>
<td>Vanilla python</td>
<td>118</td>
</tr>
</tbody>
</table>
<p>Overall we see that the different type of rules, which were basically data as code and made up the majority of the code base, shrank by a factor of 10 (~3900 to ~380). Moreover the Vanilla python code, over 600 lines long, shrank to less than 300 lines of code, over half of which were either Spannerlog code, or stateless IE/AGG functions.</p>
</section>
<section id="software-engineering-perspective" class="level3">
<h3 class="anchored" data-anchor-id="software-engineering-perspective">Software engineering perspective</h3>
<p>In order to</p>
<ul>
<li>fully appreciate the strengths of the spannerlib framework.</li>
<li>Understand our reasoning behind dividing the code into the four modalities mentioned above in our analysis.</li>
</ul>
<p>In this section we will refer to our covid pipeline refactoring as an example that helps highlight the benefits of the framework in general.</p>
<p>We will remind the reader of a several important concepts:</p>
<p>Decomposition/Factoring:</p>
<ul>
<li>The breaking apart of code into parts that are easier to understand, program and maintain</li>
</ul>
<p>Separation of concerns:</p>
<ul>
<li>A design principle that states that each section in a code should address a separate concern</li>
<li>The goal of this principle is to make code easier to program and maintain by having the programmer:
<ul>
<li>required to reason about less concept when working on a section of code.</li>
<li>required to reason about less sections of code when trying to modify an aspect of the program.</li>
</ul></li>
</ul>
<p>Bug surface area:</p>
<ul>
<li>Is also affected by complexity of the state of the program</li>
<li>Bug surface area is often divided into compile (static) surface area and run time (dynamic) surface area
<ul>
<li>Looking at static and dynamic surface area separately is important since static bugs can be caught easily using a compiler/interpreter, can be proved to exist/not exist and do not require building tests to catch.</li>
</ul></li>
</ul>
<p>Readability:</p>
<ul>
<li>A measure of how easy it is to understand code.</li>
</ul>
<p>Debugability:</p>
<ul>
<li>A measure of how easy it is to find bugs in a code base.
<ul>
<li>This measure does not always coincide with readability, for example, multithreaded code is a clear example where the intent of the code might be easy to understand, but the non deterministic nature of the execution will make debugging hard.</li>
</ul></li>
</ul>
<p>Barriers of entry:</p>
<ul>
<li>The difficulties in programming effectively in an existing codebase that stem from
<ul>
<li>The technical complexity of the codebase</li>
<li>the learning curve of the specific libraries, concepts or technologies used in the project</li>
</ul></li>
</ul>
<p>So why does it matter how many lines of code <strong>per modality</strong> an implementation has? Why do we separate vanilla python code from IE functions? Because different modalities (as well as different programming languages) have different costs with respect to:</p>
<ul>
<li>readability</li>
<li>debugability</li>
<li>and bug surface area</li>
</ul>
<p>per volume of code (which we approximate via lines of code in this discussion).</p>
<p>This fact is well known across programming languages, for example: A typical python function <code>f</code> is more readable than its C counterpart <code>g</code>, but <code>f</code>s bug surface area is greater even though <code>g</code> will often be much longer. This is mainly due to the fact the C is a statically typed language that chooses to reduce run time bug surface area in favor of less readability.</p>
<p>The same is true to the four different modalities we analyze here:</p>
<ul>
<li>Code as Data</li>
<li>Declerative Code (and specificall python)</li>
<li>Stateless python code (IE functions)</li>
<li>General python code</li>
</ul>
<p>As we move up this list, we have more and more freedom, the code</p>
<ul>
<li>becomes less readable</li>
<li>has a larger bug surface area</li>
<li>and is harder to debug</li>
</ul>
<p>A csv line’s is much simpler to verify than a line of spannerlog than a line of stateless python than a line of generic python. Put more techincally, the scaling factors of these code measures get worse as we move up the chain.</p>
<p>For this reason, we do not only care how many lines of code we removed from an implementation, but how many lines of code became more readable debugable etc due to a change in modality. The <code>Rules</code> in the original implementation turned into csv files, which are easier to statically verify, making the reduction of overall complexity more substantial than the reduction in lines of code. The regex patterns, per line of code, are harder to read for a human but are easier for a machine to verify the correctness of.</p>
<p>As for the vanilla python code in the original implementation, the reduction of complexity of the code does not simply come from the &gt;2x reduction in lines of code, but comes from the fact that over half of said code in the new implementation is either declarative or stateless. An example of this are the callback functions added to the post processing section.</p>
<p>So programming in the spannerlib framework, when the task can be partially modelled as an IE task, simplifies programming not only by reducing total volume of code, but by reducing the bug surface area, readability and debugability of conceptually simpler code by moving it to an appropriate modality with better scaling factors for these measures.</p>
<p>But there is another advantages to programming in spannerlib, namely:</p>
<ul>
<li>Better separation of concerns</li>
<li>Better inspectability of state</li>
</ul>
<p>The separation of spannerlib code into Data, Logic and stateless computation matches 4 distinct concerns in programming, each programmed in a modality suited to it namely:</p>
<ul>
<li>State management - using relational databases</li>
<li>Data representation - using relation databases</li>
<li>Algorithmic code - using state less IE functions</li>
<li>Business Logic / Compositional Logic - Decleratve language that can orchestrate IE functions.</li>
</ul>
<p>This separation of concerns make the code better factored but also gives us better tools for common code maintenance tasks:</p>
<ul>
<li>When we want to reason about program state
<ul>
<li>Instead of:
<ul>
<li>inspecting state by going through long runtime inspections using debugger</li>
<li>or changing existing code to add more logging or debugging prints</li>
</ul></li>
<li>We can:
<ul>
<li>query the DB for the state</li>
</ul></li>
<li>Example:
<ul>
<li>our debugging queries that looked at the document’s per version.</li>
<li>Note that even when we used vanilla python code, we still saved the state in spannerlib so we could inspect it</li>
</ul></li>
</ul></li>
<li>When we want to trace intermediate state, for data provenance
<ul>
<li>Instead of:
<ul>
<li>having to add support for this throughout the class hierarchy in our code</li>
<li>or add logs and parse them</li>
</ul></li>
<li>We can:
<ul>
<li>extend the schema of rules to save auxiliary information.</li>
</ul></li>
<li>Example:
<ul>
<li>Adding the <code>Derived</code> from column in the <code>CovidTags</code> relation so we can see where each tuple came from.</li>
</ul></li>
</ul></li>
<li>When writing algorithmic code,
<ul>
<li>Instead of
<ul>
<li>reasoning about state or making decisions about data representation.</li>
</ul></li>
<li>We can:
<ul>
<li>simply find a relational schema that matches</li>
</ul></li>
</ul></li>
<li>When business logic changes,
<ul>
<li>changeing the compositional logic of the pipeline but not the core of the product</li>
<li>which is most of the time</li>
<li>Intead of:
<ul>
<li>having to change both the class structure to support the additional data</li>
<li>and the pipeline code</li>
</ul></li>
<li>We can
<ul>
<li>simply refactor the declarative code, which automatically refactors the data representation with it.</li>
</ul></li>
<li>Example:
<ul>
<li>Adding the PostProcessing Steps</li>
</ul></li>
</ul></li>
</ul>
</section>
<section id="but-how-much-of-this-is-really-new" class="level3">
<h3 class="anchored" data-anchor-id="but-how-much-of-this-is-really-new">But how much of this is really new?</h3>
<p>Spannerlib’s approach while innovative, is combination of several known techniques and approaches in the IE and Programming Languages literature namely:</p>
<ul>
<li><a href="https://dl.acm.org/doi/10.1145/2699442">Document Spanners</a>
<ul>
<li>Which gives us the <a href="https://DeanLight.github.io/spannerlib/spans_and_pandas.html#span"><code>Span</code></a> primitives that simplify a lot of extraction tasks on text.</li>
</ul></li>
<li><a href="https://pages.cs.wisc.edu/~naughton/includes/papers/declarativeInformationExtraction.pdf">Declarative Information Extraction with Embedded Extraction Predicates</a>
<ul>
<li>Which allows us to simplify imperative compositional code via declarative code over imperative stateless functions.</li>
<li>This is the python in Spannerlog embedding.</li>
</ul></li>
<li><a href="https://dl.acm.org/doi/10.5555/345203">Generative Programming</a>
<ul>
<li>Which gives describes techniques for reducing repetitive code by:
<ul>
<li>Using a high level programming language as a composition engine of</li>
<li>A DSL which is suited to the programming domain which</li>
<li>Generates lower level code.</li>
</ul></li>
<li>This gives us the Spannerlog in python embedding.</li>
</ul></li>
</ul>
<p>Spannerlib’s innovation comes from several key nuances that reduces the barrier of entry to the benefit of formal IE, and enables it to be used as a generative programming engine for a very wide array of tasks.</p>
<ul>
<li>We realize, following the IE literature, that declarative query languages, onces paired with imperative callbacks, provide a very generic DSL for function composition, that encompasses a large percentage of pipeline composition code today.
<ul>
<li>Combining the Generative programming paradigm with formal IE systems.</li>
</ul></li>
<li>Unlike existing formal IE systems, like <a href="https://aclanthology.org/N18-3010/">SystemT</a>, we reduce the barrier of entry for new programmers by
<ul>
<li>reducing the barrier of entry for lay programmers to insert IE functions into our system.</li>
<li>reduce the learning curve for our system by formally extending existing, well known, and simple declarative languages (Datalog).</li>
</ul></li>
<li>Improving adoption and developer velocity by
<ul>
<li>Putting an emphasis on concise interplay and a tiny interface for communicating between the host language (python) and our framework</li>
<li>Packaging it as a python library</li>
</ul></li>
</ul>


</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp("https:\/\/DeanLight\.github\.io\/spannerlib");
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




<footer class="footer"><div class="nav-footer"><div class="nav-footer-center"><div class="toc-actions d-sm-block d-md-none"><ul><li><a href="https://github.com/DeanLight/spannerlib/issues/new" class="toc-action"><i class="bi bi-github"></i>Report an issue</a></li></ul></div></div></div></footer></body></html>